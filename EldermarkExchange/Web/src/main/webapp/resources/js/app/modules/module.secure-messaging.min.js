ExchangeApp.modules.SecureMessaging=function(){function e(){t().random=u.rand(),function(e,a){var n=t(),s=e||n.$html,r=a||n.random;s=u.randomize(s,r,!1)}(),function(e,a){var n=t();n.ajaxMap||(n.ajaxMap={});var s=e||n.$html,o=a||n.random,i=u.findAjaxUrls(s,o);$.each(i,function(e,a){n.ajaxMap[r(a,{params:!0})]=a}),u.find(s,o,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),a=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),n=u.getUrl(e,a,t);return g.route(n),!1}),u.find(s,o,'[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href"));return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1})}()}function a(e){var a=t();return m.alert(a.$html,a.random,e)}function t(){return l[r(d,{params:!0})]}function n(){return r(d,{params:!0}).replace(/[/&\?=]/g,"_")}function s(){return $(document.getElementById(n()))}function r(e,a){return u.stringifyUrl(e,a)}function o(e){var a=t();return u.find(a.$html,a.random,e)}function i(){t().widgets.msgList=function(e){var a=t();return m.grid(a.$html,a.random,e)}({tableId:"msgList",searchFormId:"msgFilterForm",colSettings:{select:{bSortable:!1},subject:{bSortable:!1},from:{bSortable:!1},date:{bSortable:!1,width:"70px"}},language:{sProcessing:'<div class="table-loader-msg">Please wait. Retrieving your messages...</div><div class="table-loader-img"><img src="'+ExchangeApp.info.context+'/resources/images/ajax-loader.gif"></div>'},totalDisplayRows:25,selectable:{type:"single",callback:function(e,n,s){o(".msgDetail").addClass("tab-loading").children().remove(),o("#msgDetailModal").modal("toggle"),$.ajax({url:"secure-messaging/"+n.messageId,success:function(s){var r=u.randomize($(s),t().random,!1);u.find(r,t().random,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),a=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),n=u.getUrl(e,a,t);return g.route(n),!1}),function(e){var n=[u.find(e,t().random,".msgDetails").attr("data-message-id")];u.find(e,t().random,"#deleteMsgBtn").on("click",function(){$.ajax({url:"secure-messaging/"+n+"/delete",type:"GET",success:function(e){t().widgets.msgList.fnSettings().oInit.store.removeItem(n),t().widgets.msgList.api().ajax.reload(),o("#msgDetailModal").modal("toggle"),ExchangeApp.managers.EventManager.publish("inbox_count_changed")},error:function(e){u.onAjaxError(e,function(e){o("#msgDetailModal").modal("toggle"),a({action:"add",placeSelector:".msgListBox .boxBody",message:e.responseText,closable:{timer:45e3,btn:!0}})})}})})}(r),o(".msgDetail").removeClass("tab-loading").html(r),n.seen||$.ajax({url:"secure-messaging/"+n.messageId+"/seen",success:function(){e.removeClass("bold"),ExchangeApp.managers.EventManager.publish("inbox_count_changed")}})},error:function(e){u.onAjaxError(e,function(e){$(".msgDetail").removeClass("tab-loading"),a({action:"add",placeSelector:".msgDetails",message:e.responseText,closable:{timer:45e3,btn:!0}})})}})}},callbacks:{drawCallback:function(e){o(this).find("input").styler()},rowCallback:function(e,a,t){a.seen||$(e).addClass("bold")},errorCallback:function(e){u.onAjaxError(e,function(e){a({action:"add",placeSelector:".msgListBox .boxBody",message:e.responseText})})},footerCallback:function(e,a,t,n,s){$(e).show();a.length<20&&$(e).hide()}}})}var l={},d={template:"secure-messaging"},c={reloadNeeded:!1},g=ExchangeApp.routers.ModuleRouter,u=ExchangeApp.utils.module,m=ExchangeApp.utils.wgt,f=ExchangeApp.loaders.FragmentLoader.init("secureMessaging");return{init:function(a){d=a,this.renderHolder(),this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=t();e.widgets={},i(),this.setEvents(),this.render(),this.show(),e.inited=!0,this.loaded()}})},update:function(e){$.ajax({type:"GET",context:this,url:"secure-messaging/employee-secure-email-activated",success:function(a){if(a){d=e;var n=t().widgets.msgList;n&&n.api().ajax.reload(),this.loaded()}else this.init(e)},error:function(e){ExchangeApp.utils.module.onAjaxError(e)}})},loadFragment:function(e){var a=this;f.load({url:d,callbacks:{onFragmentLoaded:function(t){c.reloadNeeded=!1;var n=$(t).find("#content .markup-frg"),s=r(d,{params:!0});l[s]={$html:n,url:u.clone(d)},e.onFragmentLoaded.apply(a)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(a)}}})},loaded:function(){$.each($(".baseHeader .ldr-head-lnk.active"),function(){$(this).removeClass("active"),$(this).removeClass("bottom")});var e=$(".baseHeader .ldr-head-lnk.secureMsgLnk");e.addClass("active"),e.addClass("bottom")},render:function(){var e=t().$html;s().empty(),s().append(e)},renderHolder:function(){if(!document.getElementById(n())){var e=$("<div/>");e.attr("id",n()),e.hide(),$("#content").append(e)}},hide:function(){s().hide();t()&&o("#msgDetailModal").modal("hide"),$("#content").addClass("loading")},show:function(){0==$("#content > div:visible").length&&s().show(),$("#content").removeClass("loading")},getFragment:function(e){return l[r(e,{params:!0})]},isFragmentInited:function(e){var a=this.getFragment(e);return a&&a.inited},setEvents:function(){o(".secureMsgMenuItem a").on("click",function(){var e=$(this).parent("li");e.addClass("active"),e.siblings("li").removeClass("active");var a=$(this).attr("href").replace("#","");o("#messageType").val(a.toUpperCase()),t().widgets.msgList.api().ajax.reload()}),o("#deleteMsgsBtn").on("click",function(){$.each(t().widgets.msgList.fnSettings().oInit.store.items,function(e,n){$.ajax({url:"secure-messaging/"+n+"/delete",type:"GET",success:function(e){t().widgets.msgList.fnSettings().oInit.store.removeItem(n),t().widgets.msgList.api().ajax.reload(),ExchangeApp.managers.EventManager.publish("inbox_count_changed")},error:function(e){u.onAjaxError(e,function(e){a({action:"add",placeSelector:".msgListBox .boxBody",message:e.responseText,closable:{timer:45e3,btn:!0}})})}})})}),o("#activateSesBtn").on("click",function(e){$(e.target).prop("disabled",!0),$.ajax({url:"secure-messaging/activate",type:"POST",beforeSend:function(e){u.csrf(e)},success:function(t){$(e.target).prop("disabled",!1),a({action:"add",type:"alert alert-info",placeSelector:".msgConfigWarningBox .boxBody",message:"Your Secure Messaging account was activated successfully.",closable:{btn:!0}}),window.setTimeout(function(){var e=ExchangeApp.routers.ModuleRouter,a=u.getUrl("secure-messaging",null,null);e.route(a),e.reload()},2e3)},error:function(t){$(e.target).prop("disabled",!1),u.onAjaxError(t,function(e){a({action:"add",placeSelector:".msgConfigWarningBox .boxBody",message:e.responseText,closable:{timer:45e3,btn:!0}})})}})});var e=t().widgets.msgList;e&&e.fnSettings().oInit.store.onCountChanged(o("#deleteMsgsBtn .badge"),function(e,a){var t=$(e.target);a>0?(t.find(".badgeValue").html(a),t.removeClass("hidden")):(t.find(".badgeValue").html(0),t.addClass("hidden"))}),ExchangeApp.managers.EventManager.subscribe("messaging_setup_changed",function(){c.reloadNeeded=!0})},reloadNeeded:function(){return c.reloadNeeded}}}();