ExchangeApp.modules.AdministrationSuggestedMatches=function(){function t(){e().random=h.rand(),function(t,a){var n=e(),i=t||n.$html,r=a||n.random;i=h.randomize(i,r,!1)}(),function(t,a){var i=e();i.ajaxMap||(i.ajaxMap={});var r=t||i.$html,s=a||i.random,o=h.findAjaxUrls(r,s);$.each(o,function(t,e){i.ajaxMap[n(e,{params:!0})]=e}),h.find(r,s,'[data-ajax-load="true"]').on("click",function(){var t=$(this).attr("data-ajax-url-tmpl"),e=$(this).attr("data-ajax-url-vars"),a=$(this).attr("data-ajax-url-params"),n=h.getUrl(t,e,a);return u.route(n),!1}),h.find(r,s,'[data-ajax-anchor="true"]').on("click",function(){var t=$($(this).attr("href"));return t.length&&$("html, body").animate({scrollTop:t.offset().top},200),!1})}()}function e(){return o[n(d,{params:!0})]}function a(){return $('[id^="'+l+'"]')}function n(t,e){return h.stringifyUrl(t,e)}function i(t){var a=e();return h.find(a.$html,a.random,t)}function r(){e().widgets.patientsList=function(t){var a=e();return p.grid(a.$html,a.random,t)}({tableId:"patientsListSuggested",searchFormId:"patientFilterSuggested",totalDisplayRows:10,sort:!1,fetchServerData:function(t,a,r){var s={dataType:"json",type:a,url:t},o=function(t,e){this.callbacks&&this.callbacks[e]&&this.callbacks[e](t)},d=i("#"+this.searchFormId),c=i("#"+this.tableId);s.data=d.serialize();var l=0,f=[];$.when().then(function(){return $.ajax(s)}).then(function(t){return l+=t.totalElements,f=f.concat(t.content),o(t,"successCallback"),t}).fail(function(t){return ExchangeApp.utils.module.onAjaxError(t),o(t,"errorCallback"),{iTotalDisplayRecords:0,content:[]}}).always(function(t){t.iTotalDisplayRecords=l,t.content=f,r(t)}).always(function(){if(f.filter(function(t){return t.probablyMatchedId}).length>0){c.find(":not(.mergedResident)").each(function(){$(this).removeClass("even"),$(this).removeClass("odd"),$(this).addClass("odd")});var t;c.find(".mergedResident").each(function(){var a=$(this).next(),r=$(this).prev();r.is(".mergedResident")||(t=r.clone()),0!==a.length&&a.is(".mergedResident")||($(this).after(t),t.empty(),t.append($('<td colspan="100" align="right"><a class="showMoreDetailsLabel">Show More Details</a></td>')),t.removeClass("even"),t.removeClass("odd"),t.addClass("even"),t.addClass("showMoreDetails"),t.attr("data-maybe-matched-id",$(this).attr("data-maybe-matched-id")),t.on("click",function(){var t=$(this).attr("data-maybe-matched-id");return t&&function(t,a){$.ajax("administration/suggested-matches/step2").success(a,function(a){i("#patientsContent").is(":hidden")||(i("#patientsContent").hide(),i("#patientsComparedContent").hide(),i("#patientsComparedContent").empty(),i("#patientsComparedContent").append(a),i("#patientsComparedContent").show(),h.find(e().$html,"",".backToSuggestedMatches").on("click",function(){i("#patientsComparedContent").hide(),i("#patientsContent").show()}),h.find(e().$html,"","#suggestedMatchesCancel").on("click",function(){i("#patientsComparedContent").hide(),i("#patientsContent").show()}),h.find(e().$html,"","#suggestedMatchesResolve").on("click",function(){var t=e().widgets.patientComparedList.api().rows(".selected").data().toArray().map(function(t){return+t.id}),a=e().widgets.patientComparedList.api().rows(":not(.selected)").data().toArray().map(function(t){return+t.id});return t&&t.length>1&&function(t,a){$.ajax({url:"administration/suggested-matches/confirmation?matching="+t+"&mismatching="+a,type:"GET"}).success(function(n){if(n){var r=h.find(e().$html,"","#suggestedMatchesConfirmationContainer");r.empty(),r.append(n);var s=r.find("#suggestedMatchesConfirmationModal");r.find("#suggestedMatchesConfirmationResolveBtn").on("click",function(){s.modal("hide"),function(t,a){var n=$.extend({},t.reduce(function(t,e){return t[e]=!0,t},{}),a.reduce(function(t,e){return t[e]=!1,t},{}));$.ajax({headers:{Accept:"application/json","Content-Type":"application/json"},url:"administration/suggested-matches/resolve",type:"POST",data:JSON.stringify(n),beforeSend:function(t){h.csrf(t)}}).success(function(){e().widgets.patientsList.api().ajax.reload(),i("#patientsComparedContent").hide(),i("#patientsContent").show()}).fail(function(t){h.onAjaxError(t,function(){bootbox.alert(t.responseText)})})}(t,a)}),s.modal({backdrop:"static"}),s.on("hidden.bs.modal",function(){$(this).remove()})}}).fail(function(t){bootbox.alert(t.responseText)})}(t,a),!1}),function(t){e().widgets.patientComparedList=p.grid(e().$html,"",{tableId:"suggestedMatchesPatientsCompared",sort:!1,paginate:!1,colSettings:{selfUrl:{customRender:function(t,e,a){if(!t)return"";var n=$("<a />",{id:"phr-"+a.id,class:"recordLink",href:"#"+t.template+"?"+(t.parameters||""),text:"View Health Record","data-ajax-load":"true","data-ajax-url-tmpl":t.template,"data-ajax-url-vars":t.variables,"data-ajax-url-params":t.parameters});return $(document).on("click","#phr-"+a.id,function(){var t=$(this).attr("data-ajax-url-tmpl"),e=$(this).attr("data-ajax-url-vars"),a=$(this).attr("data-ajax-url-params"),n=h.getUrl(t,e,a);return u.route(n),!1}),n.prop("outerHTML")}}},fetchServerData:function(a,i,r){var s={dataType:"json",type:i,url:a},o=function(t,e){this.callbacks&&this.callbacks[e]&&this.callbacks[e](t)};s.url+=s.url.indexOf("?")>-1?"&":"?",s.url+="id="+t;var d=$("#"+this.tableId),c=0,l=[];$.when().then(function(){return d.find("tfoot").hide(),d.find("thead").hide(),$.ajax(s)}).then(function(t){return c+=t.totalElements,l=t.content.map(function(t){var a="patient-info/{residentId}",i="hashKey="+t.hashKey+"&databaseId="+t.databaseId,r="residentId="+t.id;t.selfUrl={template:a,parameters:i,variables:r};var s=h.getUrl(a,r,i);return e().ajaxMap[n(s,{params:!0})]=s,t.select=!1,t}),o(t,"successCallback"),t}).fail(function(t){return ExchangeApp.utils.module.onAjaxError(t),o(t,"errorCallback"),{iTotalDisplayRecords:0,content:[]}}).always(function(t){t.iTotalDisplayRecords=c,t.content=l,r(t)}).always(function(){var t=$("#suggestedMatchesPatientsCompared");t.find(".even").each(function(){$(this).removeClass("even"),$(this).addClass("odd")}),t.find("thead").hide(),t.find("tbody tr td.checkbox-col").each(function(){$(this).append(" <label>Matching</label>")}),c&&(t.find("tbody tr").each(function(){$(this).css({"min-width":$(this).width()+20+"px"});var t=100/c;$(this).width(t+"%")}),c>6&&t.parent().width("84%"));h.find(e().$html,"","#suggestedMatchesResolve").prop("disabled",!0),t.find("tbody tr:first td").each(function(e){var a=$(this).text(),n=!1;0===e||$(this).hasClass("checkbox-col")||$(this).parent().siblings().each(function(){var t=$(this).children().eq(e);a!==t.text()&&(n=!0)}),t.find("tbody tr").each(function(){var t=$(this).children().eq(e);n?t.addClass("mismatchingProperty"):t.addClass("matchingProperty")})})})},selectable:{type:"multiple",ignoreRowClicks:!0,callback:function(){h.find(e().$html,"","#suggestedMatchesResolve").prop("disabled",e().widgets.patientComparedList.api().rows(".selected").data().length<2)}},callbacks:{rowCallback:function(t,e,a){},errorCallback:function(t){alert(t.responseText)},footerCallback:function(t,e,a,n,i){$(t).hide()}}})}(t))})}(t),!1}))})}})},callbacks:{rowCallback:function(t,e){var a=$(t);null!==e&&e.probablyMatchedId&&"null"!==e.probablyMatchedId&&(a.addClass("mergedResident"),a.attr("data-id",e.id),a.attr("data-maybe-matched-id",e.probablyMatchedId))},errorCallback:function(t){alert(t.responseText)},footerCallback:function(t,e,a,n,i){$(t).hide()}}}),e().widgets.patientsList.api().ajax.reload()}var s,o={},d={template:"administration/suggested-matches"},c={reloadNeeded:!0},l="suggestedMatchesTabContent",u=ExchangeApp.routers.ModuleRouter,h=ExchangeApp.utils.module,p=ExchangeApp.utils.wgt,f=ExchangeApp.loaders.FragmentLoader.init("administrationSuggestedMatches");return $.fn.serializeObject=function(){var t={},e=this.serializeArray();return $.each(e,function(){void 0!==t[this.name]?(t[this.name].push||(t[this.name]=[t[this.name]]),t[this.name].push(this.value||"")):t[this.name]=this.value||""}),t},{init:function(a,n){d=a,s=n,this.loadFragment({onFragmentLoaded:function(){t()},onResourcesLoaded:function(){var t=e();t.widgets={},r(),this.setPatients(),t.inited=!0,this.render(),this.show()}})},update:function(t){d=t},getFragment:function(t){return o[n(t,{params:!0})]},isFragmentInited:function(t){var e=this.getFragment(t);return e&&e.inited},loadFragment:function(t){var e=this;f.load({url:d,callbacks:{onFragmentLoaded:function(a){c.reloadNeeded=!1;var i=$(a).find("#content").children(),r=n(d,{params:!0});o[r]={$html:i,url:h.clone(d)},t.onFragmentLoaded.apply(e)},onResourcesLoaded:function(){t.onResourcesLoaded.apply(e)}}})},render:function(){var t=e().$html;a().empty(),a().append(t)},hide:function(){a().hide(),$("#content").addClass("loading")},show:function(){$.each($("#administration").find(".nav li"),function(){$(this).removeClass("active")}),$('a[data-target^="#'+l+'"]').parent("li").addClass("active"),a().show(),$("#content").removeClass("loading")},setPatients:function(){return i("#patientSearchSuggested").on("click",function(){return e().widgets.patientsList.api().ajax.reload(),!1}),!1},reloadNeeded:function(){return c.reloadNeeded},getParentModule:function(){return s}}}();