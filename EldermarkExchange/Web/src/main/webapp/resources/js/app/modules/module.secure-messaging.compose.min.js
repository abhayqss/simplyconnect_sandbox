ExchangeApp.modules.SecureMessagingComposeMsg=function(){function e(){t().random=f.rand(),function(e,a){var n=t(),o=e||n.$html,r=a||n.random;o=f.randomize(o,r,!1)}(),function(e,a){var n=t();n.ajaxMap||(n.ajaxMap={});var o=e||n.$html,s=a||n.random,i=f.findAjaxUrls(o,s);$.each(i,function(e,a){n.ajaxMap[r(a,{params:!0})]=a}),f.find(o,s,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),a=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),n=f.getUrl(e,a,t);return g.route(n),!1}),f.find(o,s,'[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href"));return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1})}()}function a(e){var a=t();return h.alert(a.$html,a.random,e)}function t(){return u[r(m,{params:!0})]}function n(){return r(m,{params:!0}).replace(/[/&\?=]/g,"_")}function o(){return $(document.getElementById(n()))}function r(e,a){return f.stringifyUrl(e,a)}function s(e){var a=t();return f.find(a.$html,a.random,e)}function i(e,a,n,o){var r=$('<img class="lnk-img">');r.attr("src",ExchangeApp.info.context+"/resources/images/sheet.png");var i=$('<a class="ldr-ui-label attachedFileLnk pointer-none">');i.append(r),i.append(e);var l=$('<div class="lnkItem col-xs-12 col-sm-10 col-sm-push-2">'),c=$("<a>").addClass("removeLnk"),d=$("<span>").addClass("glyphicon glyphicon-remove");d.attr("aria-hidden",!0),c.append(d),c.on("click",function(e){l.remove(),function(){var e=0;s('[name*="customDocumentIds"]').each(function(a,t){$(t).attr("name","customDocumentIds["+e+++"]")}),e=0,s('[name*="files"]').each(function(a,t){$(t).attr("name","files["+e+"]")})}()});var u=s('[name*="'+n+'"]').length;if(a.attr("id",null),a.attr("name",n+"["+u+"]"),a.addClass("hidden"),a.attr("value",o),l.append(i),l.append(a),l.append(c),!s("#attachments").length){var m=$("<div/>");m.attr("id","attachments"+t().random),m.attr("class","form-group"),s(".msgDetails").append(m)}s("#attachments").append(l)}function l(){var e=m.params.clinical;if(e)for(var t=e.split(","),n=0;n<t.length;n++){var o=t[n];i("ccd"==o?"CCD.XML":"FACESHEET.PDF",$('<input type="text">'),"reportTypes",o)}var r=m.params.documentIds;if(r)for(var s=r.split(","),n=0;n<s.length;n++)!function(e){var t=m.variables.residentId,n=m.params.databaseId,o=m.params.hashKey,r=m.template.replace("{residentId}/compose","")+t+"/documents/custom/"+e+"/meta?hashKey="+o+"&databaseId="+n;$.ajax({type:"GET",contentType:"json",url:r,success:function(a){i(a,$('<input type="text">'),"customDocumentIds",e)},error:function(e){f.onAjaxError(e,function(e){a({action:"add",placeSelector:".msgDetails",message:e,closable:{timer:45e3,btn:!0}})})}})}(s[n])}function c(){t().widgets.accountsDirectory=function(e){var a=t();return h.grid(a.$html,a.random,e)}({tableId:"accountsDirectory",searchFormId:"addressBookFilter",totalDisplayRows:15,colSettings:{name:{bSortable:!1},email:{bSortable:!1},speciality:{bSortable:!1},stateLicences:{bSortable:!1,customRender:function(e){return e?e.join(", "):""}},npiNumbers:{bSortable:!1,customRender:function(e){return e?e.join(", "):""}},registrationType:{bSortable:!1}},selectable:{type:"multiple",boxForStore:{dataColumn:"email"}},scroll:{scrollY:"45vh",scrollCollapse:!0},language:{paginate:{next:"<div/>",previous:"<div/>"},sZeroRecords:"No results found.",sProcessing:"<img class='addressBookAjaxLoader' src='"+ExchangeApp.info.context+"/resources/images/ajax-loader.gif'>",info:""},callbacks:{errorCallback:function(e){f.onAjaxError(e,function(e){a({action:"add",placeSelector:".addressBookFilter",message:e.responseText,closable:{timer:45e3,btn:!0}})})},successCallback:function(e){0==e.totalElements&&e.firstPage&&a({action:"add",type:"alert alert-info",placeSelector:".addressBookFilter",message:"Note: Accounts added recently will not be available until the next business week."}),200==e.totalElements&&e.firstPage&&a({action:"add",type:"alert alert-info",placeSelector:".addressBookFilter",message:"Your search returned too many results, please narrow your search and try again.",closable:{timer:45e3,btn:!0}})},footerCallback:function(e,a,t,n,o){$(e).show();a.length<20&&$(e).hide()}}})}function d(){return function(e){s("#"+e+" input").on("change",function(){$(this).trigger("focusout")})}("chooseFileForm"),s("#chooseFileForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{chosenFile:{required:!0,filesize:1e9}},messages:{chosenFile:{required:getErrorMessage("field.empty"),filesize:getErrorMessage("field.file.greather.1gb")}}}))}var u={},m={template:"secure-messaging/compose"},p={reloadNeeded:!1},g=ExchangeApp.routers.ModuleRouter,f=ExchangeApp.utils.module,h=ExchangeApp.utils.wgt,v=ExchangeApp.loaders.FragmentLoader.init("secureMessagingComposeMsg");return{init:function(n){m=n,this.renderHolder(),this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=t();s("#msgDetailsForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{to:{required:!0,emails:!0}},messages:{to:{required:getErrorMessage("field.emails.empty"),emails:getErrorMessage("field.emails.format")}}})),d(),function(){var e=new ExchangeApp.utils.wgt.Validation({rules:{secureEmail:{required:function(e){return"PUBLIC_DIRECTORY"===s("input[name='addressBookSource']:checked").val()}},addressBookSource:{required:!0}},messages:{secureEmail:{required:getErrorMessage("field.empty")}}});$.extend(e,{ignore:""}),s("#addressBookFilter").validate(e)}(),e.widgets={},function(){var e=t();e.widgets.chosenFile=s("#chosenFile");var a=e.widgets.chosenFile.attr("data-buttonText");e.widgets.chosenFile.filestyle({icon:!1,buttonText:a})}(),s("input[type='radio']").styler(),c(),s("#activateSesBtn").on("click",function(e){$(e.target).prop("disabled",!0),$.ajax({url:"secure-messaging/activate",type:"POST",beforeSend:function(e){f.csrf(e)},success:function(t){$(e.target).prop("disabled",!1),a({action:"add",type:"alert alert-info",placeSelector:".msgConfigWarningBox .boxBody",message:"Your Secure Messaging account was activated successfully.",closable:{btn:!0}}),window.setTimeout(function(){var e=ExchangeApp.routers.ModuleRouter,a=f.getUrl("secure-messaging",null,null);e.route(a),e.reload()},2e3)},error:function(t){$(e.target).prop("disabled",!1),f.onAjaxError(t,function(e){a({action:"add",placeSelector:".msgConfigWarningBox .boxBody",message:e.responseText,closable:{timer:45e3,btn:!0}})})}})}),m.params&&l(),this.setEvents(),this.render(),this.show(),e.inited=!0}})},update:function(e){m=e;var a=s("#msgDetailsForm")[0];a&&a.reset(),s(".lnkItem").remove(),s(".alert").remove(),m.params&&l()},loadFragment:function(e){var a=this;v.load({url:m,callbacks:{onFragmentLoaded:function(t){p.reloadNeeded=!1;var n=$(t).find("#content .markup-frg"),o=r(m,{params:!0});u[o]={$html:n,url:f.clone(m)},e.onFragmentLoaded.apply(a)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(a)}}})},render:function(){var e=t().$html;o().empty(),o().append(e)},renderHolder:function(){if(!document.getElementById(n())){var e=$("<div/>");e.attr("id",n()),e.hide(),$("#content").append(e)}},hide:function(){o().hide(),$("#content").addClass("loading");if(t()){var e=s(".modal");e&&e.modal("hide")}},show:function(){o().show(),$("#content").removeClass("loading")},getFragment:function(e){return u[r(e,{params:!0})]},isFragmentInited:function(e){var a=this.getFragment(e);return a&&a.inited},setEvents:function(){s("#msgDetailsForm").submit(function(){return!!$(this).valid()&&($(".composingMsg").hide(),$("#content").addClass("loading"),s("#sendMsgBtn").prop("disabled",!0),$.ajax({url:$(this).attr("action"),type:"POST",dataType:"json",data:new FormData(this),enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e)},success:function(e){s("#sendMsgBtn").removeProp("disabled"),$("#content").removeClass("loading"),$(".composingMsg").show();var t=!1;$.each(e,function(e,n){t=!0,a({action:"add",placeSelector:".msgDetails",message:n,closable:{timer:45e3,btn:!0}})}),t||(ExchangeApp.managers.EventManager.publish("inbox_count_changed"),a({action:"add",type:"alert alert-info",placeSelector:".msgDetails",message:"Your message has been sent successfully.",closable:{btn:!0}}),window.setTimeout(function(){var e=s("#oneStepBackword"),a=e.attr("data-ajax-url-tmpl"),t=e.attr("data-ajax-url-vars"),n=e.attr("data-ajax-url-params");if(a){var o=f.getUrl(a,t,n);g.route(o)}else history.back()},2e3))},error:function(e){$("#content").removeClass("loading"),$(".composingMsg").show(),f.onAjaxError(e,function(e){s("#sendMsgBtn").removeProp("disabled"),a({action:"add",placeSelector:".msgDetails",message:e.responseText,closable:{timer:45e3,btn:!0}})})}}),!1)}),s("#chooseFileBtn").on("click",function(e){if(!s("#chooseFileForm").valid())return!1;i(t().widgets.chosenFile.val().match(/[^\\\/]+\.\w+/)[0],t().widgets.chosenFile,"files",null),s("#uploadFileModal").modal("hide")}),s("#uploadFileModal").on("hide.bs.modal",function(){var e=t();s(".chosenFileBox").empty();var a=e.widgets.chosenFile,n=$('<input type="file" name="chosenFile" class="filestyle form-control">');n.attr("id","chosenFile"+e.random);var o=a.attr("data-buttonText");n.attr("data-buttonText",o),s(".chosenFileBox").append(n),e.widgets.chosenFile=n,e.widgets.chosenFile.filestyle({icon:!1,buttonText:o})}),s("#cancelBtn").on("click",function(){var e=s(".crumb").eq(-2),a=e.attr("data-ajax-url-tmpl"),t=e.attr("data-ajax-url-vars"),n=e.attr("data-ajax-url-params");if(a){var o=f.getUrl(a,t,n);g.route(o)}else history.back()}),s("#addressBookSearchBtn").on("click",function(){return s("#addressBookFilter").valid()?t().widgets.accountsDirectory.api().ajax.reload():t().widgets.accountsDirectory.api().clear().draw(),!1}),s("input[name='addressBookSource']:radio").change(function(){s("#addressBookFilter").valid()?t().widgets.accountsDirectory.api().ajax.reload():t().widgets.accountsDirectory.api().clear().draw()}),s("#addressBookModal").on("show.bs.modal",function(){s("#addressBookFilter").valid()?t().widgets.accountsDirectory.api().ajax.reload():t().widgets.accountsDirectory.api().clear().draw()}),s("#addressBookSubmit").on("click",function(){var e=s("#to").val(),a=s(".chosed-row>span").map(function(){return $(this).text()}).get().filter(function(a){return-1==e.indexOf(a)});e.length&&a.length&&(e+="; ");var t=e+a.join("; ");s("#to").val(t),s("#msgDetailsForm").valid(),s("#addressBookModal").modal("hide")}),s("#addressBookCancel").on("click",function(){s("#addressBookModal").modal("hide")}),s("#addressBookModal").on("hide.bs.modal",function(){t().widgets.accountsDirectory.fnSettings().oInit.store.removeAllItems();var e=s("#secureEmail");e.val(e.attr("value")),s(".chose-rows-pnl").empty()}),ExchangeApp.managers.EventManager.subscribe("messaging_setup_changed",function(){p.reloadNeeded=!0})},reloadNeeded:function(){return p.reloadNeeded}}}();