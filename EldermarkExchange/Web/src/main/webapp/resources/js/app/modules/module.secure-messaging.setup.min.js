ExchangeApp.modules.SecureMessagingSetup=function(){function e(){a().random=g.rand(),function(e,t){var n=a(),r=e||n.$html,o=t||n.random;r=g.randomize(r,o,!1)}(),function(e,t){var n=a();n.ajaxMap||(n.ajaxMap={});var r=e||n.$html,o=t||n.random,i=g.findAjaxUrls(r,o);$.each(i,function(e,t){n.ajaxMap[s(t,{params:!0})]=t}),g.find(r,o,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),t=$(this).attr("data-ajax-url-vars"),n=$(this).attr("data-ajax-url-params"),a=g.getUrl(e,t,n);return m.route(a),!1}),g.find(r,o,'[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href"));return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1})}()}function t(e,t){var n={action:"add",placeSelector:".msgSetupBody",message:e,closable:{timer:45e3,btn:!0}};t&&(n.type=t);var r=a();return v.alert(r.$html,r.random,n)}function n(){i(".alert").remove()}function a(){return l[s(p,{params:!0})]}function r(){return s(p,{params:!0}).replace(/[/&\?=]/g,"_")}function o(){return $(document.getElementById(r()))}function s(e,t){return g.stringifyUrl(e,t)}function i(e){var t=a();return g.find(t.$html,t.random,e)}function d(){var e=a();e.widgets.setupMsgWizard=function(e){var t=a();return v.wizard(t.$html,t.random,e)}({wizardId:"msgSetupWzd",tabClass:"nav nav-tabs",onNext:function(e,n,r){switch(r){case 1:return function(e,n){if(a().state.step.keyStore)return!0;var r=i("#keyStoreForm");return!!r.valid()&&($.ajax({url:r.attr("action"),data:new FormData(r[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){g.csrf(e)},success:function(t){a().state.step.keyStore=!0;var n=i("#keyStore").val().split(/\\|\//).pop();i("#certName").text(n),u(1),e.addClass("wz-done"),i("#uploadBtn").trigger("click")},error:function(e){g.onAjaxError(e,function(){a().state.step.keyStore=!1,t(e.responseText)})}}),!1)}(e);case 2:return function(e,n){if(a().state.step.pin)return!0;var r=i("#pinForm");return!!r.valid()&&($.ajax({url:r.attr("action"),data:new FormData(r[0]),type:"POST",processData:!1,contentType:!1,beforeSend:function(e){g.csrf(e)},success:function(t){a().state.step.pin=!0,i("#pinValue").text(i("#pin").val()),u(2),e.addClass("wz-done"),i("#uploadBtn").trigger("click")},error:function(e){g.onAjaxError(e,function(){a().state.step.pin=!1,t(e.responseText)})}}),!1)}(e);default:return!1}},onFirst:function(e,t,n){a().state.step.pin=!1,a().state.step.keyStore=!1,i(".nav>li:eq(2)").removeClass("wz-done"),i(".testConfigDetails").removeClass("hidden"),i(".testConfigResult").addClass("hidden"),u(n)},onTabClick:function(){return!1},nextSelector:i(".wzBtns .next"),firstSelector:i(".wzBtns .first")}),c(e.widgets.setupMsgWizard.dataset.activeStep)}function u(e){n(),i(".btn-lt").addClass("hidden"),i([".keyStoreStep",".pinStep",".testStep",".resultStep"][e]).removeClass("hidden")}function c(e){i(".nav>li").removeClass("active"),3!==e&&i(".nav>li:eq("+e+")").addClass("active"),i(".nav>li:lt("+e+")").addClass("wz-done"),i(".tab-pane").removeClass("active"),i(".tab-pane:eq("+e+")").addClass("active"),3==e&&(i(".tab-pane:eq(2)").addClass("active"),i(".testConfigDetails").addClass("hidden"),i(".testConfigResult").removeClass("hidden")),u(e)}var l={},p={template:"secure-messaging/setup"},f={reloadNeeded:!1},m=ExchangeApp.routers.ModuleRouter,g=ExchangeApp.utils.module,v=ExchangeApp.utils.wgt,h=ExchangeApp.loaders.FragmentLoader.init("secureMessagingSetup");return{init:function(r){p=r,this.renderHolder(),this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=a();i("#keyStoreForm").validate({rules:{keystore:{required:!0}},messages:{keystore:{required:getErrorMessage("field.empty")}},showErrors:function(e,a){for(var r in e){var o=e[r];n(),t(o)}this.defaultShowErrors(),i('label[class="error"]').remove()},onfocusout:function(e,t){n()},onkeyup:function(e,t){n()}}),i("#pinForm").validate({rules:{pin:{required:!0}},messages:{pin:{required:getErrorMessage("field.empty")}},showErrors:function(e,a){for(var r in e){var o=e[r];n(),t(o)}this.defaultShowErrors(),i('label[class="error"]').remove()},onfocusout:function(e,t){n()},onkeyup:function(e,t){n()}}),e.widgets={},e.state={step:{keyStore:!1,pin:!1}},d(),function(){var e=i("input[type='file']");a().widgets.chooseKeyStore=e;var t=e.attr("data-buttonText");i("input[type='file']").filestyle({icon:!1,buttonText:t})}(),this.setEvents(),this.render(),this.show(),e.inited=!0}})},update:function(e){p=e},loadFragment:function(e){var t=this;h.load({url:p,callbacks:{onFragmentLoaded:function(n){f.reloadNeeded=!1;var a=$(n).find("#content .markup-frg"),r=s(p,{params:!0});l[r]={$html:a,url:g.clone(p)},e.onFragmentLoaded.apply(t)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(t)}}})},render:function(){var e=a().$html;o().empty(),o().append(e)},renderHolder:function(){if(!document.getElementById(r())){var e=$("<div/>");e.attr("id",r()),e.hide(),$("#content").append(e)}},hide:function(){o().hide(),$("#content").addClass("loading")},show:function(){o().show(),$("#content").removeClass("loading")},getFragment:function(e){return l[s(e,{params:!0})]},isFragmentInited:function(e){var t=this.getFragment(e);return t&&t.inited},setEvents:function(){i("#testBtn").on("click",function(){$.ajax({type:"GET",url:"secure-messaging/setup/verify",success:function(e){c(3),ExchangeApp.managers.EventManager.publish("messaging_setup_changed")},error:function(e){g.onAjaxError(e,function(){t(e.responseText),i(".wz-done").removeClass("wz-done"),ExchangeApp.managers.EventManager.publish("messaging_setup_changed")})}})})},reloadNeeded:function(){return f.reloadNeeded}}}();