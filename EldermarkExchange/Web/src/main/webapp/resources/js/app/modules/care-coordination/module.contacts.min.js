ExchangeApp.modules.CareCoordinationContacts=function(){function e(){n().random=f.rand(),function(e,t){var a=n(),r=e||a.$html,i=t||a.random;r=f.randomize(r,i,!1)}()}function n(){return s[a(l,{params:!0})]}function t(){return $('[id^="'+p+'"]')}function a(e,n){return f.stringifyUrl(e,n)}function r(e){var t=n();return f.find(t.$html,t.random,e)}function i(e,t,a,r){r.hasClass("pending")||(r.addClass("pending"),$.ajax("care-coordination/contacts/contact/"+t).success(function(i){function o(){["Parent/Guardian","Person Receiving Services"].includes(h.find("option:checked").text())?($("#qaIncidentReportsId").prop("checked",!1),$("#qaIncidentReportsId").attr("disabled",!0)):$("#qaIncidentReportsId").removeAttr("disabled")}e.empty(),e.append(i);var c,d=e.find("#createContactModal");if(a)e.find("input,select").prop("disabled",!0),e.find(".btn-group").hide(),e.find("#faxHelp").hide(),c="View Contact";else{!function(e){e.find("#contactForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{email:{required:!0,maxlength:255,emails:!0},firstName:{required:!0,minlength:2,maxlength:128},lastName:{required:!0,minlength:2,maxlength:128},"role.id":{required:!0},"address.street":{required:!0,minlength:2,maxlength:255},"address.city":{required:!0,minlength:2,maxlength:128},"address.state.id":{required:!0},"address.zip":{required:!0,lengthEqual:5},phone:{required:!0,phone:!0},fax:{phone:!0}},messages:{firstName:{required:getErrorMessage("field.empty")},lastName:{required:getErrorMessage("field.empty")},phone:{phone:getErrorMessage("field.phone.format")},fax:{phone:getErrorMessage("field.phone.format")},state:{stateUS:getErrorMessage("field.state")}}}))}(e);var s="true"==e.find("#expired").attr("data-value"),l=e.find("#saveContact");s?(c="Expired Contact",l.html("RE-INVITE USER")):(c=(t?"Edit":"Create")+" Contact",l.html(t?"SUBMIT":"SEND INVITE")),l.on("click",function(){var a=e.find("#contactForm");if(!a.valid())return!1;if(s)$.ajax({url:"care-coordination/contacts/contact/"+t+"/sendNewInvitation",type:"POST",beforeSend:function(e){f.csrf(e)}}).success(function(e){n().widgets.contactsList.api().ajax.reload(),d.modal("hide"),$(".modal-backdrop").remove(),bootbox.alert("A new invitation has been sent")}).error(function(e){f.onAjaxError(response,function(){$("#formError").text(response.responseText)})});else{if(!a.find("#enabledExchangeId").is(":checked")&&a.find("#contact\\.secureMessaging").val()){if(!a.find("#phrWarning").is(":visible"))return a.find("#phrWarning").show(),!1}$.ajax({url:"care-coordination/contacts/contact/"+t,type:"POST",data:a.serialize(),beforeSend:function(e){f.csrf(e)}}).success(function(e){n().widgets.contactsList.api().ajax.reload(),d.modal("hide"),$(".modal-backdrop").remove()}).fail(function(e){f.onAjaxError(e,function(){$("#formError").text(e.responseText)})})}return!1});var u=$("#contact\\.organization"),p=$("#unafilliatedDatabaseId").val();u.change(function(){$.ajax({url:"care-coordination/communities/byorg/"+u.val(),type:"GET"}).success(function(e){var n=$("#contact\\.community");n.empty(),$.each(e.content,function(e,t){n.append('<option value="'+t.id+'">'+t.name+"</option>")}),p==u.val()?($("#enabledExchangeId").prop("checked",!1),$("#enabledExchangeId").prop("disabled",!0)):$("#enabledExchangeId").prop("disabled",!1)}).fail(function(e){$("#formError").text(e.responseText)})});var h=$("#contact\\.role\\.id");o(),h.change(function(){o()}),$("#faxHelp").popover(),d.find("#secureMessagingHelp1").popover(),d.find("#secureMessagingHelp2").popover()}e.find("#contactHeader").html(c),d.find("#secureMessagingError1").popover({html:!0,content:function(){return $("#secureMessagingError1-content").html()}}),d.find("#secureMessagingError2").popover(),e.find("#createContactModal").modal({backdrop:"static"}),e.find("#createContactModal").on("hidden.bs.modal",function(){$(this).remove()}),r.removeClass("pending")}).fail(function(){r.removeClass("pending"),alert("Internal server error. Please contact administrator.")}))}function o(){var e=r("#createContactContainer");n().widgets.contactsList=function(e){var t=n();return h.grid(t.$html,t.random,e)}({tableId:"contactsList",searchFormId:"contactsFilter",totalDisplayRows:25,colSettings:{actions:{width:"50px",className:"dt-head-center"},email:{orderable:!1},phone:{width:"100px",orderable:!1}},order:[[0,"asc"],[2,"asc"]],callbacks:{rowCallback:function(t,a,r){var o=$(t);if(a){var c=a.id,d=o.children("td:eq(5)");if(d.empty(),a.editable||a.viewOnly){var s=n().$html.find(".rowActions.hidden").clone(),l="rowActions-"+r;s.attr("id",l),s.removeClass("hidden"),s.find(".editContact").on("click",function(){i(e,c,a.viewOnly,$(this))}),a.editable?s.find(".glyphicon").addClass("glyphicon-pencil"):a.viewOnly&&s.find(".glyphicon").addClass("glyphicon-eye-open"),d.append(s)}else d.css("height","32px")}},errorCallback:function(e){403==e.status?window.location.href="login?invalid-session=true":alert(e.responseText)},footerCallback:function(e,n,t,a,r){$(e).hide()}}}),n().widgets.contactsList.api().ajax.reload(),d=ExchangeApp.modules.Header.getCurrentOrganizationFilter()}var c,d,s={},l={template:"care-coordination/contacts"},u={reloadNeeded:!0},p="contactsTabContent",f=(ExchangeApp.routers.ModuleRouter,ExchangeApp.utils.module),h=ExchangeApp.utils.wgt,g=ExchangeApp.loaders.FragmentLoader.init("careCoordinationContacts");return $.fn.serializeObject=function(){var e={},n=this.serializeArray();return $.each(n,function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},{init:function(t,a){l=t,c=a,this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=n();e.widgets={},o(),this.setEvents(),e.inited=!0,this.render(),this.show()}})},update:function(e){d!=ExchangeApp.modules.Header.getCurrentOrganizationFilter()&&ExchangeApp.routers.ModuleRouter.reload(),l=e},getFragment:function(e){return s[a(e,{params:!0})]},isFragmentInited:function(e){var n=this.getFragment(e);return n&&n.inited},loadFragment:function(e){var n=this;g.load({url:l,callbacks:{onFragmentLoaded:function(t){u.reloadNeeded=!1;var r=$(t).find("#content").children(),i=a(l,{params:!0});s[i]={$html:r,url:f.clone(l)},e.onFragmentLoaded.apply(n)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(n)}}})},render:function(){var e=n().$html;t().empty(),t().append(e)},hide:function(){t().hide(),$("#content").addClass("loading")},show:function(){0==$("#content").find(".tab-pane:visible").length&&($.each($("#care-coordination").find(".nav li"),function(){$(this).removeClass("active")}),$('a[data-target^="#'+p+'"]').parent("li").addClass("active"),t().show()),$("#content").removeClass("loading")},setEvents:function(){return r("#contactSearch").on("click",function(){return n().widgets.contactsList.api().order([[0,"asc"],[2,"asc"]]),n().widgets.contactsList.api().ajax.reload(),!1}),r("#contactSearchClear").on("click",function(){return r("#contactsFilter").clearForm(),!1}),r("#roleId, #status").select2({width:"100%",minimumResultsForSearch:1/0}),r("#createContact").on("click",function(){return i(r("#createContactContainer"),0,!1,$(this)),!1}),!1},reloadNeeded:function(){return u.reloadNeeded},getParentModule:function(){return c}}}();