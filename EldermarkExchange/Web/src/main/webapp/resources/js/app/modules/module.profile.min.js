ExchangeApp.modules.Profile=function(){function e(){n().random=v.rand(),function(e,t){var o=n(),r=e||o.$html,a=t||o.random;r=v.randomize(r,a,!1)}(),function(e,t){var o=n();o.ajaxMap||(o.ajaxMap={});var r=e||o.$html,i=t||o.random,c=v.findAjaxUrls(r,i);$.each(c,function(e,n){o.ajaxMap[a(n,{params:!0})]=n}),v.find(r,i,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),n=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),o=($(this).attr("data-target"),v.getUrl(e,n,t));return h.route(o),!1}),v.find(r,i,'[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href"));return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1})}()}function n(){return m[a(f,{params:!0})]}function t(e){var t=n();return v.find(t.$html,t.random,e)}function o(){return $(document.getElementById(r()))}function r(){return a(f,{params:!0}).replace(/[/&\?=]/g,"_")}function a(e,n){return v.stringifyUrl(e,n)}function i(e,o){var r=e.find("#linkAccountsForm");return!!r.valid()&&($.ajax({url:"profile/add",type:"POST",data:r.serialize(),beforeSend:function(e){v.csrf(e)}}).success(function(e){"Success"==e?(n().widgets.linkedEmployeeList.api().ajax.reload(),u(t("#linkedEmployeesDetails")),$("[id^=createdLinkedAccount]").show(),o.modal("hide"),$(".modal-backdrop").remove()):$("#formError").text(e)}).fail(function(e){v.onAjaxError(e,function(){$("#formError").text(e.responseText)})}),!1)}function c(e,o){var r=e.find("#linkAccountsForm");return!!r.valid()&&($.ajax({url:"profile/validatePasswordComplexity",type:"POST",data:r.serialize()}).success(function(e){1==e?$.ajax({url:"profile/createandlink",type:"POST",data:r.serialize(),beforeSend:function(e){v.csrf(e)}}).success(function(e){"Success"==e?(n().widgets.linkedEmployeeList.api().ajax.reload(),u(t("#linkedEmployeesDetails")),$("[id^=createdLinkedAccount]").show(),o.modal("hide"),$(".modal-backdrop").remove()):$("#formError").text(e)}).fail(function(e){v.onAjaxError(e,function(){$("#formError").text(e.responseText)})}):$("#formError").text("Password does not meet the password requirements")}).fail(function(e){$("#formError").text("Internal server error")}),!1)}function d(e){return $.ajax("profile/link").success(function(n){e.empty(),e.append(n),$("[id^=createdLinkedAccount]").hide(),$("[id^=unLinkedAccount]").hide();var t=e.find("#linkAccountsModal"),o=e.find("#linkAccounts"),r=e.find("#cancelLinkAccounts");$("#linkAccountsForm input").on("keydown",function(n){if(13===n.keyCode)return i(e,t),n.preventDefault(),!1}),o.on("click",function(){i(e,t)}),r.on("click",function(){return!1});var a=e.find("#employeeListContainer");a.empty();var c=$("[id^=linkedEmployeeListMain]").clone();c.attr("id","linkedEmployeeList-modal"),c.removeClass("hidden"),a.append(c),$("#linkAccountsForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{company:{required:!0},password:{required:!0},username:{required:!0}},messages:{company:{required:getErrorMessage("field.empty")},username:{required:getErrorMessage("field.empty")},password:{required:getErrorMessage("field.empty")}}})),t.modal("show"),t.on("hidden.bs.modal",function(){$(this).remove()})}).fail(function(e,n){console.log(e,n),alert("Internal server error. Please contact administrator.")}),!1}function s(e){return $.ajax("profile/linkcreated").success(function(n){e.empty(),e.append(n),$("[id^=createdLinkedAccount]").hide(),$("[id^=unLinkedAccount]").hide();var t=e.find("#linkAccountsModal"),o=e.find("#linkCreateAccounts"),r=e.find("#cancelLinkAccounts");$("#linkAccountsForm input").on("keydown",function(n){if(13===n.keyCode)return c(e,t),n.preventDefault(),!1});var a=$("#passwordHelpTemplate").clone();a.removeClass("hidden"),$("#passwordHelp").popover({html:!0,content:a[0],trigger:"hover",placement:function(){return"bottom"}}),o.on("click",function(){c(e,t)}),r.on("click",function(){return!1});var i=e.find("#employeeListContainer");i.empty();var d=$("[id^=linkedEmployeeListMain]").clone();d.attr("id","linkedEmployeeList-modal"),d.removeClass("hidden"),i.append(d),$("#linkAccountsForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{password:{required:!0},confirmPassword:{required:!0,equalTo:"#password"}},messages:{password:{required:getErrorMessage("field.empty")},confirmPassword:{required:getErrorMessage("field.empty")}}})),t.modal("show"),t.on("hidden.bs.modal",function(){$(this).remove()})}).fail(function(e,n){console.log(e,n),alert("Internal server error. Please contact administrator.")}),!1}function l(){n().widgets.linkedEmployeeList=function(e){var t=n();return y.grid(t.$html,t.random,e)}({tableId:"linkedEmployeeList",totalDisplayRows:100,paginate:!1,sort:!1,callbacks:{footerCallback:function(e,n,t,o,r){$(e).hide()}}}),n().widgets.linkedEmployeeList.api().ajax.reload()}function u(e){$.ajax({type:"GET",async:!1,url:"profile/linkeddetails",success:function(n){e.empty(),e.append(n),t(".guardians").masonry({itemSelector:".item",percentPosition:!0,columnWidth:".item"}),t(".ccdHeaderItem .commonInfo").masonry({itemSelector:".item",percentPosition:!0,columnWidth:".item"})},fail:function(e,n){console.log(e,n),alert("Internal server error. Please contact administrator.")}})}function p(e,o){var r=t("#editContactContainer");$(o).hasClass("pending")||($(o).addClass("pending"),$.ajax("care-coordination/contacts/contact/"+e).success(function(a){r.empty(),r.append(a);var i,c=r.find("#createContactModal");!function(e){e.find("#contactForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{email:{required:!0,maxlength:255,email:!0},firstName:{required:!0,minlength:2,maxlength:128},lastName:{required:!0,minlength:2,maxlength:128},"role.id":{required:!0},"address.street":{required:!0,minlength:2,maxlength:255},"address.city":{required:!0,minlength:2,maxlength:128},"address.state.id":{required:!0},"address.zip":{required:!0,positiveInteger:!0,lengthEqual:5},phone:{required:!0,phone:!0},fax:{phone:!0}},messages:{firstName:{required:getErrorMessage("field.empty")},lastName:{required:getErrorMessage("field.empty")},phone:{phone:getErrorMessage("field.phone.format")},fax:{phone:getErrorMessage("field.phone.format")},state:{stateUS:getErrorMessage("field.state")}}}))}(r),i=(e?"Edit":"Create")+" Contact";var d=r.find("#saveContact");d.html(e?"SUBMIT":"SEND INVITE"),d.on("click",function(){var o=r.find("#contactForm");return!!o.valid()&&($.ajax({url:"care-coordination/contacts/contact/"+e,type:"POST",data:o.serialize(),beforeSend:function(e){v.csrf(e)}}).success(function(o){t("#currentUserId").val()==e?(t("#profileCommonInfo"),$.ajax({type:"GET",async:!1,url:"profile/common-profile-info",success:function(e){t("#contactEmail").empty(),t("#contactEmail").append(e.email),t("#contactSecureEmail").empty(),t("#contactSecureEmail").append(e.secureMessaging),t("#contactPhone").empty(),t("#contactPhone").append(e.phone),t("#contactFax").empty(),t("#contactFax").append(e.fax),t("#contactAddress").empty(),t("#contactAddress").append(e.address.displayAddress),t("#contactRole").empty(),t("#contactRole").append(e.role.label),t("#contactCompanyId").empty(),t("#contactCompanyId").append(e.companyId),t("#contactOrganization").empty(),t("#contactOrganization").append(e.organization.label),t("#contactCommunity").empty(),t("#contactCommunity").append(e.communityName)},error:function(e){v.onAjaxError(e,function(){alert(e.responseText)})},fail:function(e,n){console.log(e,n),alert("Internal server error. Please contact administrator.")}})):u(t("#linkedEmployeesDetails")),n().widgets.linkedEmployeeList.api().ajax.reload(),c.modal("hide"),$(".modal-backdrop").remove()}).fail(function(e){v.onAjaxError(e,function(){$("#formError").text(e.responseText)})}),!1)});var s=$("#contact\\.organization");s.change(function(){$.ajax({url:"care-coordination/communities/byorg/"+s.val(),type:"GET"}).success(function(e){var n=$("#contact\\.community");n.empty(),$.each(e.content,function(e,t){n.append('<option value="'+t.id+'">'+t.name+"</option>")})}).fail(function(e){$("#formError").text(e.responseText)})}),$("#faxHelp").popover(),c.find("#secureMessagingHelp1").popover(),c.find("#secureMessagingHelp2").popover(),r.find("#contactHeader").html(i),c.find("#secureMessagingError1").popover({html:!0,content:function(){return $("#secureMessagingError1-content").html()}}),c.find("#secureMessagingError2").popover(),r.find("#createContactModal").modal({backdrop:"static"}),r.find("#createContactModal").on("hidden.bs.modal",function(){$(this).remove()}),$(o).removeClass("pending")}).fail(function(){$(o).removeClass("pending"),alert("Internal server error. Please contact administrator.")}))}var m={},f={template:"profile/show"},g={reloadNeeded:!1},h=ExchangeApp.routers.ModuleRouter,v=ExchangeApp.utils.module,y=ExchangeApp.utils.wgt,k=ExchangeApp.loaders.FragmentLoader.init("profile");return{init:function(o){f=o,this.renderHolder(),this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=n();e.widgets={},l(),this.setEvents(),e.inited=!0,this.render(),this.show(),u(t("#linkedEmployeesDetails")),this.loaded()}})},loaded:function(){$(".baseHeader a.ldr-head-lnk.active").each(function(){$(this).removeClass("active"),$(this).removeClass("bottom"),$("[id^=createdLinkedAccount]").hide(),$("[id^=unLinkedAccount]").hide()});"true"==$("[id^=newUserToLink]").val()&&s(t("#linkAccountsContainer"))},update:function(e){e&&(f=e),this.loaded()},getFragment:function(e){return m[a(e,{params:!0})]},isFragmentInited:function(e){var n=this.getFragment(e);return n&&n.inited},loadFragment:function(e){var n=this;k.load({url:f,callbacks:{onFragmentLoaded:function(t){g.reloadNeeded=!1;var o=$(t).find("#content .markup-frg"),r=a(f,{params:!0});m[r]={$html:o,url:v.clone(f)},e.onFragmentLoaded.apply(n)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(n)}}})},render:function(){var e=n().$html;o().empty(),o().append(e)},renderHolder:function(){if(!document.getElementById(r())){var e=$("<div/>");e.attr("id",r()),e.hide(),$("#content").append(e)}},hide:function(){o().hide(),$("#content").addClass("loading")},show:function(){o().show(),$("#content").removeClass("loading")},setEvents:function(){var e=t("#currentUserId").val();return t("#linkAccounts").on("click",function(){d(t("#linkAccountsContainer"))}),t("#editProfile").on("click",function(){p(e,$(this))}),v.find(n().$html,"",".backToPrevious").on("click",function(){return parent.history.back(),!1}),!1},reloadNeeded:function(){return g.reloadNeeded},unlinkAccount:function(e){!function(e){$.ajax({type:"DELETE",url:"profile/unlink/"+e,beforeSend:function(e){v.csrf(e)},success:function(e){$("[id^=createdLinkedAccount]").hide(),u(t("#linkedEmployeesDetails")),$("[id^=unLinkedAccount]").show(),n().widgets.linkedEmployeeList.api().ajax.reload()},error:function(e,n,t){v.onAjaxError(e,function(e){console.log(e),alert("Internal server error. Please contact administrator.")})}})}(e)},editLinkedContact:function(e,n){p(e,n)}}}();