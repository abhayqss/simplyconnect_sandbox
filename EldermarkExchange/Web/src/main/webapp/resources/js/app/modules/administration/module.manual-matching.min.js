ExchangeApp.modules.AdministrationManualMatching=function(){function t(){e().random=g.rand(),function(t,a){var n=e(),i=t||n.$html,r=a||n.random;i=g.randomize(i,r,!1)}(),function(t,a){var i=e();i.ajaxMap||(i.ajaxMap={});var r=t||i.$html,o=a||i.random,d=g.findAjaxUrls(r,o);$.each(d,function(t,e){i.ajaxMap[n(e,{params:!0})]=e}),g.find(r,o,'[data-ajax-load="true"]').on("click",function(){var t=$(this).attr("data-ajax-url-tmpl"),e=$(this).attr("data-ajax-url-vars"),a=$(this).attr("data-ajax-url-params"),n=g.getUrl(t,e,a);return m.route(n),!1}),g.find(r,o,'[data-ajax-anchor="true"]').on("click",function(){var t=$($(this).attr("href"));return t.length&&$("html, body").animate({scrollTop:t.offset().top},200),!1})}()}function e(){return u[n(h,{params:!0})]}function a(){return $('[id^="'+p+'"]')}function n(t,e){return g.stringifyUrl(t,e)}function i(t){var a=e();return g.find(a.$html,a.random,t)}function r(t){var e=i("#patientsListManual");t?e.find(".mergedResident").show():e.find(".mergedResident").hide()}function o(){var t=i("#manualMatchingNext"),a=C(e().widgets.patientList);t.prop("disabled",a<2)}function d(){e().widgets.patientList=function(t){var a=e();return v.grid(a.$html,a.random,t)}({tableId:"patientsListManual",searchFormId:"patientsFilterManual",totalDisplayRows:25,colSettings:{select:{bSortable:!1}},fetchServerData:function(t,e,a){var n={dataType:"json",type:e,url:t},d=function(t,e){this.callbacks&&this.callbacks[e]&&this.callbacks[e](t)},c=i("#"+this.searchFormId),s=i("#"+this.tableId);if(c.valid()){i("#manualMatchingShowSuggestedRecordsLayout").addClass("hidden"),n.data=c.serialize(),-1===n.data.indexOf("gender=")&&(n.data+="&gender=");var l=0,u=[];$.when().then(function(){return s.find("tbody").hide(),$.ajax(n)}).then(function(t){return l+=t.totalElements,u=u.concat(t.content),d(t,"successCallback"),t}).fail(function(t){return ExchangeApp.utils.module.onAjaxError(t),d(t,"errorCallback"),{iTotalDisplayRecords:0,content:[]}}).always(function(t){t.iTotalDisplayRecords=l,t.content=u,a(t)}).always(function(){s.find("tbody").show();if(u.filter(function(t){return t.mergedId}).length>0){var t=i("#manualMatchingShowSuggestedRecords");t.change(function(){r(this.checked)}),i("#manualMatchingShowSuggestedRecordsLayout").removeClass("hidden");var e;s.find(".mergedResident").each(function(){var t=$(this).next(),a=$(this).prev();a.is(".mergedResident")||(e=a.clone()),0!==t.length&&t.is(".mergedResident")||($(this).after(e),e.empty(),e.removeClass("even"),e.removeClass("odd"),$(this).is(".odd")?e.addClass("even"):e.addClass("odd"),e.on("click",function(){return!1}),e.hide())}),r(t.prop("checked"))}o()})}else a({iTotalDisplayRecords:0,content:[]})},selectable:{type:"multiple",callback:function(){o()}},callbacks:{rowCallback:function(t,e){var a=$(t),n=i("#manualMatchingShowSuggestedRecords").checked;null!==e&&e.mergedId&&"null"!==e.mergedId&&(a.addClass("mergedResident"),n||a.hide())},errorCallback:function(t){g.onAjaxError(t,function(e){_alert({action:"add",placeSelector:".patientFilterBox .boxBody",message:t.responseText,closable:{timer:45e3,btn:!0}})})},footerCallback:function(t,e,a,n,i){e.length<20?$(t).hide():$(t).show()}}})}function c(t,a){$.ajax({url:"administration/manual-matching/confirmation?matching="+t+"&mismatching="+a,type:"GET"}).success(function(n){if(n){var r=g.find(e().$html,"","#manualMatchingConfirmationContainer");r.empty(),r.append(n);var o=r.find("#manualMatchingConfirmationModal");r.find("#manualMatchingConfirmationSaveBtn").on("click",function(){o.modal("hide"),function(t,a){var n=$.extend({},t.reduce(function(t,e){return t[e]=!0,t},{}),a.reduce(function(t,e){return t[e]=!1,t},{}));$.ajax({headers:{Accept:"application/json","Content-Type":"application/json"},url:"administration/manual-matching/resolve",type:"POST",data:JSON.stringify(n),beforeSend:function(t){g.csrf(t)}}).success(function(){e().widgets.patientList.api().ajax.reload(),i("#patientsComparedContent").hide(),i("#patientsContent").show()}).fail(function(t){g.onAjaxError(t,function(){bootbox.alert(t.responseText)})})}(t,a)}),o.modal({backdrop:"static"}),o.on("hidden.bs.modal",function(){$(this).remove()})}}).fail(function(t){bootbox.alert(t.responseText)})}function s(t,a){$.ajax("administration/manual-matching/step2").success(a,function(a){i("#patientsContent").is(":hidden")||(i("#patientsContent").hide(),i("#patientsComparedContent").hide(),i("#patientsComparedContent").empty(),i("#patientsComparedContent").append(a),i("#patientsComparedContent").show(),g.find(e().$html,"",".backToManualMatching").on("click",function(){i("#patientsComparedContent").hide(),i("#patientsContent").show()}),g.find(e().$html,"","#manualMatchingCancel").on("click",function(){i("#patientsComparedContent").hide(),i("#patientsContent").show()}),g.find(e().$html,"","#manualMatchingSave").on("click",function(){return c(y(e().widgets.patientComparedList,".selected"),y(e().widgets.patientComparedList,":not(.selected)")),!1}),function(t){e().widgets.patientComparedList=v.grid(e().$html,"",{tableId:"manualMatchingPatientsCompared",sort:!1,paginate:!1,colSettings:{selfUrl:{customRender:function(t,e,a){if(!t)return"";var n=$("<a />",{id:"phr-"+a.id,class:"recordLink",href:"#"+t.template+"?"+(t.parameters||""),text:"View Health Record","data-ajax-load":"true","data-ajax-url-tmpl":t.template,"data-ajax-url-vars":t.variables,"data-ajax-url-params":t.parameters});return $(document).on("click","#phr-"+a.id,function(){var t=$(this).attr("data-ajax-url-tmpl"),e=$(this).attr("data-ajax-url-vars"),a=$(this).attr("data-ajax-url-params"),n=g.getUrl(t,e,a);return m.route(n),ExchangeApp.modules.PatientSearch&&ExchangeApp.modules.PatientSearch.loaded(),!1}),n.prop("outerHTML")}},matchedAutomatically:{customRender:function(t){return t?"Yes":"No"}}},fetchServerData:function(a,i,r){var o={dataType:"json",type:i,url:a},d=function(t,e){this.callbacks&&this.callbacks[e]&&this.callbacks[e](t)},c=t.map(function(t){return+t.id});o.url+=o.url.indexOf("?")>-1?"&":"?",o.url+="ids="+c;var s=t.reduce(function(t,e){return t[e.id]={id:+e.mergedId,matchedAutomatically:e.matchedAutomatically},t},{}),l=t.reduce(function(t,e){return e.mergedId&&(t[e.mergedId]?t[e.mergedId].push(+e.id):t[e.mergedId]=[+e.id]),t},{}),u=$("#"+this.tableId),h=0,f=[];$.when().then(function(){return u.find("tfoot").hide(),u.find("thead").hide(),$.ajax(o)}).then(function(t){var a=t.content.map(function(t){return+t.id}),i=function(t){return t&&a.filter(function(e){return e===t}).length>0};h+=t.totalElements;var r=[];f=t.content.map(function(t){var a="patient-info/{residentId}",o="hashKey="+t.hashKey+"&databaseId="+t.databaseId,d="residentId="+t.id;t.selfUrl={template:a,parameters:o,variables:d};var c=g.getUrl(a,d,o);e().ajaxMap[n(c,{params:!0})]=c,t.select=!1;var u=s[t.id];i(u.id)&&(t.select=!0,t.matchedAutomatically=u.matchedAutomatically);var h=l[t.id];for(var f in h)if(i(h[f])){t.select=!0;break}return t.select?t.matchedAutomatically&&r.push(u.id):t.matchedAutomatically=!1,t});for(var o in f)r.indexOf(+f[o].id)>-1&&(f[o].matchedAutomatically=!0);return d(t,"successCallback"),t}).fail(function(t){return ExchangeApp.utils.module.onAjaxError(t),d(t,"errorCallback"),{iTotalDisplayRecords:0,content:[]}}).always(function(t){return t.iTotalDisplayRecords=h,t.content=f,r(t),t}).always(function(t){var e=$("#manualMatchingPatientsCompared");e.find(".even").each(function(){$(this).removeClass("even"),$(this).addClass("odd")}),e.find("thead").hide(),e.find("tbody tr td.checkbox-col").each(function(e){$(this).append(" <label>Matching</label>"),t.content[e].select&&$(this).find("input[type='checkbox']").prop("checked",!0).trigger("change")}),h&&(e.find("tbody tr").each(function(){$(this).css({"min-width":$(this).width()+20+"px"});var t=100/h;$(this).width(t+"%")}),h>6&&e.parent().width("82%")),e.find("tbody tr:first td").each(function(t){var a=$(this).text(),n=!1;0===t||$(this).hasClass("checkbox-col")||$(this).parent().siblings().each(function(){var e=$(this).children().eq(t);a!==e.text()&&(n=!0)}),e.find("tbody tr").each(function(){var e=$(this).children().eq(t);n?e.addClass("mismatchingProperty"):e.addClass("matchingProperty")})})})},selectable:{type:"multiple",ignoreRowClicks:!0},callbacks:{rowCallback:function(t,e,a){},errorCallback:function(t){alert(t.responseText)},footerCallback:function(t,e,a,n,i){$(t).hide()}}})}(t))})}var l,u={},h={template:"administration/manual-matching"},f={reloadNeeded:!0},p="manualMatchingTabContent",m=ExchangeApp.routers.ModuleRouter,g=ExchangeApp.utils.module,v=ExchangeApp.utils.wgt,x=ExchangeApp.loaders.FragmentLoader.init("administrationManualMatching");$.fn.clearForm=function(){return this.each(function(){var t=this.tagName.toLowerCase();if("form"===t)return $(':input:not([disabled="disabled"], [type="hidden"], [name="mode"])',this).clearForm();var e=this.type;"text"===e||"password"===e||"textarea"===t?(this.value="",$(this).trigger("refresh")):"select"===t?(this.selectedIndex=0,$(this).trigger("change")):"checkbox"!==e&&"radio"!==e||(this.checked=!1,$(this).trigger("refresh"))})},$.fn.dataTableExt.oApi.fnSortNeutral=function(t){t.aaSorting=[],t.aiDisplay.sort(function(t,e){return t-e}),t.aiDisplayMaster.sort(function(t,e){return t-e}),t.oApi._fnReDraw(t)};var b=function(t,e){return e=e||".selected",t.api().rows(e).data().toArray()},y=function(t,e){return b(t,e).map(function(t){return+t.id})},C=function(t){return t?t.api().rows(".selected").data().length:0};return{init:function(a,n){h=a,l=n,this.loadFragment({onFragmentLoaded:function(){t()},onResourcesLoaded:function(){var t=e();t.widgets={},d(),this.setFormEvents(),t.inited=!0,this.render(),this.show()}})},update:function(t){h=t},getFragment:function(t){return u[n(t,{params:!0})]},isFragmentInited:function(t){var e=this.getFragment(t);return e&&e.inited},loadFragment:function(t){var e=this;x.load({url:h,callbacks:{onFragmentLoaded:function(a){f.reloadNeeded=!1;var i=$(a).find("#content").children(),r=n(h,{params:!0});u[r]={$html:i,url:g.clone(h)},t.onFragmentLoaded.apply(e)},onResourcesLoaded:function(){t.onResourcesLoaded.apply(e)}}})},render:function(){var t=e().$html;a().empty(),a().append(t)},hide:function(){a().hide(),$("#content").addClass("loading")},show:function(){$.each($("#administration").find(".nav li"),function(){$(this).removeClass("active")}),$('a[data-target^="#'+p+'"]').parent("li").addClass("active"),a().show(),$("#content").removeClass("loading")},setFormEvents:function(){i(".datepicker").datepicker(),i("input[type='radio']").styler(),i("input[type='checkbox']").styler();return i("#patientsFilterManual input").on("keydown",function(t){if(13===t.keyCode)return t.preventDefault(),e().widgets.patientList.api().ajax.reload(),!1}),i("#patientSearchManual").on("click",function(){return e().widgets.patientList.api().ajax.reload(),!1}),i("#patientSearchManualClear").on("click",function(){i("#patientsFilterManual").clearForm();var t=e().widgets.patientList;return t.fnSortNeutral(),t.fnSettings().oInit.store.removeAllItems(),!1}),i("#manualMatchingNext").on("click",function(){var t=b(e().widgets.patientList,".selected");return t&&t.length>1&&s(t),!1}),o(),!1},reloadNeeded:function(){return f.reloadNeeded},getParentModule:function(){return l}}}();