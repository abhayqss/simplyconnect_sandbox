function isEmpty(e){return!e||0===e.length}function nucleusPost(e,l){document.getElementById("nucleus").contentWindow.postMessage({msg:e,param:l},"*")}function setFrameSrc(e,l,n,a,o){if(!(isEmpty(e)||isEmpty(l)||isEmpty(n)||isEmpty(a))){var s=document.getElementById("nucleus"),i=e+"/client/client.aspx?Token="+l+"&FromID="+n+"&ToID="+a+(o?"&RequestID="+o:"");console.log("startCall() frame src = "+i),s.src=i}}function endCall(){nucleusPost(callEstablished?"endCall":"cancelCall"),$("#nucleusCallWidget").hide()}function initCall(){if($("#nucleusCallWidget").is(":visible")){if(!confirm("There's a call in progress. Are you sure you want to cancel it and make a new call?"))return!1;endCall()}var e=!1,l=100;callEstablished=!1,$("#nucleusCallWidget").css({top:50,left:50}),$("#endCall").unbind("click").click(endCall),$("#iconUnmute").hide(),$("#iconMute").show(),$("#mute").unbind("click").click(function(){e?(nucleusPost("unmute"),$("#iconMute").show(),$("#iconUnmute").hide(),n.slider("value",l)):(nucleusPost("mute"),$("#iconMute").hide(),$("#iconUnmute").show(),l=n.slider("value"),n.slider("value",0)),e=!e});var n=$("#slider"),a=$(".tooltip");return a.hide(),n.slider({range:"min",min:1,value:35,start:function(e,l){a.fadeIn("fast")},slide:function(l,n){nucleusPost("setSpeakerVolume",n.value),a.css("left",n.value).text(n.value),e&&($("#iconMute").show(),$("#iconUnmute").hide(),e=!1)},stop:function(e,l){a.fadeOut("fast")}}),$("#decSpeakerVolume").unbind("click").click(function(){var e=n.slider("value");e>1&&(n.slider("value",e-2),nucleusPost("setSpeakerVolume",e-2))}),$("#incSpeakerVolume").unbind("click").click(function(){var l=n.slider("value");l<99&&(n.slider("value",l+2),nucleusPost("setSpeakerVolume",l+2),e&&($("#iconMute").show(),$("#iconUnmute").hide(),e=!1))}),setTimeout(function(){$("#nucleusCallWidget").show()},500),!0}function showNotification(e,l,n){var a=l.RequestID,o=l.Name,s=l.IsEmergency,i=$.notify({icon:"resources/images/"+(s?"incoming-call-emergency.png":"incoming-call.png"),title:o,message:"Incoming call"},{element:"body",type:"info",allow_dismiss:!1,newest_on_top:!1,showProgressbar:!1,placement:{from:"bottom",align:"right"},offset:20,spacing:10,z_index:1061,delay:0,animate:{enter:"animated fadeInUp",exit:"animated fadeOutDown"},icon_type:"image",template:'<div id="growl-'+a+'" data-notify="container" class="col-xs-11 col-sm-6 col-md-3 alert alert-{0} nucleus-incoming-call" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss">Ã—</button><div class="ldr-ui-layout row">   <div class="ldr-ui-layout col-sm-6 col-xs-6" style="/*background-color: dimgrey*/">       <div class="ldr-ui-layout title-container"><span data-notify="title">{1}</span></div>       <div class="ldr-ui-layout message-container">           <span data-notify="icon"></span> <span data-notify="message">{2}</span>       </div>   </div>   <div class="ldr-ui-layout col-md-offset-2 col-sm-offset-1 col-xs-offset-1 col-sm-4 col-xs-4" style="/*background-color: darkgreen;*/ padding: 0">       <div class="ldr-ui-layout row" style="/*background-color: green;*/">       <div class="ldr-ui-layout col-sm-6 col-xs-6" style="/*background-color: darkblue;*/ padding: 0">           <a role="button" class="ldr-ui-btn btn answer-call-with-video"><img src="resources/images/answer-call-with-video.png"/></a>       </div>       <div class="ldr-ui-layout col-sm-6 col-xs-6" style="/*background-color: darkred;*/ padding: 0">           <a role="button" class="ldr-ui-btn btn decline-call"><img src="resources/images/end-cancel-call.png"/></a>       </div></div>   </div>   <div class="progress" data-notify="progressbar">       <div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0;"></div>   </div></div><a href="{3}" target="{4}" data-notify="url"></a></div>'}),t=$("#growl-"+a);t.find("a.answer-call-with-video").click(function(){n.onAccepted?n.onAccepted(l)&&i.close():i.close()}),t.find("a.decline-call").click(function(){n.onDeclined&&n.onDeclined(l),i.close()})}function hideNotification(e,l){var n=e.RequestID,a=$("#growl-"+n);a.find('[data-notify="dismiss"]').trigger("click"),a.length>0&&l.onIgnored&&l.onIgnored(e)}function dontListenForIncomingCalls(e){isEmpty(e)||(polling[e]=!1)}function listenForIncomingCalls(e,l,n,a){if(!(isEmpty(e)||isEmpty(l)||isEmpty(n))&&!0!==polling[n]){a=a||{},console.log('start polling for user "'+n+'"');var o=[];polling[n]=!0,function s(){$.ajax({url:e+"?Token="+l+"&UserID="+n,type:"GET",success:function(e){if(console.log("polling response: "+JSON.stringify(e)),e.ok){var l=e.requests.map(function(e){return e.RequestID});$.each(e.requests,function(e,l){-1===$.inArray(l.RequestID,o)&&showNotification(n,l,a)}),$.each(o,function(e,n){-1===$.inArray(n,l)&&hideNotification(n,a)}),o=l}else polling[n]=!1,console.warn('stop polling for user "'+n+'"')},dataType:"json",complete:setTimeout(function(){polling[n]&&s()},6e3),timeout:5e3})}()}}var callEstablished,polling=[];window.addEventListener("message",function(e){switch(console.log("nucleus message:  ",e.data),e.data.msg){case"nucleusLoaded":console.log("nucleusLoaded");break;case"handleCallStarted":console.log("handleCallStarted");break;case"handleCallEstablished":console.log("handleCallEstablished"),callEstablished=!0;break;case"handleCallRejected":console.log("handleCallRejected"),setTimeout(endCall,3e3);break;case"handleCallDisconnected":console.log("handleCallDisconnected"),setTimeout(endCall,3e3);break;case"handleCallBusy":console.log("handleCallBusy"),setTimeout(endCall,3e3);break;case"handleCallTimeout":console.log("handleCallTimeout"),setTimeout(endCall,3e3)}},!1);