ExchangeApp.modules.CareCoordinationPatients=function(){var e,t,n,a,s,o,r,d={},l={template:"care-coordination/patients"},c={reloadNeeded:!0},m="patientsTabContent",u=ExchangeApp.routers.ModuleRouter,f=ExchangeApp.utils.module,p=ExchangeApp.utils.wgt,h=ExchangeApp.loaders.FragmentLoader.init("careCoordinationPatients"),v=(ExchangeApp.loaders.ModuleLoader,ExchangeApp.loaders.ComponentLoader),b=!1,g=!1,C=null,y=!1,w=["CM_24H","CM_14D","CM_ADDITIONAL"],x=["FACE_TO_FACE_ENCOUNTER","NON_FACE_TO_FACE_ENCOUNTER"],T=!1,k={problems:function(e,t){"add"===t.mode&&(e.find("#problem\\.startDate").datetimepicker({useCurrent:!1,defaultDate:!1,format:"MM/DD/YYYY hh:mm A (Z)",maxDate:new Date}),e.find("#problem\\.onSetDate").datetimepicker({format:"MM/DD/YYYY",maxDate:new Date}),e.find("#problem\\.recordedDate").datetimepicker({defaultDate:new Date,format:"MM/DD/YYYY hh:mm A (Z)",maxDate:new Date}));var n=function(e){return e.find("#problemsCcdForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{"value.id":{required:!0},"value.id_searchInput":{required:!0},primary:{required:!0},"type.id":{required:!0},"status.id":{required:!0},recordedDate:{required:!0},comments:{maxlength:2e4}},messages:{"value.id":{required:getErrorMessage("field.empty")},"value.id_searchInput":{required:getErrorMessage("field.empty")},primary:{required:getErrorMessage("field.empty")},"type.id":{required:getErrorMessage("field.empty")},"status.id":{required:getErrorMessage("field.empty")},recordedDate:{required:getErrorMessage("field.empty")}}}))}(e),a=e.find("#problem\\.endDate");a.attr("disabled","disabled"),e.find("#problem\\.status\\.id").on("change",function(){var e=$(this).find(":selected");"413322009"===e.attr("data-code")?a.removeAttr("disabled").datetimepicker({format:"MM/DD/YYYY hh:mm A (Z)",maxDate:new Date}):(a.attr("disabled","disabled"),a.val(""))});var i=e.find('[name="primary"]'),s=i.filter(function(){return"false"===this.value}),o=i.filter(function(){return"true"===this.value}),r=o.is(":checked");r||(s.on("click",function(){r=!1}),o.on("click",function(){if(!o.hasClass("pending")&&!r)return o.addClass("pending"),$.ajax("patient-info/"+t.residentId+"/ccd/problems/primary?hashKey="+t.hashKey).success(function(e){-1!==e?bootbox.confirm({title:"Change primary diagnosis?",message:"Primary diagnosis is already set. Do you want to change the selection?",buttons:{cancel:{label:"No"},confirm:{label:"Yes"}},callback:function(e){s.prop("checked",!e),o.prop("checked",e),o.removeClass("pending"),r=e,$(this).on("hidden.bs.modal",function(){$("body").addClass("modal-open")})}}):(o.prop("checked",!0),o.removeClass("pending")),i.blur()}),!1}));var d=p.lifeSearch(O().$html,"",{select:"#problem\\.value\\.id",searchInput:"#problem\\.value\\.id_searchInput",notEmptyKeyUpCallBack:function(e){O().widgets.problemValueDropdown.api().ajax.reload()},searchInputNotEmptyClickCallback:function(e){O().widgets.problemValueDropdown.api().ajax.reload()}});O().widgets.problemValueDropdown=p.grid(O().$html,"",{tableId:"problemValueDropdown",totalDisplayRows:7,selectable:{type:"single"},searchFormId:"problem\\.value\\.id_searchInput",language:{sZeroRecords:"No data found. Please contact your Administrator to solve the issue."},callbacks:{rowCallback:function(e,t,n){var a=$(e);a.click(function(){d.setSelectValue(t.id,t.displayName),d.close()})},drawCallback:function(e){},errorCallback:function(e){},footerCallback:function(e,t,n,a,i){$(e).hide()},headerCallback:function(e,t,n,a,i){}}}),O().widgets.diagnosisInformation=p.grid(O().$html,"",{tableId:"problemDiagnosisInformation",paginate:!1,selectable:{type:"single"},searchFormId:"problem\\.value\\.id",callbacks:{rowCallback:function(e,t,n){$(e)},drawCallback:function(e){},errorCallback:function(e){},footerCallback:function(e,t,n,a,i){$(e).hide()},headerCallback:function(e,t,n,a,i){}}});var l=e.find("#problem\\.value\\.id"),c=e.find("#diagnosisInformationWrapper");c.hide(),l.on("change",function(){""===$(this).val()||null===$(this).val()||void 0===$(this).val()?c.hide():(c.show(),O().widgets.diagnosisInformation.api().ajax.reload())}),e.find("#submitNoteBtn").on("click",function(){var a=e.find("#problemsCcdForm");if(!a.valid())return n.focusInvalid(),!1;var i=$(this);return i.hasClass("pending")||(i.addClass("pending"),$.ajax({url:a.attr("action"),data:new FormData(a[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e)},success:function(n){e.find("#problemsCcdModal").modal("hide"),Me(t.sectionName,t.residentId,t.hashKey),O().widgets.problemsList.api().ajax.reload(),"add"===t.mode?(O().widgets.patientEventList.api().ajax.reload(),bootbox.alert("Problem has been added")):"edit"===t.mode&&bootbox.alert("Problem has been edited")},error:function(e){f.onAjaxError(e,function(){alert(e.responseText)}),i.removeClass("pending")}})),!1}),e.find(".cancelBtn").on("click",function(){e.find("#problemsCcdModal").modal("hide")})}},D={problems:"problemObservationId",planOfCare:"planOfCareId"},E={};function S(e){E=$.extend({},E,e)}function P(){E={}}var A=Object.freeze({IN_PROCESS:0,INACTIVE:1,COMPLETED:2}),I=Object.freeze({ADD:"Add",EDIT:"Edit"}),M=Object.freeze({VIEW:"view",EDIT:"edit"}),N={accordions:0,collapse:0,expand:0},q=function(){var e="asmnt_tabkey";function t(t){if(t)for(;;)try{localStorage.setItem(e,JSON.stringify(t));break}catch(e){if(22!==e.code)throw e;if(0===t.length)break;t.splice(0,1)}}function n(){return localStorage.getItem(e)?JSON.parse(localStorage.getItem(e)):[]}function a(e,t){return e.findIndex(function(e){return e.id==t})}return{saveTabKey:function(e,i){if(localStorage&&e){var s=n(),o=a(s,e);-1!==o&&s.splice(o,1),s.push({id:e,tab:i}),t(s)}},loadTabKey:function(e){if(localStorage&&e){var t=n(),i=a(t,e);return-1===i?null:t[i].tab}},changeId:function(e,i){if(localStorage&&e&&i){var s=n(),o=a(s,e);-1!==o&&(s.push({id:i,tab:s[o].tab}),s.splice(o,1)),t(s)}}}}();function j(){O().random=f.rand(),function(e,t){var n=O(),a=e||n.$html,i=t||n.random;a=f.randomize(a,i,!1)}()}function L(e){var t=O();return p.grid(t.$html,t.random,e)}function R(e){var t=O();return p.alert(t.$html,t.random,e)}function O(){return d[_(l,{params:!0})]}function F(){return $('[id^="'+m+'"]')}function _(e,t){return f.stringifyUrl(e,t)}function Y(e){var t=O();return f.find(t.$html,t.random,e)}function H(e,t,n){e.find('[id="'+t+'"]').on("change",function(t){$(this).context.checked?e.find('[id="'+n+'"]').show():e.find('[id="'+n+'"]').hide()})}function z(e,t){var n=e.find('[id="contact.email"]'),a=e.find('[id="email.label"]');t?(a.text("Email"),n.parents(".form-group").removeClass("has-warning"),n.removeAttr("data-validated"),n.tooltip("destroy")):a.text("Email*"),n.prop("disabled",t)}function B(e,t,n){n.hasClass("pending")||(n.addClass("pending"),$.ajax({url:"care-coordination/patients/patient/"+t,headers:{"X-Content-Compressing":"enabled"}}).success(function(a){e.empty(),e.append(a),function(e){e.find("#patientForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{email:{required:"#noemail:unchecked",maxlength:255,emails:!0},firstName:{required:!0,minlength:2,maxlength:128},lastName:{required:!0,minlength:2,maxlength:128},gender:{required:!0},birthDate:{dateExp:/^\d{2}\/\d{2}\/\d{4}$/,required:function(e){return!0}},"address.street":{required:!0,minlength:2,maxlength:255},"address.city":{required:!0,minlength:2,maxlength:128},"address.state":{required:!0},"address.zip":{required:!0,lengthEqual:5},communityId:{required:!0},phone:{phone:!0},cellPhone:{required:!0,phone:!0},ssn:{required:!0,ssn:!0},groupNumber:{maxlength:250},memberNumber:{maxlength:250},medicareNumber:{maxlength:250},medicaidNumber:{maxlength:250},primaryCarePhysician:{maxlength:250},referralSource:{maxlength:250},currentPharmacyName:{maxlength:250},deviceID:{required:function(e){return!$("input[name='deviceIDSecondary']").is(":blank")}},deviceIDSecondary:{notEqual:"input[name='deviceID']"}},messages:{firstName:{required:getErrorMessage("field.empty")},lastName:{required:getErrorMessage("field.empty")},communityId:{required:getErrorMessage("field.empty")},deviceID:{required:getErrorMessage("deviceID.empty")},deviceIDSecondary:{notEqual:getErrorMessage("deviceIDSecondary.unique")},phone:{phone:getErrorMessage("field.phone.format")},cellPhone:{required:getErrorMessage("field.empty"),phone:getErrorMessage("field.phone.format")},birthDate:{dateExp:getErrorMessage("field.dateFormat"),required:getErrorMessage("field.empty")},state:{stateUS:getErrorMessage("field.state")},insuranceId:{required:getErrorMessage("field.empty")}}}))}(e);var i=e.find("#patientForm"),s=i.find("#communityWarning");""==i.find("#patient\\.communityId").val()?s.is(":visible")||i.find("#communityWarning").show():s.is(":visible")&&i.find("#communityWarning").hide();var o=e.find("#createPatientModal");$("input.datepicker").datepicker().on("changeDate",function(e){$(this).trigger("focus").trigger("blur")});var r=e.find('[id="patient.insuranceId"]');r.select2({placeholder:"Search by network name",width:"100%"});var d=e.find('[id="patient.insurancePlanId"]');r.on("change",function(){$.ajax({type:"GET",contentType:"json",url:"care-coordination/patients/patient/"+t+"/insuranceId/"+$(this).val()+"/plans",success:function(e){d[0].options.length=1,$.each(e,function(e,t){d[0].add(new Option(t.label,t.id))}),d[0].options.length>1?d.removeAttr("disabled"):d.attr("disabled","disabled")}})});var l=e.find('[id="noemail"]'),c=e.find('[id="contact.email"]');0!=t&&(l.prop("checked",c.is(":blank")),l.prop("disabled",!c.is(":blank")),z(e,l.is(":checked"))),l.change(function(){z(e,l.is(":checked"))}),c.keyup(function(){l.prop("disabled",!c.is(":blank"))});var m=$("#patient\\.organizationId");m.change(function(){var e=$("#patient\\.communityId");e.empty(),0==m.val()?(e.append('<option value="">-- Select --</option>'),s.is(":visible")&&i.find("#communityWarning").hide()):$.ajax({url:"care-coordination/communities/byorg/"+m.val(),type:"GET"}).success(function(t){t.content.length>1&&e.append('<option value="">-- Select --</option>'),$.each(t.content,function(t,n){e.append('<option value="'+n.id+'">'+n.name+"</option>")});var n=i.find("#communityWarning");0==t.content.length?n.is(":visible")||i.find("#communityWarning").show():n.is(":visible")&&i.find("#communityWarning").hide()}).fail(function(e){$("#formError").text(e.responseText)})}),e.find('[id="patient.intakeDate"]').datetimepicker({format:"MM/DD/YYYY hh:mm A (Z)"}),e.find("#savePatient").on("click",function(){var n=e.find("#patientForm");if(!n.valid())return!1;var a=$(this);return a.hasClass("pending")||(a.addClass("pending"),0!=t?V(t,n,o,a):$.ajax({url:"care-coordination/patients/find-matches",type:"POST",data:n.serialize(),beforeSend:function(e){f.csrf(e)}}).success(function(e){if(e){o.modal("hide");var i=f.find(O().$html,"","#matchedPatientListContainer");i.empty(),i.append(e);var s=i.find("#matchedPatientListModal");i.find("#createRecord").on("click",function(){s.modal("hide"),V(t,n,o,a)}),s.modal({backdrop:"static"}),s.on("hidden.bs.modal",function(){$(this).remove()})}else V(t,n,o,a)}).fail(function(e){f.onAjaxError(e,function(){bootbox.alert(e.responseText),a.removeClass("pending")})})),!1}),o.modal({backdrop:"static"}),o.on("hidden.bs.modal",function(){$(this).remove()}),n.removeClass("pending")}).fail(function(){n.removeClass("pending"),alert("Internal server error. Please contact administrator.")}))}function V(e,t,n,a){var s=document.getElementById("patient.deviceID"),o=document.getElementById("patient.deviceIDSecondary"),r=document.getElementById("patient.communityId"),d="care-coordination/patients/patient/"+e;null!=s&&null!=r&&(s=s.value,d+="/validateDevices?facilityId="+(r=r.value)+"&deviceId="+s,null!=o&&(d+="&deviceIdSecondary="+o.value)),$.ajax({url:d,type:"GET"}).success(function(s){if(""!=s&&s instanceof Array){if(s instanceof Array){var o="";for(i=0;i<s.length;i++)o+="Device with ID "+s[i].deviceID+" is already used by "+s[i].patientName+". ";o+="Do you want to change the selection?",bootbox.confirm({message:o,buttons:{confirm:{label:"Yes",className:"btn-primary"},cancel:{label:"No",className:"btn-default"}},callback:function(i){i?$.ajax({url:"care-coordination/patients/patient/"+e,type:"POST",data:t.serialize(),beforeSend:function(e){f.csrf(e)}}).success(function(t){O().widgets.patientsList.api().ajax.reload(),n.modal("hide"),$(".modal-backdrop").remove(),ExchangeApp.managers.EventManager.publish("patients_list_changed"),Ne(t,null,0==e)}).fail(function(e){f.onAjaxError(e,function(){bootbox.alert(e.responseText),a.removeClass("pending")})}):a.removeClass("pending")}})}}else $.ajax({url:"care-coordination/patients/patient/"+e,type:"POST",data:t.serialize(),beforeSend:function(e){f.csrf(e)}}).success(function(t){O().widgets.patientsList.api().ajax.reload(),n.modal("hide"),$(".modal-backdrop").remove(),ExchangeApp.managers.EventManager.publish("patients_list_changed"),Ne(t,null,0==e,0!=e)}).fail(function(e){f.onAjaxError(e,function(){bootbox.alert(e.responseText),a.removeClass("pending")})})}).fail(function(e){f.onAjaxError(e,function(){bootbox.alert(e.responseText),a.removeClass("pending")})})}function J(e){v.load(["Component","Widget","ToolBar","Grid","Form","Modal","Popover","Tabs","Slider","Table","TableRow","TableCell","DynaFooter","Loader","SearchPanel","AnchorLinkPanel","care-coordination/patient/ServicePlanList","care-coordination/patient/ServicePlanForm","care-coordination/patient/ServicePlanFormNeedSection","care-coordination/patient/ServicePlanFormGoalSection","care-coordination/patient/ServicePlanFormScoringSection","care-coordination/patient/ServicePlanModal","care-coordination/patient/ServicePlanDetails","care-coordination/patient/ServicePlanChangeHistoryList","care-coordination/patient/ServicePlanDetailedInfoTabs","care-coordination/patient/ServicePlanListPanel"],function(){var t=$("#currentPatientId").val(),n=new ServicePlanListPanel({container:e.container,patientId:t,onSavePlanSuccess:function(){Ce(t),function(e){var t=$("#care-coordination"),n=t.find(".patientTabs");"servicePlansTab"!==n.filter(".active").attr("id")&&(n.each(function(){var e=$(this);"servicePlansTab"===e.attr("id")?e.addClass("active"):e.removeClass("active")}),t.find(".patientTabContent").each(function(){var e=$(this);"patientServicePlansContent"===e.attr("id")?e.addClass("active"):e.removeClass("active")}),setTimeout(function(){u.route({template:"care-coordination/patients/"+e+"/service-plans"})},300))}(t)}});O().widgets.servicePlanListPanel=n,f.find(O().$html,"","#addServicePlan").off().on("click",function(){$.ajax({type:"GET",url:"care-coordination/patients/patient/"+t+"/service-plans/can-create",beforeSend:function(e){f.csrf(e)},success:function(e){e?n.onAddPlan():bootbox.alert("There is an active service plan. <br/>You can not create a new one until the active plan is completed.")},fail:function(){bootbox.alert("Cannot create a new service plan. Please try again later.")}})}),n.mount()})}function W(e){var t=e.find("#careTeamEmployeeSelect").val(),n=e.find("#careTeamRoleSelect").val(),a=e.find("#careTeamMemberId").val();if(n){var i="care-coordination/patients/patient/"+$("#currentPatientId").val()+"/care-team/notification-preferences?careTeamRoleId="+n;t&&(i+="&employeeId="+t),a&&(i+="&careTeamMemberId="+a),$.ajax(i).success(function(t){!function(e,t){var n=e.find("#careTeamMemberNotificationPreferences");n.empty();var a=e.find("#notificationPreferencesTemplate").clone();a.attr("id","notificationPreferencesTemplate-all"),a.find(".eventType").html("All Events").css("font-style","italic");var i=a.find(".responsibility");i.append("<option selected disabled hidden style='display: none' value=''></option>"),i.selectpicker(),i.on("change",function(e){n.find(".responsibility:enabled").not(this).val($(this).val()).trigger("change")});var s=a.find(".notificationType");s.selectpicker(),s.on("changed.bs.select",f.allOptionHandler),s.on("change",function(e){var t=n.find(".notificationType").not(this);t.not(".notesNotificationType").selectpicker("val",$(this).val());var a=null;$(this).val()?$(this).val().find(function(e){return"ALL"===e})?(a=[],$(this).children("option").each(function(e,t){a.push(t.value)})):a=$(this).val():(i.selectpicker("val","N"),i.trigger("change")),t.find(".notesNotificationType").selectpicker("val",a),n.find(".notes-dropdown-menu")}),a.removeClass("hidden"),n.append(a);var o=0;$.each(t,function(t,a){$.each(a.notificationPreferences,function(t,i){var s=e.find("#notificationPreferencesTemplate").clone();s.attr("id","notificationPreferencesTemplate-"+o),s.find(".eventType").html(i.eventType);var r=s.find(".notificationPreferencesId");r.val(i.id),r.attr("name","notificationPreferences["+o+"].id");var d=s.find(".eventTypeId");d.val(i.eventTypeId),d.attr("name","notificationPreferences["+o+"].eventTypeId");var l=s.find(".responsibility");l.attr("name","notificationPreferences["+o+"].responsibility"),i.canChange||(l.prop("disabled","disabled"),l.addClass("notificationsDisabledSelect")),"COVID-19"===i.eventType&&(l.find("option[value='V']").prop("disabled",!0),l.find("option[value='N']").prop("disabled",!0)),l.selectpicker("val",i.responsibility);var c=s.find(".notificationType");c.attr("name","notificationPreferences["+o+"].notificationTypeList"),c.attr("id","notificationPreferences-"+o),i.notificationTypeList&&("Notes"===a.name&&(i.notificationTypeList=i.notificationTypeList),c.selectpicker("val",i.notificationTypeList)),"Notes"===a.name&&(c.addClass("notesNotificationType"),s.find(".notificationType > .dropdown-menu").addClass("notes-dropdown-menu")),c.on("changed.bs.select",f.allOptionHandler),c.on("change",function(e){!e.currentTarget.selectedOptions.length&&l.is(":enabled")&&l.selectpicker("val","N")}),l.on("change",function(){"N"===$(this).val()&&c.selectpicker("val",[])}),s.removeClass("hidden"),0==t?n.append('<div class="sectionHead notificationPreferenceHead">'+a.name+"</div>"):t==a.notificationPreferences.length-1&&s.css("height","52px"),n.append(s),o++})})}(e,t)})}}function K(e,t,n,a,i,s,o){o.hasClass("pending")||(o.addClass("pending"),$.ajax({url:"care-coordination/patients/patient/"+$("#currentPatientId").val()+"/care-team/"+(t?t+"/":"")+s,headers:{"X-Content-Compressing":"enabled"}}).success(function(r){e.empty(),e.append(r),function(e){e.find("#careTeamMemberForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{careTeamEmployeeSelect:{required:!0},careTeamRoleSelect:{required:!0}},messages:{careTeamEmployeeSelect:{required:getErrorMessage("field.empty")},careTeamRoleSelect:{required:getErrorMessage("field.empty")}}}))}(e);var d=e.find("#createCareTeamMemberModal"),l=(t?"Edit ":"Add New ")+"Patient Care Team Member";e.find("#careTeamMemberHeader").html(l),$(e.find("#careTeamMemberId")).val(t),$(e.find("#careTeamDescription")).val(n);var c=e.find("#careTeamEmployeeSelect");c.select2({placeholder:"Select Contact",width:"100%"}),c.on("select2:select",function(t){W(e)}),a&&(c.val(a.id).trigger("change"),c.prop("disabled",!0));var m=e.find("#careTeamRoleSelect");m.select2({placeholder:"Select Role",width:"100%"}),m.on("select2:select",function(t){W(e)}),i&&m.val(i.id).trigger("change");var u=e.find(".modal-content"),p=e.find(".modal-body"),h=f.initAjaxLoader(u,{loaderWillBeShown:function(){p.css("visibility","hidden")},loaderWillBeHidden:function(){p.css("visibility","visible")}});e.find("#saveCareTeamMember").on("click",function(){!function(e,t,n,a,i){if(!a.hasClass("pending")){a.addClass("pending");var s=e.find("#careTeamMemberForm"),o=form2js("careTeamMemberForm",".",!0,function(e){if(e.id&&e.id.match(/callbackTest/))return{name:e.id,value:e.innerHTML}});!!s.valid()&&(delete o._csrf,delete o._,i.show(),$.ajax({url:"care-coordination/patients/patient/"+$("#currentPatientId").val()+"/care-team/",type:"PUT",contentType:"application/json; charset=utf-8",data:JSON.stringify(o),beforeSend:function(e){f.csrf(e)}}).success(function(e){n?O().widgets.affiliatedPatientCareTeam.api().ajax.reload():O().widgets.patientCareTeam.api().ajax.reload(),t.modal("hide"),i.hide(),a.removeClass("pending")}).fail(function(e){i.hide(),f.onAjaxError(e,function(){a.removeClass("pending"),$("#formError").text(e.responseText)})}))}}(e,d,s,$(this),h)}),e.find("#careTeamMemberForm input").keydown(function(e){if(13===e.which)return e.preventDefault(),!1}),e.find(".cancelBtn").on("click",function(){e.find("#createCareTeamMemberModal").modal("hide")}),e.find("#createCareTeamMemberModal").modal("show"),e.find("#createCareTeamMemberModal").on("hidden.bs.modal",function(){$(this).remove()}),t&&W(e),o.removeClass("pending")}).fail(function(){o.removeClass("pending"),alert("Internal server error. Please contact administrator")}))}function G(e){var t=f.find(O().$html,"","#createCareTeamContainer"),n=f.find(O().$html,"","#deleteCareTeamContainer"),a=p.grid(O().$html,"",{tableId:e?"affiliatedPatientCareTeam":"patientCareTeam",totalDisplayRows:25,colSettings:{description:{bSortable:!1},actions:{width:"100px",className:"dt-head-center"}},callbacks:{rowCallback:function(a,i,s){var o=$(a);if(i&&("false"==$("#affiliatedView").val()||e)){var r="td:eq(3)";"true"!=$("#hasMerged").val()||e||(r="td:eq(4)"),"true"==$("#hasMerged").val()&&e&&(r="td:eq(5)"),o.children(r).empty();var d=i.id,l=i.employee,c=i.role,m=i.description,u=f.find(O().$html,"","#rowActions").clone();if(i.editable||i.deletable||i.nucleusUserId){var p="rowActions-"+s;u.attr("id",p),u.removeClass("hidden"),o.children(r).append(u)}i.editable&&(u.find(".editCareTeamMember").removeClass("hidden"),u.find(".editCareTeamMember").on("click",function(){K(t,d,m,l,c,e,$(this))}),i.deletable||u.css("padding-right","60px")),i.deletable&&(u.find(".deleteCareTeamMember").removeClass("hidden"),u.find(".deleteCareTeamMember").on("click",function(){!function(e,t,n,a){$.ajax({url:"care-coordination/patients/patient/"+$("#currentPatientId").val()+"/care-team/"+t+"/delete",headers:{"X-Content-Compressing":"enabled"}}).success(function(i){e.empty(),e.append(i),e.find("#deleteCareTeamMemberModal");var s=t;e.find("#careTeamMemberName").html("<b>"+n+"</b>"),e.find("#deleteCareTeamMember").on("click",function(){return $.ajax({url:"care-coordination/patients/patient/"+$("#currentPatientId").val()+"/care-team/"+s,type:"DELETE",beforeSend:function(e){f.csrf(e)}}).fail(function(e){f.onAjaxError(e,function(){alert(e.responseText)})}).complete(function(){a?O().widgets.affiliatedPatientCareTeam.api().ajax.reload():O().widgets.patientCareTeam.api().ajax.reload(),e.find("#deleteCareTeamMemberModal").modal("hide")}),!1}),e.find(".cancelBtn").on("click",function(){e.find("#deleteCareTeamMemberModal").modal("hide")}),e.find("#deleteCareTeamMemberModal").modal("show"),e.find("#deleteCareTeamMemberModal").on("hidden.bs.modal",function(){$(this).remove()})})}(n,d,l.label,e)})),i.nucleusUserId&&(u.find(".videoCallCareTeamMember").removeClass("hidden"),u.find(".videoCallCareTeamMember").on("click",function(){initCall()&&startCall(i.nucleusUserId)}))}},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()}}});e?O().widgets.affiliatedPatientCareTeam=a:O().widgets.patientCareTeam=a}function U(e,t,n,a){requirejs(["app/components/care-coordination/events/IncidentReportModal"],function(t){var i=null,s={isOpen:!0,container:document.body,eventId:n,reportId:a,onHide:function(e){i.isReportChanged()&&!i.isReportChangeIgnored()&&(e.preventDefault(),bootbox.confirm({message:"The changes will not be saved",buttons:{confirm:{label:"OK"},cancel:{label:"CANCEL"}},callback:function(e){e&&(i.ignoreReportChange(),setTimeout(function(){i.hide()}))}}))},onSubmitReportSuccess:function(e){i.hide(),s.reportId=e,bootbox.confirm({message:"The updates have been saved. The pdf file sent to a mandated reporting governing body",buttons:{confirm:{label:"View pdf file"},cancel:{label:"Close"}},callback:function(e){if(e){var t=(new Date).getTimezoneOffset();window.open("ir/events/"+n+"/pdf-incident-report?timeZoneOffset="+t)}}}),X(n)},onSubmitReportFailure:function(){bootbox.alert("Cannot save the updates. Please try again later")},onSaveReportDraftSuccess:function(e){i.hide(),s.reportId=e,bootbox.confirm({message:"The incident report has been saved",buttons:{confirm:{label:"Edit"},cancel:{label:"Close"}},callback:function(e){e&&(i=new t(s)).mount()}}),X(n)},onSaveReportDraftFailure:function(){bootbox.alert("Cannot save the incident report. Please try again later")}};e.on("click",function(){(i=new t(s)).mount(),setTimeout(function(){$("#incidentReportPopup").css({display:"none"})})})})}function Z(){$("#eventDetails").hide(),O().widgets.patientEventList=p.grid(O().$html,"",{tableId:"patientEventList",totalDisplayRows:25,selectable:{type:"single"},callbacks:{rowCallback:function(e,t,n){var a=$(e);if(null!=t){var i=t.eventId;a.children("td:eq(0)").html('<div class="col-md-8">'+t.residentName+" <br/> "+t.eventType+'</div><div class="col-md-4"> '+moment(t.eventDate).format("<b>MM/DD/YYYY</b> <br/> hh:mm A")+"</div>"),a.attr("data-id",i),a.on("click",function(){X(i)}),a.css("cursor","pointer")}},drawCallback:function(e){g&&l.params&&l.params.event&&(Y("[data-id='"+l.params.event+"']").addClass("selected"),g=!1)},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()},headerCallback:function(e,t,n,a,i){$(e).hide()}}}),O().widgets.patientEventList.api().ajax.reload();var e=f.find(O().$html,"","#createNewEventContainer");f.find(O().$html,"","#createNewEvent").on("click",function(){var t=$(this);if(!t.hasClass("pending"))return t.addClass("pending"),$.ajax({url:"care-coordination/patients/patient/"+$("#currentPatientId").val()+"/event-new/",headers:{"X-Content-Compressing":"enabled"}}).success(function(n){e.empty(),e.append(n),H(e,"includeManager","includeManagerContent"),H(e,"includeResponsible","includeResponsibleContent"),H(e,"responsible.includeAddress","includeResponsibleAddressContent"),H(e,"eventDetails.followUpExpected","followUpDetailsContent"),H(e,"includeTreatingPhysician","includeTreatingPhysicianContent"),H(e,"treatingPhysician.includeAddress","includeTreatingPhysicianAddressContent"),H(e,"includeHospital","includeHospitalContent"),H(e,"treatingHospital.includeAddress","includeHospitalAddressContent"),H(e,"includeResponsible","includeResponsibleContent"),e.find('[id="eventDetails.eventDatetime"]').datetimepicker({defaultDate:new Date,format:"YYYY-MM-DD hh:mm A Z"}),e.find("#newEventForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{"employee.roleId":{required:!0},"manager.firstName":{required:!0,minlength:2,maxlength:128},"manager.lastName":{required:!0,minlength:2,maxlength:128},"manager.email":{required:!1,email:!0},"manager.phone":{required:!1,phone:!0},"responsible.firstName":{required:!0,minlength:2,maxlength:128},"responsible.lastName":{required:!0,minlength:2,maxlength:128},"responsible.address.street":{required:!0,minlength:2,maxlength:255},"responsible.address.city":{required:!0,minlength:2,maxlength:128},"responsible.address.state.id":{required:!0},"responsible.address.zip":{required:!0,positiveInteger:!0,lengthEqual:5},"eventDetails.eventDatetime":{required:!0},"eventDetails.situation":{maxlength:5e3},"eventDetails.background":{maxlength:5e3},"eventDetails.assessment":{maxlength:5e3},"eventDetails.followUpDetails":{required:!0,maxlength:5e3},"treatingPhysician.firstName":{required:!0,minlength:2,maxlength:128},"treatingPhysician.lastName":{required:!0,minlength:2,maxlength:128},"treatingPhysician.address.street":{required:!0,minlength:2,maxlength:255},"treatingPhysician.address.city":{required:!0,minlength:2,maxlength:128},"treatingPhysician.address.state.id":{required:!0},"treatingPhysician.address.zip":{required:!0,positiveInteger:!0,lengthEqual:5},"treatingPhysician.phone":{required:!1,phone:!0},"treatingHospital.name":{required:!0,minlength:2,maxlength:300},"treatingHospital.address.street":{required:!0,minlength:2,maxlength:255},"treatingHospital.address.city":{required:!0,minlength:2,maxlength:128},"treatingHospital.address.state.id":{required:!0},"treatingHospital.address.zip":{required:!0,positiveInteger:!0,lengthEqual:5},"treatingHospital.phone":{required:!1,phone:!0}},messages:{"manager.firstName":{required:getErrorMessage("field.empty")},"manager.lastName":{required:getErrorMessage("field.empty")},gender:{required:getErrorMessage("field.empty")},dateOfBirth:{dateExp:getErrorMessage("field.dateFormat"),required:getErrorMessage("field.empty")},ssn:{integer:getErrorMessage("field.integer"),lengthEqual:getErrorMessage("field.lengthEqual.4"),required:getErrorMessage("field.empty")},state:{stateUS:getErrorMessage("field.state")}}})),e.find("#createNewEventBtn").on("click",function(){var t=e.find("#newEventForm");if(!t.valid())return!1;var n=$(this);return n.hasClass("pending")||(n.addClass("pending"),$.ajax({url:t.attr("action"),data:new FormData(t[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e)},success:function(t){bootbox.alert("Event has been successfully created",function(){e.find("#createNewEventModal").modal("hide")})},error:function(t){f.onAjaxError(t,function(){alert(t.responseText)}),e.find("#createNewEventModal").modal("hide"),n.removeClass("pending")}}).complete(function(){e.find("#createNewEventModal").hide(),O().widgets.patientEventList.api().ajax.reload()})),!1}),t.removeClass("pending"),e.find("#createNewEventModal").modal("show")}).fail(function(e){t.removeClass("pending"),alert(e.responseText)}),!1})}function X(e,t,n){$.ajax({type:"GET",url:"care-coordination/patients/patient/"+$("#currentPatientId").val()+"/events/"+e+"/event-details",headers:{"X-Content-Compressing":"enabled"}}).success(function(n){var a=f.find(O().$html,"","#eventDetails");a.empty(),a.append(n),a.show(),!0,O().widgets.patientEventNotificationList=p.grid(O().$html,"",{tableId:"patientEventNotificationList",totalDisplayRows:25,callbacks:{rowCallback:function(e,t,n){var a=$(e);t&&a.children("td:eq(0)").html(moment(t.dateTime).format("<b>MM/DD/YYYY</b> <br/> hh:mm A")),a.popover({html:!0,content:t.sentToText+" with text : "+t.details,trigger:"hover",delay:300,placement:function(){return a.addClass("hasPopover"),"top"}})},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()}}}),O().widgets.patientEventNotificationList.api().ajax.reload(),a.find("#downloadBtn").on("click",function(t){$.fileDownload("care-coordination/events-log/event/"+e+"/download-pdf",{})}),a.find("#incidentReport").on("click",function(e){$("#incidentReportPopup").css({display:"flex"})}),a.on("click",function(e){$(e.target).closest("#incidentReport").length||$("#incidentReportPopup").css({display:"none"})});var i=a.find("#editIncidentReport");if(i.length){var s=i.data("reportId");U(f.find(O().$html,"","#editIncidentReport"),0,e,s)}else U(f.find(O().$html,"","#createIncidentReport"),0,e);var o=a.find("#viewIncidentReport");o.length&&o.on("click",function(t){var n=(new Date).getTimezoneOffset();window.open("ir/events/"+e+"/pdf-incident-report?timeZoneOffset="+n)}),a.find("#downloadBtn").on("click",function(t){$.fileDownload("care-coordination/events-log/event/"+e+"/download-pdf",{})}),we(f.find(O().$html,"","#addEventNote"),"care-coordination/notes/event/"+e+"/new-note","A note has been created",function(e){var t=$("#currentPatientId").val();De(t),je(e,t)}),f.find(a,O().random,".relatedNoteLink").on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),t=$(this).attr("data-ajax-url-vars"),n=$(this).attr("data-ajax-url-params"),a=f.getUrl(e,t,n);return u.route(a),!1}),t&&t()}).fail(function(e){n&&n(e)})}function Q(e,t){var n=e.api().row(t);n.nodes().to$().click(),n.nodes().to$().hasClass("selected")||n.nodes().to$().addClass("selected")}function ee(){f.find(O().$html,"","#addAssessmentResults").on("click",function(){!function(e,t,n){if(n.hasClass("pending"))return;n.addClass("pending"),$.ajax({url:"care-coordination/assessment/patient/"+t+"/new-result",headers:{"X-Content-Compressing":"enabled"}}).success(function(a){e.empty(),e.append(a),e.find("input[type='radio']").styler();var i=e.find("#addAssessmentResultModal");be(0);var s=e.find("#nextBtn"),o=f.find(O().$html,"","#assessmentModalContent"),r=f.find(O().$html,"","#assessmentModalContentSurvey");s.on("click",function(){$.ajax({url:"care-coordination/assessment/patient/"+t+"/new-assessment-data",headers:{"X-Content-Compressing":"enabled"}}).success(function(t){var n=$("input[name=assessmentId]:checked","#assessmentTypeForm").val();o.hide(),r.empty(),r.append(t),$("#assessmentIdFormField").val(n),S({employeeName:$(t).find('input[name="employeeName"]').val()}),e.find("#dateCompleted").datetimepicker({defaultDate:new Date,format:"MM/DD/YYYY hh:mm:ss A Z",maxDate:new Date}).on("dp.change",function(){S({isChanged:!0})}),e.find("#subjective").on("change",function(){S({isChanged:!0})}),he(e,i,I.ADD)})}),i.modal("show"),i.on("hidden.bs.modal",function(){$(this).remove()}),n.removeClass("pending")}).fail(function(e,t){console.log(e,t),n.removeClass("pending"),alert("Internal server error. Please contact administrator.")})}(f.find(O().$html,"","#assessmentContainer"),$("#currentPatientId").val(),$(this))})}function te(){var e=$(".sv-collapse-all-sections-btn"),t=$(".sv-expand-all-sections-btn");N.collapse===N.accordions?(e.addClass("is-disabled"),t.removeClass("is-disabled"),N.expand=0,N.collapse=N.accordions):N.expand===N.accordions?(e.removeClass("is-disabled"),t.addClass("is-disabled"),N.collapse=0,N.expand=N.accordions):(e.removeClass("is-disabled"),t.removeClass("is-disabled"))}function ne(e){return e.panelAnchors=[],N.accordions=0,e.onAfterRenderPanel.add(function(e,t){var n=document.createElement("div");if(t.panel.panelAnchor){n.id=t.panel.panelAnchor,e.panelAnchors.push(t.panel.panelAnchor);var a=t.htmlElement.querySelector("h4");null!=a&&(a.parentElement.prepend(n),$(a).addClass("assessmentAnchorPanelHead left-padding-10"))}if(t.panel.assessmentSectionAnchor){var i=$(t.htmlElement),s=i.find("h4:eq(0)");N.accordions+=1,s.addClass("accordion-header");var o=$('<div style="display: none" class="sv-anchor-panel left-padding-10">');function r(){s.find(".sv_expanded").size()>0?(o.show(),N.expand+=1,N.collapse=0===N.collapse?0:N.collapse-1):(o.hide(),N.collapse+=1,N.expand=0===N.expand?0:N.expand-1)}t.panel.css=e.panelAnchors.forEach(function(e){var t=document.createElement("a");t.className="assessment-anchors",t.text=e,t.href="#"+e,o.append(t)}),s.after(o),s.on("click",function(){r(),te()}),r(),te(),e.panelAnchors=[],i.find(".has-error").size()>0&&i.find(".accordion-header").css("border-bottom-color","red")}if(t.panel.thirdLevel){var d=t.htmlElement.querySelector("h4");$(d).addClass("third-level left-padding-10")}$(t.htmlElement).find("input[aria-label]").each(function(){var e=$(this).attr("aria-label");~["Date started"].indexOf(e)&&$(this).blur()})}),e}function ae(e,t){return e.onAfterRenderSurvey.add(function(e){var n=document.createElement("div");n.className="assessmentWzrd__tabs";var a=document.createElement("ul"),i=$(".assessmentWzrd");if(e.pages.forEach(function(e){if(0!=e.visible){var t=document.createElement("li"),n=document.createElement("a"),i=document.createElement("label");t.className="assessmentWizardLnk",n.className="ldr-ui-label ldr-head-lnk table-cell-box modal-tab modal-tab-text assessmentDetailsLnk",i.className="ldr-ui-label lnk-text",i.innerHTML=e.name,n.appendChild(i),t.appendChild(n),a.appendChild(t)}}),1==t){$("#assessmentTabHeader").hide();var s=document.createElement("li"),o=document.createElement("a"),r=document.createElement("label");s.className="assessmentWizardLnk",o.className="ldr-ui-label ldr-head-lnk table-cell-box modal-tab modal-tab-text assessmentDetailsLnk",r.className="ldr-ui-label lnk-text",r.innerHTML="Changes",o.appendChild(r),s.appendChild(o),a.appendChild(s)}a.className="nav nav-tabs no-bottom-margin wizard-nav-border",n.appendChild(a),i.prepend(n),$(a).find("li").eq(0).addClass("active")}),e}function ie(){$("#care-coordination .patientTabs").each(function(){var e=$(this);"assessmentsTab"===e.attr("id")?e.addClass("active"):e.removeClass("active")}),$("#care-coordination .patientTabContent").each(function(){var e=$(this);"patientAssessmentsContent"===e.attr("id")?e.addClass("active"):e.removeClass("active")})}function se(e){new AssessmentWizard({dom:e.find(".assessmentWzrd")}).init()}function oe(e,t,n){var a=t.find(".modal-body"),i=f.find(O().$html,"",".assessmentWzrd__tabs"),s=f.find(O().$html,"","#assessmentModalContentSurvey"),o=f.find(O().$html,"","#assessmentModalContentResults"),r=f.find(O().$html,"","#assessmentReviewContentContainer");a.removeClass("no-padding-review-modal-body"),e.find(".save-and-validate-button").show(),s.show(),o.show(),i.show(),r.hide(),e.find("#assessmentResultHeader").text(n+" "+$("#assessmentFullName").val()),e.find(".review-footer").hide()}function re(e,t,n,a,i,s,o,r){var d=a.find(".assessmentWzrd"),l=new AssessmentFooter({container:$(e),totalPages:t.pageCount,currentPage:t.currentPageNo,className:"default-footer",onBack:function(){t.currentPageNo-=1,N={accordions:0,expand:0,collapse:0}},onNext:function(){t.currentPageNo+=1,N={accordions:0,expand:0,collapse:0}},rightButtons:[{text:"REVIEW",cssClass:"btn btn-primary normalFont",onClick:function(l){s.show(),setTimeout(function(){!function(e,t,n,a,i){var s=e.find("#assessmentResultForm"),o=e.find(".modal-body"),r=f.find(O().$html,"","#assessmentModalContentSurvey"),d=f.find(O().$html,"","#assessmentModalContentResults"),l=f.find(O().$html,"","#assessmentReviewContentContainer"),c=f.find(O().$html,"",".assessmentWzrd__tabs");e.find("#assessmentResultHeader").text("Priority Questions Preview"),e.find(".save-and-validate-button").hide(),o.addClass("no-padding-review-modal-body"),l.css("min-height","300px"),d.hide(),r.hide(),c.hide(),l.empty(),setTimeout(function(){var e=function(e,t){var n=new Survey.Survey(e.toJSON());n.data=e.data,n.isSinglePage=!0,n.showProgressBar="none",Survey.surveyStrings.emptySurvey="No questions for review";var a=n.getAllQuestions();$.each(a,function(e,n){n.visible=!1,n.priorityFlag&&n.value&&(t===M.EDIT&&(n.visible=!0),a[e-1].visible=!0)}),t===M.EDIT?n=fe(n):n.mode="display";return n=function(e,t){return e.pageAnchors=[],e.accordionsAnchors=[],e.onAfterRenderPage.add(function(e,t){var n=$(t.htmlElement),a=$('<div class="sv-anchor-panel left-padding-10">'),i=$.uniqueSort(e.pageAnchors);t.page.css=$.each(i,function(e,t){var n=document.createElement("a");n.className="assessment-review-page-anchors",n.text=t,n.href="#"+t,a.append(n)}),n.prepend(a)}),e.onAfterRenderPanel.add(function(e,n){var a=document.createElement("div"),i=n.panel,s=i.name,o=document.createElement("div"),r=document.createElement("div");if(i.panelAnchor){var d=n.htmlElement.querySelector("h4");$(d).addClass("assessmentAnchorPanelHead font-size-16")}if(i.assessmentSectionAnchor){var l=t.getPanelByName(s).page,c=$(n.htmlElement),m=c.find("h4:eq(0)");i.expand(),m.addClass("no-pointer-events"),m.find(".sv_panel_icon").hide(),m.addClass("assessmentAnchorPanelHead"),m.parent().addClass("review-panel"),m.parent().find(".assessment-row:eq(0)").parent().addClass("review-inner-accordion-panel"),e.pageAnchors.push(l.name),e.accordionsAnchors.push(s),$(r).attr("id",l.name),$(r).text(l.name),a.id=i.assessmentSectionAnchor,c.prepend(a);var u=$.find(".review-tab-div").map(function(e){return $(e).children().filter(":eq(0)").text()});0!==u.length&&-1!==u.indexOf(l.name)||($(o).addClass("review-tab-div assessment__preview__page-anchor-panel"),$(o).prepend(r),c.before(o))}if("all"===i.parent.name&&-1!==e.pageAnchors.indexOf(s)){var f=$('<div class="sv-anchor-tab-panel">');i.css=e.accordionsAnchors.forEach(function(e){var t=document.createElement("a");t.className="assessment-anchors",t.text=e,t.href="#"+e,f.append(t)}),$(".review-tab-div").length>0&&$(".review-tab-div").filter(function(e,t){return $(t).text()===s}).append(f),e.accordionsAnchors=[]}if(i.thirdLevel){var p=n.htmlElement.querySelector("h4");$(p).addClass("third-level")}$(n.htmlElement).find("input[aria-label]").each(function(){var e=$(this).attr("aria-label");~["Date started"].indexOf(e)&&$(this).blur()})}),e}(n,e)}(n,a);return $("#resultJson").val(JSON.stringify(e)),$.ajax({url:"care-coordination/assessment/review",data:new FormData(s[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e)}}).success(function(t){l.append(t),l.css("min-height",""),e.render("#reviewContentContainer"),$("#reviewContentContainer").Survey({model:e}),l.show(),i&&i(t)}).fail(function(e){f.onAjaxError(e,function(){$("#formError").text(e.responseText)})})},50)}(n,0,t,o,function(){!function(e,t,n,a,i,s,o,r,d){t.find(".default-footer").remove(),new AssessmentFooter({container:$(e),totalPages:o.pageCount>0?o.pageCount:1,currentPage:o.currentPageNo>0?o.currentPageNo:1,className:"review-footer",hasNextBtn:!1,hasRightArrow:!1,onBack:function(){oe(t,a,d),re(e,o,t,a,n,i,r,d)},rightButtons:[{text:"COMPLETE",cssClass:"btn btn-primary normalFont",onClick:function(l){function c(e){ie(),a.css("visibility","hidden"),i.hide(!0),de(a,s,e,"CANCEL","OK")}function m(){i.hide(),c("The assessment has been completed."),s.css("visibility","hidden")}function u(){i.hide(),c("Cannot save the updates")}i.show(),setTimeout(function(){ce(t,n,a,o)?ve(o,n,A.COMPLETED,m,u):(i.hide(),oe(t,a,d),0===t.find(".default-footer").length&&re(e,o,t,a,n,i,r,d))},300)}}]}).render()}(e,n,i,a,s,d,t,o,r),s.hide()})},200)}},{text:"SAVE AND CLOSE",cssClass:"btn btn-default normalFont right-margin-24",onClick:function(e){function n(e){ie(),s.hide(),a.css("visibility","hidden"),d.css("visibility","hidden"),de(a,d,e,"BACK TO ASSESSMENT","CLOSE")}s.show(),ve(t,i,A.IN_PROCESS,function(){n("The updates have been saved")},function(){n("Cannot save the updates")})}},{html:[{"<>":"div",class:"checkbox",html:[{"<>":"label",html:[{"<>":"input",name:"markAsInactive",type:"checkbox"},{"<>":"span",text:"Mark as Inactive"}]}]}],onClick:function(e){"input"===e.event.target.tagName.toLowerCase()&&(s.show(),ve(t,i,A.INACTIVE,function(){a.modal("hide"),s.hide(),bootbox.alert("The assessment has been marked as inactive",ie)},function(){a.modal("hide"),s.hide(),bootbox.alert("Cannot mark this assessment as inactive")}))}}]});t.onCurrentPageChanged.add(function(){l.update({currentPage:t.currentPageNo})}),l.render()}function de(e,t,n,a,i){bootbox.confirm({message:n,buttons:{cancel:{className:"assessment-bootbox-btn btn-default normalFont right-margin-24",label:a},confirm:{className:"assessment-bootbox-btn btn-primary normalFont",label:i}},callback:function(n){n?e.modal("hide"):(e.css("visibility","visible"),t.css("visibility","visible")),ie()}})}function le(e,t,n,a,i,s){e.css("visibility","hidden"),$(".default-modal-footer").css("visibility","hidden"),t.css("visibility","hidden"),bootbox.confirm({message:a,buttons:{cancel:{className:"assessment-bootbox-btn btn-default normalFont right-margin-24",label:i},confirm:{className:"assessment-bootbox-btn btn-primary normalFont",label:s}},callback:function(a){a?(e.modal("hide"),P()):(e.css("visibility","visible"),n.css("visibility","visible"),t.css("visibility","visible")),ie()}})}function ce(e,t,n,a){var i=-1;return Y(".error-tab-arrow").hide(),a.checkErrorsMode="onValueChanged",a.visiblePages.forEach(function(t){t.hasErrors()&&(-1===i&&(i=t.visibleIndex),e.find(".assessmentDetailsLnk").eq(t.visibleIndex).prepend('<span class="error-tab-arrow"/>'))}),-1!==i&&(i!==a.currentPageNo&&(a.currentPageNo=i),e.find(".wizard-content").scrollTo("max",0),setTimeout(function(){a.currentPage.focusFirstErrorQuestion()})),-1===i}function me(e,t,n,a,i){var s=e.find("#assessmentTabHeader .assessmentWizardLnk");e.find(".assessmentWzrd__tabs").size()&&(s=e.find(".assessmentWzrd__tabs .assessmentWizardLnk"));var o=e.find(".default-modal-footer");function r(e){N={accordions:0,expand:0,collapse:0},e.find("a").trigger("click")}function d(e){o.find(".wzBtn").hide(),o.find(".assessment-footer__left-arrow,.assessment-footer__back-btn,.assessment-footer__next-btn,.assessment-footer__right-arrow").hide(),"Demographics"===e||"Assessment Details"===e?(o.find(".nextBtn").show(),o.find(".assessment-footer__next-btn,.assessment-footer__right-arrow").show()):(i?"Engagement"===e:"Changes"===e)||"Assessment History"===e?(o.find(".backBtn").show(),o.find(".assessment-footer__left-arrow,.assessment-footer__back-btn").show()):o.find(".assessment-footer__left-arrow,.assessment-footer__back-btn,.assessment-footer__next-btn,.assessment-footer__right-arrow").show()}o.find(".wzBtn").hide(),o.find(".backBtn").on("click",function(){r(s.filter(".active").prev())}),o.find(".assessment-footer__left-arrow,.assessment-footer__back-btn").on("click",function(){r(s.filter(".active").prev())}),o.find(".nextBtn").on("click",function(){r(s.filter(".active").next())}),o.find(".assessment-footer__next-btn,.assessment-footer__right-arrow").on("click",function(){r(s.filter(".active").next())});var l=s.filter(".active").find(".lnk-text").text().trim();n&&d(l),s.on("click","a",function(){var e=$(this).find(".lnk-text").text().trim();N={accordions:0,expand:0,collapse:0},n&&d(e),"Assessment History"===e||"Changes"===e?$('.nav-tabs a[href="#historyAssessmentTab"]').tab("show"):(n&&$('.nav-tabs a[href="#detailsAssessmentTab"]').tab("show"),t.currentPageNo=t.pagesValue.findIndex(function(t){return t.name===e})),$(this).parent().addClass("active"),$(this).parent().siblings().removeClass("active"),t.isCurrentPageHasErrors&&t.pages[t.currentPageNo].focusFirstErrorQuestion(),N.expand=0,N.collapse=0,$.each(t.currentPage.getPanels(),function(e,t){t.assessmentSectionAnchor&&t.isVisible&&(t.isCollapsed?N.collapse+=1:t.isExpanded&&(N.expand+=1))}),te()})}function ue(e){var t,n;switch(e){case"customdatepicker":t="MM/DD/YYYY hh:mm A Z",n=new Date;break;case"withoutTime":t="MM/DD/YYYY",n=new Date;break;case"noLimit":t="MM/DD/YYYY hh:mm A Z",n=!1;break;default:t="MM/DD/YYYY hh:mm A Z",n=new Date}return{format:t,maxDate:n}}function fe(e){return e.onAfterRenderQuestion.add(function(e,t){$(".questionSurvey").addClass("left-padding-10");var n=t.question,a=$(t.htmlElement);if("priority-align"===n.htmlClass){var i=a,s=i.prev();n.value&&$(t.htmlElement).find("input").prop("checked",!0),s&&(i.addClass("sv_qstn-priority-align"),s.addClass("sv_qstn-priority-question"))}if(n.calendarFlag){var o=n.inputId,r=$("#"+o),d=ue(n.calendarFlag).format,l=ue(n.calendarFlag).maxDate;r.datetimepicker({format:d,maxDate:l,useCurrent:!1,defaultDate:!1,widgetPositioning:{vertical:"bottom"}}),r.on("dp.change",function(e){t.question.value=r.val()});var c=$(t.htmlElement);c.css("position","relative"),c.prepend($('<span class="glyphicon glyphicon-calendar assessment-calendar-button"></span>'))}else if(a.find(".iradio_square-blue").find("input").toArray().length>0&&$.each(a.find(".iradio_square-blue").find("input").toArray(),function(){var e=$(this).parent(),t=$(this);"checkbox"===t.attr("type")?(e.addClass("jq-checkbox"),e.append('<div class="jq-checkbox__div"/>')):"radio"===t.attr("type")&&(e.addClass("jq-radio"),e.append('<div class="jq-radio__div"/>'))}),!n.customdatepicker)return}),e}function pe(e,t){return e.onAfterRenderPage.add(function(e,n){var a=n.page,i=$(n.htmlElement),s=$(".sv-collapse-all-sections-btn"),o=$(".sv-expand-all-sections-btn");o.on("click",function(){$.each(a.rows,function(e,t){$.each(t.elements,function(e,t){t.isPanel&&(t.expand(),N.expand+=1,N.collapse=0,$(n.htmlElement).find(".accordion-header").not(":eq(0)").css("margin-top","-1"),$(n.htmlElement).find(".accordion-header").not(":eq(0)").css("border-top","1px solid #d8d8d8"))})}),i.find(".sv-anchor-panel").show(),$(this).addClass("is-disabled"),s.removeClass("is-disabled")}),s.on("click",function(){$.each(a.rows,function(e,t){e>0&&$.each(t.elements,function(e,t){t.isPanel&&(t.collapse(),N.collapse+=1,N.expand=0,$(n.htmlElement).find(".accordion-header").not(":eq(0)").css("margin-top","0"),$(n.htmlElement).find(".accordion-header").not(":eq(0)").css("border-top","none"))})}),i.find(".sv-anchor-panel").hide(),$(this).addClass("is-disabled"),o.removeClass("is-disabled")});var r=t.find(".assessmentWzrd__tabs .assessmentWizardLnk").eq(a.visibleIndex);r.addClass("active"),r.siblings().removeClass("active")}),e}function he(e,t,n,a){var i=e.find("#assessmentResultForm"),s=$(".assessmentWzrd"),o=t.find(".modal-content"),r=t.find(".modal-footer"),d=f.initAjaxLoader(o,{loaderWillBeShown:function(){s.css("visibility","hidden"),r.css("visibility","hidden")},loaderWillBeHidden:function(){s.css("visibility","visible"),r.css("visibility","visible")}});$.ajax({url:"care-coordination/assessment/assessment-details",data:i.serialize(),type:"POST",beforeSend:function(e){f.csrf(e),d.show()},complete:function(){d.hide()},success:function(o){var r=o.scoringEnabled,l=o.type,c=e.find("#assessmentResultForm");$("#assessmentResultHeader").text(n+" "+o.name);var m,u=$("#resultJson").val();Survey.JsonObject.metaData.addProperty("questionbase","customdatepicker:boolean"),Survey.JsonObject.metaData.addProperty("questionbase","priorityFlag:boolean"),Survey.JsonObject.metaData.addProperty("questionbase","calendarFlag:text"),Survey.JsonObject.metaData.addProperty("questionbase","htmlClass:text"),Survey.JsonObject.metaData.addProperty("panel","panelAnchor:text"),Survey.JsonObject.metaData.addProperty("panel","assessmentSectionAnchor:text"),Survey.JsonObject.metaData.addProperty("panel","thirdLevel:text"),Survey.JsonObject.metaData.addProperty("page","tabKey:number"),m=o.hasNumeration?'"questionTitleTemplate": "{title}{require}",':'"questionTitleTemplate": "{no}. {title}{require}",',o.jsonContent=o.jsonContent.slice(0,1)+m+o.jsonContent.slice(1),Survey.Survey.cssType="bootstrap";var p=JSON.parse(o.jsonContent),h=new Survey.Model(p);if(h.showCompletedPage=!1,h.showNavigationButtons=!1,h.focusFirstQuestionAutomatic=!1,""!=u&&(h.data=JSON.parse(u)),h.onValueChanged.add(function(){S({isChanged:!0})}),l&&(h=ne(h=ae(h,!1)),$(".assessmentGeneral").hide(),$(".assessmentComment").hide(),$(".modal-body").removeClass("new-modal-body"),$(".assessmentWzrd").removeClass("default-assessment-wizard"),n===I.ADD&&(h.data={"Completed by":E.employeeName,"Date started":moment(h.getQuestionByName("Date started").value).format("MM/DD/YYYY hh:mm:ss a Z")}),Y(".save-and-validate-button").show()),Y(".save-and-validate-button").on("click",function(t){return d.show(),setTimeout(function(){ve(h,c,A.IN_PROCESS,function(){ce(e,0,0,h),d.hide()},function(){ce(e,0,0,h),d.hide()})},300),!1}),(h=pe(h=fe(h),e)).onComplete.add(function(e){d.show(),ve(h,c,A.COMPLETED,d.hide,d.hide),t.modal("hide")}),$("#assessmentContentContainer").Survey({model:h,css:{pageTitle:"sectionHeadSurvey",question:{mainRoot:"questionSurvey",title:"assessment-label"},panel:{title:"assessmentPanelHead"},row:"assessment-row"}}),me(e,h,!1),l){if(n===I.EDIT&&ce(e,0,0,h)){var v=q.loadTabKey(a);if(null!=v){var b=h.visiblePages.find(function(e){return e.tabKey===v});void 0!==b&&(h.currentPage=b)}}else t.on("shown.bs.modal",function(){h.currentPage.focusFirstErrorQuestion()});t.on("hide.bs.modal",function(){q.saveTabKey(i.find("#assessmentResultId").val(),h.currentPage.tabKey)}),re(".assessmentWzrd",h,e,t,c,d,M.VIEW,n),$(".default-modal-footer").remove(),se(t)}else if($("#assessmentResultForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{dateCompleted:{required:!0},comment:{maxlength:5e3}},messages:{dateCompleted:{required:getErrorMessage("field.empty")}}})),r){be(2),e.find("#nextBtnScoring").on("click",function(){!function(e,t,n,a,i){var s=e.find("#assessmentResultForm");if(n.isCurrentPageHasErrors)return setTimeout(function(){e.find(".wizard-content").scrollTo("max",0),n.currentPage.focusFirstErrorQuestion()},100),!1;if(!s.valid())return!1;var o=new Survey.Model(i);o.data=n.data,o.completeLastPage(),$("#resultJson").val(JSON.stringify(o.data)),$.ajax({url:"care-coordination/assessment/scoring",data:new FormData(s[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e),a&&a.show()}}).success(function(e){a&&a.hide(),be(3);var t=f.find(O().$html,"","#assessmentModalContentSurvey"),n=f.find(O().$html,"","#assessmentModalContentResults");t.hide(),n.empty(),n.append(e),n.show(),$("#assessmentResultHeader").text($("#assessmentShortName").val()+" Scoring"),$("#score").val($("#assessmentScore").val()),$e(O().widgets.assessmentsScoringGroupList,"assessmentsScoringGroupList")}).fail(function(e){a&&a.hide(),f.onAjaxError(e,function(){$("#formError").text(e.responseText)})})}(e,0,h,d,p)});var g=f.find(O().$html,"","#assessmentModalContentSurvey"),C=f.find(O().$html,"","#assessmentModalContentResults"),y=e.find("#backBtn"),w=e.find("#saveAssessmentResultScoring");y.on("click",function(){return be(2),C.hide(),g.show(),$("#assessmentResultHeader").text(n+" "+$("#assessmentFullName").val()),!1}),w.on("click",function(){return h.completeLastPage()&&(t.modal("hide"),le(t,s,T,"The assessment results have been submitted","CANCEL","OK")),!1})}else{be(1),e.find("#saveAssessmentResult").on("click",function(){return!!e.find("#assessmentResultForm").valid()&&(h.completeLastPage()&&(t.modal("hide"),le(t,s,T,"The assessment results have been saved","CANCEL","OK")),!1)})}var x=f.find(O().$html,"","#closeIconButton"),T=t.find(".modal-footer");x.on("click",function(){return E.isChanged?le(t,s,T,"The updates will not be saved.","CANCEL","OK"):(t.modal("hide"),P()),!1}),e.find("#cancelBtn").on("click",function(){return E.isChanged?le(t,s,T,"The updates will not be saved.","CANCEL","OK"):(t.modal("hide"),P()),!1})},error:function(e){f.onAjaxError(e,function(){alert(e.responseText)})}})}function ve(e,t,n,a,i){t.find("#resultJson").val(JSON.stringify(e.data));var s=e.getQuestionByName("Date started");s&&t.find("#dateAssigned").val(moment(s.value).format("MM/DD/YYYY hh:mm:ss a Z"));var o=t.find("#assessmentResultId");$.ajax({url:"care-coordination/assessment/assessment/"+n,data:new FormData(t[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e)}}).success(function(e){var t,n,i;O().widgets.assessmentsList.api().ajax.reload(),e&&(""===o.val()?(t=1,n=$("#assessmentsCountTabPanel"),(i=parseInt(n.html())+t)>0?n.html(i):(n.html(0),n.addClass("hidden"))):q.changeId(o.val(),e)),o.val(e),P(),a&&a()}).fail(function(e){f.onAjaxError(e,function(){$("#formError").text(e.responseText)}),i&&i()}).complete(function(){O().widgets.patientNoteList.api().ajax.reload(),O().widgets.patientEventList.api().ajax.reload(),De($("#currentPatientId").val())})}function be(e){Y(".alert").remove(),Y(".wzBtns .btn").addClass("hidden"),Y([".selectAssessmentTypeStep",".assessmentResultStep",".assessmentResultStepScoring",".assessmentScoringStep"][e]).removeClass("hidden")}function ge(e){$.ajax({type:"GET",contentType:"json",url:"care-coordination/assessment/patient/"+e+"/total",success:function(e){!function(e,t){$("#assessmentsCountTabPanel").html(e?0:t),$("#notesCountTabPanel").removeClass("hidden")}(e<=0,e)},error:function(){$("#notesCountTabPanel").addClass("hidden")}})}function Ce(e){$.ajax({type:"GET",contentType:"application/json",url:"care-coordination/patients/patient/"+e+"/service-plans/total",success:function(e){!function(e,t){$("#servicePlanCountTabPanel").html(e?0:t)}(e<=0,e)}})}function ye(){O().widgets.assessmentsList=p.grid(O().$html,"",{tableId:"assessmentsList",totalDisplayRows:25,searchFormId:"assessmentsFilterForm",order:[[2,"desc"]],callbacks:{rowCallback:function(e,t,n){var a=$(e);a.children("td:eq(5)").empty();var i=t.id;if(1==t.editable||1==t.canBeDownloaded){var s=f.find(O().$html,"","#assessmentRowActions").clone(),o="assessmentRowActions-"+n;if(s.attr("id",o),s.removeClass("hidden"),a.children("td:eq(5)").append(s),1==t.editable){var r=s.find(".editResidentAssessmentResult");r.removeClass("invisible"),r.on("click",function(){return function(e,t,n,a,i){if(!i.hasClass("pending"))i.addClass("pending"),$.ajax({url:"care-coordination/assessment/patient/"+t+"/edit-assessment-data/"+n,headers:{"X-Content-Compressing":"enabled"},beforeSend:function(){$("#loader-div").removeClass("hidden")},complete:function(){$("#loader-div").addClass("hidden")}}).success(function(t){e.empty(),e.append(t),$("#assessmentIdFormField").val(a),e.find("#dateCompleted").datetimepicker({defaultDate:new Date,format:"MM/DD/YYYY hh:mm:ss A Z",maxDate:new Date}).on("dp.change",function(){S({isChanged:!0})}),e.find("#subjective").on("change",function(){S({isChanged:!0})});var s=e.find("#addAssessmentResultModal");he(e,s,I.EDIT,n),s.modal("show"),s.on("hidden.bs.modal",function(){$(this).remove()}),i.removeClass("pending")}).fail(function(e,t){console.log(e,t),i.removeClass("pending"),alert("Internal server error. Please contact administrator.")})}(f.find(O().$html,"","#assessmentContainer"),$("#currentPatientId").val(),i,t.assessmentId,$(this)),!1})}if(1==t.canBeDownloaded){var d=s.find(".downloadResidentAssessmentResult");d.removeClass("invisible"),d.on("click",function(){return function(e,t,n,a){if(!a.hasClass("pending")){a.addClass("pending");var i={data:{timeZoneOffset:(new Date).getTimezoneOffset()},successCallback:function(){a.removeClass("pending")},failCallback:function(e){a.removeClass("pending"),R({action:"add",placeSelector:".patientInfoBody",message:e.responseText,closable:{timer:45e3,btn:!0}}),window.console.log(e)}};$.fileDownload("care-coordination/assessment/patient/"+e+"/assessment/"+t+"/download",i)}}($("#currentPatientId").val(),i,t.assessmentId,$(this)),!1})}}a.attr("style","cursor:pointer"),a.on("click",function(e){!function(e,t){if(T)return;T=!0,$.ajax({url:"care-coordination/assessment/result/"+t+"/view",headers:{"X-Content-Compressing":"enabled"},beforeSend:function(){$("#loader-div").removeClass("hidden")},complete:function(){$("#loader-div").addClass("hidden")}}).success(function(t){e.empty(),e.append(t);var n,a=e.find("#viewAssessmentResultModal"),i=$("#scoringEnabled").val(),s=$("#hasNumeration").val(),o=$("#assessmentType").val();"true"==i&&($e(O().widgets.assessmentsScoringGroupViewList,"assessmentsScoringGroupViewList"),$e(O().widgets.assessmentsHistoryViewList,"assessmentsHistoryViewList")),Survey.JsonObject.metaData.addProperty("questionbase","priorityFlag:boolean"),Survey.JsonObject.metaData.addProperty("questionbase","calendarFlag:text"),Survey.JsonObject.metaData.addProperty("questionbase","htmlClass:text"),Survey.JsonObject.metaData.addProperty("panel","panelAnchor:text"),Survey.JsonObject.metaData.addProperty("panel","assessmentSectionAnchor:text"),Survey.JsonObject.metaData.addProperty("panel","thirdLevel:text"),Survey.JsonObject.metaData.addProperty("page","tabKey:number"),n=s?'"questionTitleTemplate": "{title}{require}",':'"questionTitleTemplate": "{no}. {title}{require}",';var r=$("#residentAssessmentResult").val(),d=$("#residentAssessmentContent").val();Survey.Survey.cssType="bootstrap",Survey.JsonObject.metaData.addProperty("panel","anchors:text"),d=d.slice(0,1)+n+d.slice(1);var l=JSON.parse(d),c=new Survey.Model(l);c.showCompletedPage=!1,c.showNavigationButtons=!1,c.mode="display","true"==o&&(c.pages.splice(0,1),c=ne(c=ae(c,!0)),$("#assessmentViewSectionName").hide(),$(".assessmentGeneral").hide(),$(".assessmentComment").hide(),$(".modal-body").removeClass("new-modal-body"),$(".assessmentWzrd").removeClass("default-assessment-wizard"),se(a),e.find(".up-scroller").css({bottom:"10px",right:"40px"})),(c=pe(c=fe(c),e)).data=JSON.parse(r),$("#assessmentContentViewContainer").Survey({model:c,css:{pageTitle:"sectionHeadSurvey",question:{mainRoot:"questionSurvey",title:"assessment-label"},panel:{title:"assessmentPanelHead"},row:"assessment-row"}}),a.modal("show"),a.on({"hide.bs.modal":function(){$(this).remove()},"shown.bs.modal":function(){$('.nav-tabs a[href="#detailsAssessmentTab"]').tab("show"),me(e,c,!0)}}),$('.nav-tabs a[href="#historyAssessmentTab"]').on("shown.bs.tab",function(){O().widgets.assessmentsHistoryViewList=p.grid(O().$html,"",{tableId:"assessmentsHistoryViewList",totalDisplayRows:25,sort:!1,callbacks:{rowCallback:function(e,t,n){var a=$(e);a.children("td:eq(3)").empty();var i=t.id;if(0!==n){var s=f.find(O().$html,"","#assessmentHistoryRowActions").clone(),o="assessmentHistoryRowActions-"+n;s.attr("id",o),s.removeClass("hidden"),a.children("td:eq(3)").append(s),s.find(".seeHistoryLink").on("click",function(){return e=f.find(O().$html,"","#assessmentHistoryViewContainer"),t=i,T||(T=!0,$.ajax({url:"care-coordination/assessment/result/"+t+"/history/view",headers:{"X-Content-Compressing":"enabled"}}).success(function(t){e.empty(),e.append(t);var n=e.find("#viewAssessmentResultModal");f.find(O().$html,"","#assessmentViewContainer").hide();var a,i=$("#scoringEnabled").val(),s=$("#hasNumeration").val(),o=$("#assessmentType").val();"true"===i&&$e(O().widgets.assessmentsScoringGroupViewHistoryList,"assessmentsScoringGroupViewHistoryList"),Survey.JsonObject.metaData.addProperty("questionbase","priorityFlag:boolean"),Survey.JsonObject.metaData.addProperty("questionbase","calendarFlag:text"),Survey.JsonObject.metaData.addProperty("questionbase","htmlClass:text"),Survey.JsonObject.metaData.addProperty("panel","panelAnchor:text"),Survey.JsonObject.metaData.addProperty("panel","assessmentSectionAnchor:text"),Survey.JsonObject.metaData.addProperty("panel","thirdLevel:text"),Survey.JsonObject.metaData.addProperty("page","tabKey:number"),a=s?'"questionTitleTemplate": "{title}{require}",':'"questionTitleTemplate": "{no}. {title}{require}",';var r=$(t).find("#residentAssessmentResult").val(),d=$(t).find("#residentAssessmentContent").val();d=d.slice(0,1)+a+d.slice(1),Survey.Survey.cssType="bootstrap";var l=JSON.parse(d),c=new Survey.Model(l);c.showCompletedPage=!1,c.showNavigationButtons=!1,c.mode="display",c.data=JSON.parse(r),"true"==o&&(c.pages.splice(0,1),c=ne(c=function(e){return e.onAfterRenderSurvey.add(function(e){var t=document.createElement("div");t.className="assessmentWzrd__tabs";var n=document.createElement("ul"),a=$(".assessmentWzrdHistory");e.pages.forEach(function(e){if(0!=e.visible){var t=document.createElement("li"),a=document.createElement("a"),i=document.createElement("label");t.className="assessmentWizardLnk",a.className="ldr-ui-label ldr-head-lnk table-cell-box modal-tab modal-tab-text assessmentDetailsLnk",i.className="ldr-ui-label lnk-text",i.innerHTML=e.name,a.appendChild(i),t.appendChild(a),n.appendChild(t)}}),n.className="nav nav-tabs no-bottom-margin wizard-nav-border",t.appendChild(n),a.prepend(t),$(n).find("li").eq(0).addClass("active")}),e}(c)),$("#assessmentViewSectionNameHistory").hide(),$("#assessmentGeneralHistory").hide(),$("#assessmentCompletedByHistory").hide(),$(".assessmentComment").hide(),$(".modal-body").removeClass("new-modal-body"),$(".assessmentWzrd").removeClass("default-assessment-wizard"),se(n),e.find(".up-scroller").css({bottom:"10px",right:"40px"})),c=pe(c=fe(c),e),$("#assessmentContentHistoryViewContainer").Survey({model:c,css:{pageTitle:"sectionHeadSurvey",question:{mainRoot:"questionSurvey",title:"assessment-label"},panel:{title:"assessmentPanelHead"},row:"assessment-row"}}),n.modal("show"),me(e,c,!0,0,!0),n.on({"hide.bs.modal":function(){$(this).remove(),$('.nav-tabs a[href="#historyAssessmentTab"]').tab("show"),f.find(O().$html,"","#assessmentViewContainer").show()}}),e.find("#cancelBtn").on("click",function(){n.modal("hide"),f.find(O().$html,"","#assessmentViewContainer").show()}),T=!1}).fail(function(e,t){console.log(e,t),T=!1,alert("Internal server error. Please contact administrator.")})),!1;var e,t})}a.attr("style","cursor:pointer")},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()}}})}),e.find(".assessment-footer__left-arrow, assessment-footer__back-btn").hide(),e.find("#cancelBtn").on("click",function(){a.modal("hide")}),T=!1}).fail(function(e,t){console.log(e,t),T=!1,alert("Internal server error. Please contact administrator.")})}(f.find(O().$html,"","#assessmentViewContainer"),i)})},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()}}}),$("#searchAssessments").on("click",function(){return O().widgets.assessmentsList.api().ajax.reload(),!1}),O().widgets.assessmentsList.api().ajax.reload()}function $e(e,t){p.grid(O().$html,"",{tableId:t,totalDisplayRows:25,paginate:!1,sort:!1,callbacks:{rowCallback:function(e,t,n){},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()}}}).api().ajax.reload()}function we(e,t,n,a){var i=f.find(O().$html,"","#noteContainer");e.on("click",function(){var e=$(this);if(!e.hasClass("pending"))return e.addClass("pending"),$.ajax(t).success(function(t){i.empty(),i.append(t),i.find('[id="lastModifiedDate"]').datetimepicker({defaultDate:new Date,format:"YYYY-MM-DD hh:mm A Z",maxDate:new Date}),i.find('[id="encounterDate"]').datetimepicker({defaultDate:new Date,format:"MM/DD/YYYY"}),i.find('[id="from"]').timepicker({timeFormat:"h:mm p",interval:30,minTime:"00",maxTime:"11:30pm",defaultTime:xe(i,new Date),startTime:"12:00am",dynamic:!1,dropdown:!0,scrollbar:!0}),i.find('[id="to"]').timepicker({timeFormat:"h:mm p",interval:30,minTime:"00",maxTime:"11:30pm",defaultTime:xe(i,new Date),startTime:"12:00am",dynamic:!1,dropdown:!0,scrollbar:!0}),i.find("#timeZoneOffset").val((new Date).getTimezoneOffset());var s=i.find("#subTypeId"),o=i.find("#noteResidentAdmittanceHistoryDtoId"),r=i.find("#from"),d=i.find("#to");Te(i),r.on("blur",function(){window.setTimeout(function(){Te(i,!0)},500)}),d.on("blur",function(){window.setTimeout(function(){Te(i,!1)},500)}),s.on("change",function(){var e=$(this).find(":selected");$.inArray(e.attr("data-encounter-code"),x)>=0?(o.attr("disabled","disabled"),i.find("#encounter-note-type-content").show()):i.find("#encounter-note-type-content").hide()}),1===o.children("option").length?(o.attr("disabled","disabled"),s.find("[data-follow-up-code]").attr("disabled","disabled"),s.find("[data-follow-up-code]").attr("title",'Please add the admittance information or the intake date on the "Patient Details" screen')):(s.on("change",function(){var e=$(this).find(":selected");-1===$.inArray(e.attr("data-follow-up-code"),w)?(o.prop("selectedIndex",0),o.attr("disabled","disabled"),o.blur(),s.children("option").removeAttr("disabled"),s.children("option").removeAttr("title")):(o.removeAttr("disabled"),o.children("option").removeAttr("title"),$.ajax("care-coordination/notes/patient/"+$("#currentPatientId").val()+"/followUp/"+e.attr("data-follow-up-code")+"/getTaken").success(function(t){o.children("option").removeAttr("disabled"),t.forEach(function(t){o.val()==t&&o.prop("selectedIndex",0);var n=o.find("[value="+t+"]");n.attr("disabled","disabled"),n.attr("title",'"'+e.text()+'" note has been already created for this admit/intake date.')})}))}),o.on("change",function(){var e=s.children("option");e.removeAttr("disabled"),e.removeAttr("title"),$(this).val()&&$.ajax("care-coordination/notes/patient/"+$("#currentPatientId").val()+"/admit/"+$(this).val()+"/getTaken").success(function(e){e.forEach(function(e){s.find(":selected").attr("data-follow-up-code")===e&&s.prop("selectedIndex",0);var t=s.find("[data-follow-up-code="+e+"]");t.attr("disabled","disabled"),t.attr("title",'"'+t.text()+'" note has been already created for this admit/intake date.')})})})),i.find("#noteForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{subjective:{required:function(e){return $("#objective").is(":blank")&&$("#assessment").is(":blank")&&$("#plan").is(":blank")},maxlength:2e4},objective:{maxlength:2e4},assessment:{maxlength:2e4},plan:{maxlength:2e4},clinicianCompletingEncounter:{maxlength:256},lastModifiedDate:{required:!0},"subType.id":{required:!0},"noteResidentAdmittanceHistoryDto.id":{required:function(e){return!e.disabled}},encouterNoteTypeId:{required:!0},encounterDate:{required:!0},from:{required:!0},to:{required:!0}},messages:{subjective:{required:getErrorMessage("field.empty")},lastModifiedDate:{required:getErrorMessage("field.empty")},"subType.id":{required:getErrorMessage("field.empty")},"noteResidentAdmittanceHistoryDto.id":{required:getErrorMessage("field.empty")},encouterNoteTypeId:{required:getErrorMessage("field.empty")},encounterDate:{required:getErrorMessage("field.empty")},from:{required:getErrorMessage("field.empty")},to:{required:getErrorMessage("field.empty")}}})),i.find("#submitNoteBtn").on("click",function(){var e=i.find("#noteForm");if(!e.valid())return!1;var t=$(this);return t.hasClass("pending")||(t.addClass("pending"),$.ajax({url:e.attr("action"),data:new FormData(e[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e)},success:function(e){i.find("#noteModal").modal("hide"),bootbox.alert(n,function(){void 0!==a&&a(e)})},error:function(e){i.find("#noteModal").modal("hide"),f.onAjaxError(e,function(){alert(e.responseText)}),t.removeClass("pending")}})),!1}),e.removeClass("pending"),i.find("#noteModal").modal("show")}).fail(function(t){e.removeClass("pending"),alert(t.responseText)}),!1})}function xe(e,t){if(""==e.find("#from")[0].value&&""==e.find("#to")[0].value){var n=t.getMinutes(),a=t;if(0!=n){var i=n>30?60-n:30-n;a=new Date(t.getTime()+6e4*i)}return function(e){var t=e.getHours(),n=e.getMinutes(),a=t>=12?"pm":"am";return(t=(t%=12)||12)+":"+(n=n<10?"0"+n:n)+" "+a}(a)}}function Te(e,t){var n=e.find("#from"),a=e.find("#to"),i=e.find("#totalTimeSpent"),s=e.find("#range"),o=e.find("#unit"),r=moment(n.val(),"hh:mm A");t&&(d=moment(r).add(30,"minutes").format("h:mm A"),a.val(d));var d=moment(a.val(),"hh:mm A"),l=moment.duration(d.diff(r)).asMinutes();l<1&&(d=moment(r).add(30,"minutes").format("h:mm A"),a.val(d),l=30),i.val(l);var c=Math.floor(l/15);l%15>7&&(c+=1);var m=15*c-7,u=15*c+7;m<0&&(m=0),s.val(m+" mins - "+u+" mins"),o.val(c)}function ke(e,t){$.ajax({type:"GET",contentType:"json",url:"care-coordination/notes/patient/"+e+"/total",success:function(e){t(e<0?0:e)},error:function(){$("#notesCountTabPanel").addClass("hidden")}})}function De(e,t,n){r=0,ke(e,function(e){r=e,Ee(e)})}function Ee(e){var t=$("#notesCountTabPanel");t.html(e),t.removeClass("hidden")}function Se(){O().widgets.patientsList=L({tableId:"patientsList",searchFormId:"patientsFilter",totalDisplayRows:25,colSettings:{},order:[[1,"asc"],[0,"asc"]],callbacks:{rowCallback:function(e,t,n){var a=$(e),i=t.id;a.css("cursor","pointer"),a.on("click",function(){Ne(i,t)}),t.active||(a.css("color","silver"),a.children("td:eq(0)").css("color","rgb(165, 200, 200)"));var s=a.children("td:eq(8)");if(s.empty(),t.hasMerged){var o=$('<a class="showMergedLink">Show Matches</a>');s.on("click",function(){return function(e,t){var n=$("[data-merged-id='"+e+"']"),a=t.find(".showMergedLink"),i=Y("#showDeactivated").val();0==n.length?$.ajax({url:"care-coordination/patients/patient/"+e+"/getMergedPatients/"+i,type:"GET"}).success(function(n){for(var i=0;i<n.length;i++){var s=$('<tr class="mergedResident" data-id="'+n[i].id+'" data-merged-id="'+e+'"><td>'+n[i].firstName+"</td><td>"+n[i].lastName+"</td><td>"+(n[i].gender?n[i].gender:"")+"</td><td>"+n[i].birthDate+"</td><td>"+n[i].ssn+"</td><td>"+n[i].eventCount+"</td><td>"+n[i].community+"</td><td>"+(n[i].dateCreated?n[i].dateCreated:"")+"</td><td></td></tr>");s.insertAfter(t),s.on("click",function(){Ne($(this).data("id"))}),n[i].active||(s.css("color","silver"),s.children("td:eq(0)").css("color","rgb(165, 200, 200)")),t.hasClass("even")?s.addClass("even"):s.addClass("odd")}t.addClass("hasMergedResidents"),a.text("Hide Matches")}).fail(function(e){alert(e.responseText)}):(n.remove(),a.text("Show Matches"),t.removeClass("hasMergedResidents"))}(t.id,a),!1}),s.append(o)}},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()}}}),O().widgets.patientsList.api().ajax.reload(),s=ExchangeApp.modules.Header.getCurrentOrganizationFilter(),o=ExchangeApp.modules.Header.getCurrentCommunityFilter()}function Pe(e,t,n){$.ajax({type:"GET",contentType:"json",url:"patient-info/"+e+"/documents/"+!0+"/total?hashKey="+t+"&databaseId="+n,success:function(e){!function(e,t){$("#documentsCountTabPanel").html(e?0:t),$("#documentsCountTabPanel").removeClass("hidden")}(e<=0,e)},error:function(){$("#documentsCountTabPanel").addClass("hidden")}})}function Ae(e){var t=$("#documentsCountTabPanel"),n=parseInt(t.html())+e;n>0?t.html(n):(t.html(0),t.addClass("hidden"))}function Ie(e,t){for(var n=["allergies","medications","problems","procedures","results","encounters","advanceDirectives","familyHistory","vitalSigns","immunizations","payerProviders","medicalEquipment","socialHistory","planOfCare"],a=0;a<n.length;a++)Me(n[a],e,t);$('[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href")).parent();return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1}),$(".ccdDetailItem .collapse, .ccdHeaderDetails .collapse").on("show.bs.collapse",function(){var n=$(this),a=n.attr("href"),i=$(this).find(".clp-pnl-content");if($('[href*="'+n.attr("id")+'"]').hasClass("disabled"))return!1;if(a){var s=n.attr("id");$.get(a,function(n,a,o){var r=$(n);O();i.html(r);var d=s+"List";O().widgets[d]=p.grid(O().$html,"",{tableId:d,totalDisplayRows:15,colSettings:{plannedActivity:{bSortable:!0,customRender:function(e,t,n){return e?n.isFreeText?'<a href="narrative/ccd/'+s+"/"+n[D[s]]+"/"+e+'" id="'+s+"-name-free-text"+n.id+'" target="_blank" rel="nofollow noopener">'+e+"</a>":e:""}},name:{bSortable:!0,customRender:function(e,t,n){return e?n.viewable?'<a href="#" id="'+s+"-name-"+n.id+'" data-observation-id="'+n[D[s]]+'">'+e+"</a>":e:""}},dataSource:{customRender:function(e,t,n){return e?!0===n.manual?"<span>Simply Connect HIE</span>":'<a href="#" id="problems-source-'+n.id+'" onclick="return false" class="dataSourceCol">'+e+"</a>":""}},supportingDocuments:{bSortable:!1,customRender:function(e){return e?e.split("|").reduce(function(e,t,n){return e+(0==n?"":", ")+'<a href="'+t+'">Advance Directive</a>'},""):""}},actions:{width:"100px",className:"actionsColumn"}},callbacks:{rowCallback:function(n,a,i){var o=$(n);!function(e,t,n,a,i){if(!e)return;var s=$("#dataSourceDetailsTemplate").clone(),o="dataSourceDetailsTemplate-"+e.id;s.attr("id",o),s.removeClass("hidden"),$(e).popover({html:!0,content:s[0],trigger:"hover",placement:function(){return"bottom"}});var r={dataSourceName:t,dataSourceOID:n,communityName:a,communityOID:i};for(var d in r)r[d]?s.find("#"+d).text(r[d]):s.find("#"+d+"Layout").hide()}(o.find("#problems-source-"+a.id)[0],a.dataSource,a.dataSourceOid,a.community,a.communityOid);o.children("td.actionsColumn").empty();var r=f.find(O().$html,"","#ccdRowActions").clone();if(!0===a.editable||!0===a.deletable){var d="ccdRowActions-"+i;if(r.attr("id",d),r.removeClass("hidden"),o.children("td.actionsColumn").append(r),!0===a.editable){var l=r.find(".editCcd");l.removeClass("hidden"),l.on("click",function(){return Re.call(this,{sectionName:s,mode:"edit",residentId:e,hashKey:t,id:a[D[s]]}),!1})}if(!0===a.deletable){var c=r.find(".deleteCcd");c.removeClass("hidden"),c.on("click",function(){return bootbox.confirm({title:"Delete the record?",message:"The record will be deleted.",buttons:{cancel:{label:"Cancel"},confirm:{label:"Ok"}},callback:function(n){n&&$.ajax({url:"patient-info/"+e+"/ccd/"+s+"/delete/"+a[D[s]]+"?hashKey="+t,data:"",type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){f.csrf(e)},success:function(e){bootbox.alert("The record has been deleted")},error:function(e){f.onAjaxError(e,function(){alert(e.responseText)})}})}}),!1})}}!0===a.viewable&&!0==!a.isFreeText&&o.on("click",function(n){Re.call(this,{sectionName:s,mode:"view",residentId:e,hashKey:t,id:a[D[s]]}),n&&n.preventDefault()})},footerCallback:function(e,t,n,a,i){$(e).hide()}}}),r.find(".addCcdLink").on("click",function(n){Re.call(this,{sectionName:s,mode:"add",residentId:e,hashKey:t}),n&&n.preventDefault()})})}}),$("#openAllBtn, #closeAllBtn").on("click",function(){$("#openAllBtn, #closeAllBtn").toggleClass("hidden");var e=$(this).attr("id").indexOf("openAllBtn")>=0?"show":"hide";$(".ccdDetailItem .collapse").collapse(e)}),$("[data-section-name]").on("click",function(n){Re.call(this,{sectionName:$(this).attr("data-section-name"),mode:"add",residentId:e,hashKey:t}),n&&n.preventDefault()}),$(".jumpLnk").on("click",function(){var e=$(this).attr("href");$(e).collapse("show")})}function Me(e,t,n){var a="patient-info/"+t+"/ccd/"+e+"/"+!0+"/total?hashKey="+n;$.ajax({type:"GET",contentType:"json",url:a,success:function(t){var n=t<=0,a=$("#"+e+"CollapsedPanel .badge");a.find(".badgeValue").html(n?0:t),a.toggleClass("hidden",n),$("#"+e+"CollapsedPanel").toggleClass("disabled",n)},error:function(){$("#"+e+"CollapsedPanel .badge").addClass("hidden")}})}function Ne(a,i,s,o,r){u.route({template:"care-coordination/patients/"+a+"/details"}),(n=ExchangeApp.utils.patientccd).init(O,L,R,l,!0);var d=i?i.hashKey:null,c=i?i.organizationId:null;e=null,t=null,$.ajax({url:"care-coordination/patients/patient/"+a+"/details",headers:{"X-Content-Compressing":"enabled"}}).success(i,function(e){if(o||!Y("#patientsContent").is(":hidden")){Y("#patientsContent").hide();var t=Y("#patientDetailsContent");t.hide(),t.empty(),t.append(e),t.show(),f.find(O().$html,"",".patientTabs").on("click",function(){var e=$(this).attr("id"),t="care-coordination/patients/"+a;"patientDetailsTab"===e&&(t+="/details"),"patientEventsTab"===e&&(t+="/events"),"ccdDetailsTab"===e&&(t+="/ccd-details"),"documentsTab"===e&&(t+="/documents"),"notesTab"===e&&(t+="/notes"),"assessmentsTab"===e&&(t+="/assessments"),"servicePlansTab"===e&&(O().widgets.servicePlanListPanel.update(),t+="/service-plans"),u.route({template:t})}),function(e){f.find(O().$html,"",".patientTabs").on("click",function(){var e=$(this),t=e.find("a").attr("href");l.params&&(l.params.note&&"#patientNotesContent"!==t||l.params.event&&"#patientEventsContent"!==t)&&u.route({template:l.template})}),f.find(O().$html,"",".backToPatientList").on("click",function(){Y("#patientDetailsContent").hide(),Y("#patientsContent").show()});var t=f.find(O().$html,"","#createCareTeamContainer");f.find(O().$html,"","#createCareTeamMember").on("click",function(){K(t,null,null,null,null,!1,$(this))}),f.find(O().$html,"","#createAffiliatedCareTeamMember").on("click",function(){K(t,null,null,null,null,!0,$(this))}),t=f.find(O().$html,"","#editPatientContainer"),f.find(O().$html,"","#editPatient").on("click",function(){B(t,e,$(this))});var n=f.find(O().$html,"","#deactivateRecord");n.on("click",function(){return $.ajax({url:"care-coordination/patients/patient/"+e+"/toggle-activation",type:"POST",beforeSend:function(e){f.csrf(e)}}).success(function(e){var t=f.find(O().$html,"","#activationAlert");e?(n.text("DEACTIVATE RECORD"),t.text("This record has been activated.")):(n.text("ACTIVATE RECORD"),t.text("This record has been deactivated.")),t.show()}).fail(function(e){f.onAjaxError(e,function(){bootbox.alert(e.responseText)})}),!1});var a=$(".patientDetailsCcdLink");if(a.length>0){var i=a.attr("data-ajax-url-tmpl"),s=a.attr("data-ajax-url-vars"),o=a.attr("data-ajax-url-params");a.on("click",function(){var e=f.getUrl(i,s,o);if("patient-search"==i)u.reload(e);else{u.route(e),$.each($(".baseHeader .ldr-head-lnk.active"),function(){$(this).removeClass("active"),$(this).removeClass("bottom")});var t=$(".baseHeader .ldr-head-lnk.personalHealthRecordLnk ");t.addClass("active bottom")}return!1})}}(a),null===d&&(d=t.find("#hashKey").val()),null===c&&(c=t.find("#organizationId").val()),Pe(a,d,c),De(a),ge(a),Ce(a),Ie(a,d),G(!1),G(!0),Z(),$("#noteDetails").hide(),O().widgets.patientNoteList=p.grid(O().$html,"",{tableId:"patientNoteList",totalDisplayRows:25,selectable:{type:"single"},callbacks:{rowCallback:function(e,t,n){var a=$(e);if(null!=t){var i=t.noteId;a.children("td:eq(0)").html('<div class="col-md-8">'+t.type+" <br/> "+t.status+'</div><div class="col-md-4"> '+moment(t.lastModifiedDate).format("<b>MM/DD/YYYY</b> <br/> hh:mm A")+"</div>"),a.attr("data-id",i),a.on("click",function(){Le(i)}),a.css("cursor","pointer")}},drawCallback:function(e){b&&(Y("[data-id='"+C+"']").addClass("selected"),y&&l.params&&C!=l.params.note&&$("#historyNoteId-"+l.params.note).click(),y=!1,b=!1)},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()},headerCallback:function(e,t,n,a,i){$(e).hide()},initComplete:function(e,t){void 0!==t.content&&t.content.length>0&&(void 0===l.params||void 0===l.params.note)&&Q(O().widgets.patientNoteList,0)}}}),we(f.find(O().$html,"","#addNote"),"care-coordination/notes/patient/"+$("#currentPatientId").val()+"/new-note","A note has been created",function(e){var t=$("#currentPatientId").val();De(t),je(e,t)}),ee(),ye(),J({container:f.find(O().$html,"","#patientServicePlansContent")}),n.initCompanyName();var i="patient-info/"+a+"/documents/";n.initDocumentList(a,c,d,!0,i,function(e){return p.grid(O().$html,"",e)});var m=$("#deleteDocumentUrl").attr("href")+a+"/";n.setDocumentListPanelEvents(a,c,d,m,!0,Ae,!0,"composeMsgBtnCC"),n.initUploadForm(a,c,d,"#care-coordination",m,Ae),s&&$("#newlyCreatedAlert").show(),$(".draggableBox").draggable({containment:"window",handle:".boxHeader",cursor:"move",opacity:.35,iFrameFix:!0}),f.find(O().$html,"","#videoCallLink").on("click",function(){return initCall()&&startCall(),!1});var h=0;f.find(O().$html,"","#testIncomingCall").on("click",function(){var e=$.notify({icon:"resources/images/incoming-call.png",title:"Tommy Walker",message:"Incoming call"},{element:"body",type:"info",allow_dismiss:!1,newest_on_top:!1,showProgressbar:!1,placement:{from:"bottom",align:"right"},offset:20,spacing:10,z_index:1061,delay:0,animate:{enter:"animated fadeInUp",exit:"animated fadeOutDown"},icon_type:"image",template:'<div id="growl-'+ ++h+'" data-notify="container" class="col-xs-11 col-sm-6 col-md-3 alert alert-{0} nucleus-incoming-call" role="alert"><button type="button" aria-hidden="true" class="close" data-notify="dismiss"></button><div class="ldr-ui-layout row">   <div class="ldr-ui-layout col-sm-6 col-xs-6" style="/*background-color: dimgrey*/">       <div class="ldr-ui-layout title-container"><span data-notify="title">{1}</span></div>       <div class="ldr-ui-layout message-container">           <span data-notify="icon"></span> <span data-notify="message">{2}</span>       </div>   </div>   <div class="ldr-ui-layout col-md-offset-2 col-sm-offset-1 col-xs-offset-1 col-sm-4 col-xs-4" style="/*background-color: darkgreen;*/ padding: 0">       <div class="ldr-ui-layout row" style="/*background-color: green;*/">       <div class="ldr-ui-layout col-sm-6 col-xs-6" style="/*background-color: darkblue;*/ padding: 0">           <a role="button" class="ldr-ui-btn btn answer-call-with-video"><img src="resources/images/answer-call-with-video.png"/></a>       </div>       <div class="ldr-ui-layout col-sm-6 col-xs-6" style="/*background-color: darkred;*/ padding: 0">           <a role="button" class="ldr-ui-btn btn decline-call"><img src="resources/images/end-cancel-call.png"/></a>       </div></div>   </div>   <div class="progress" data-notify="progressbar">       <div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0;"></div>   </div></div><a href="{3}" target="{4}" data-notify="url"></a></div>'}),t=$("#growl-"+h);return t.find("a.answer-call-with-video").click(function(){initCall()&&e.close()}),t.find("a.decline-call").click(function(){e.close()}),!1}),void 0!==r&&r()}})}function qe(e,t){y=!0,$.ajax({url:"care-coordination/notes/"+e+"/latest"}).success(function(e){je(e,t)})}function je(e,t){Le(e,function(){$('[href="#patientNotesContent"]').click(),C=e,$.ajax({url:"care-coordination/notes/patient/"+t+"/"+C+"/page-number"}).success(function(e){b=!0,O().widgets.patientNoteList.api().page(e).draw(!1)})})}function Le(e,t){var n=/historyNoteId-(\d+)/;$.ajax({url:"care-coordination/notes/"+e+"/note-details?timeZoneOffset="+(new Date).getTimezoneOffset(),headers:{"X-Content-Compressing":"enabled"}}).success(function(a){var i=f.find(O().$html,"","#noteDetails");i.hide(),i.empty(),i.append(a),i.show(),we(f.find(O().$html,"","#editNote"),"care-coordination/notes/"+e+"/edit?timeZoneOffset="+(new Date).getTimezoneOffset(),"A note has been updated",function(e){je(e,$("#currentPatientId").val())}),$.each(O().$html.find(".viewNoteLink"),function(e,t){var a=n.exec(t.id)[1];we($(t),"care-coordination/notes/"+a+"/view")}),f.find(O().$html,"","#relatedEventId").on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),t=$(this).attr("data-ajax-url-vars"),n=$(this).attr("data-ajax-url-params"),a=f.getUrl(e,t,n);return u.route(a),!1}),void 0!==t&&t()})}function Re(e){if(void 0!==k[e.sectionName]){var t=f.find(O().$html,"","#ccdContainer"),n=$(this);if(!n.hasClass("pending")){n.addClass("pending");var a="patient-info/"+e.residentId+"/ccd/"+e.sectionName+"/"+e.mode;return"view"!==e.mode&&"edit"!==e.mode||(a+="/"+e.id),a+="?hashKey="+e.hashKey,$.ajax({url:a,headers:{"X-Content-Compressing":"enabled"}}).success(function(a){t.empty(),t.append(a),k[e.sectionName](t,e),n.removeClass("pending"),$(window).resize(function(){t.find(".modal-body").css({"max-height":$(window).height()-220})}),$(window).trigger("resize"),t.find("#"+e.sectionName+"CcdModal").modal("show")}).fail(function(e){n.removeClass("pending"),alert(e.responseText)}),!1}}}return $.fn.serializeObject=function(){var e={},t=this.serializeArray();return $.each(t,function(){void 0!==e[this.name]?(e[this.name].push||(e[this.name]=[e[this.name]]),e[this.name].push(this.value||"")):e[this.name]=this.value||""}),e},{init:function(e,t){l=e,a=t,this.loadFragment({onFragmentLoaded:function(){j()},onResourcesLoaded:function(){var e=O();e.widgets={},Se(),this.setEvents(),e.inited=!0,this.render(),this.show()}})},update:function(e){s==ExchangeApp.modules.Header.getCurrentOrganizationFilter()&&JSON.stringify(o)==JSON.stringify(ExchangeApp.modules.Header.getCurrentCommunityFilter())||ExchangeApp.routers.ModuleRouter.reload(),l=e},getFragment:function(e){return d[_(e,{params:!0})]},isFragmentInited:function(e){var t=this.getFragment(e);return t&&t.inited},loadFragment:function(e){var t=this;h.load({url:l,callbacks:{onFragmentLoaded:function(n){c.reloadNeeded=!1;var a=$(n).find("#content").children(),i=_(l,{params:!0});d[i]={$html:a,url:f.clone(l)},e.onFragmentLoaded.apply(t)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(t)}}})},render:function(){var e=O().$html;F().empty(),F().append(e)},hide:function(){$.each($("#care-coordination").find(".patientTabs"),function(){if($(this).hasClass("active")){switch($(this).attr("id")){case"patientDetailsTab":e="patientDetailsInfoContent";break;case"patientEventsTab":l.params&&l.params.event||(e="patientEventsContent");break;case"ccdDetailsTab":e="patientCCDContent";break;case"documentsTab":e="patientDocumentsContent";break;case"notesTab":l.params&&l.params.note||(e="patientNotesContent")}$(this).children("a").blur()}}),$.each($("#care-coordination").find(".patientEventTabs"),function(){if($(this).hasClass("active"))switch($(this).attr("id")){case"patientEventsDescriptionTab":t="patientEventsDescriptionContent";break;case"patientSentNotificationsTab":t="patientSentNotificationsContent"}}),F().hide(),$("#content").addClass("loading")},show:function(){if(void 0!==O()&&O().inited){0==$("#content").find(".tab-pane:visible").length&&($.each($("#care-coordination").find(".nav li"),function(){$(this).removeClass("active")}),$('a[data-target^="#'+m+'"]').parent("li").addClass("active"),F().show());var n=$("#currentPatientId").val();if(void 0!==n&&ke(n,function(e){e!==r&&(r=e,Ee(e),O().widgets.patientNoteList.api().ajax.reload(function(){Q(O().widgets.patientNoteList,0)}))}),l.params){if(l.params.note&&l.params.patient){var a=l.params.note,i=l.params.patient;$("#currentPatientId").val()==i?qe(a,i):Ne(i,null,!1,!0,function(){qe(a,i)})}else if(l.params.event){var s=function(e){X(l.params.event,function(){$('[href="#patientEventsContent"]').click(),$.ajax("care-coordination/patients/patient/"+e+"/event/"+l.params.event+"/page-number").success(function(e){g=!0,O().widgets.patientEventList.api().page(e).draw(!1)})},function(e){bootbox.alert(e.responseText),u.route({template:l.template})})};void 0===$("#currentPatientId").val()?Ne(l.params.patient,null,!1,!0,function(){s(l.params.patient)}):s($("#currentPatientId").val())}}else e&&$('[href="#'+e+'"]').click();t&&$('a[href^="#'+t+'"]').parent("li").addClass("active"),$("#content").removeClass("loading")}},setEvents:function(){return Y(".datepicker").datepicker(),Y(".datepicker").change(function(){var e=new Date($(this).val());isNaN(e.getTime())?$(this).val(""):$(this).datepicker("setValue",e)}),Y("input[type='radio']").styler(),Y("#patientSearch").on("click",function(){return O().widgets.patientsList.api().order([[1,"asc"],[0,"asc"]]),O().widgets.patientsList.api().ajax.reload(),!1}),Y("#showDeactivatedRecords").on("change",function(){return Y("#showDeactivated").val(this.checked),O().widgets.patientsList.api().ajax.reload(),!1}),Y("#patientSearchClear").on("click",function(){return Y("#patientsFilter").clearForm(),!1}),Y("#addPatient").on("click",function(){B(Y("#addPatientContainer"),0,$(this))}),!1},reloadNeeded:function(){return c.reloadNeeded},getParentModule:function(){return a}}}();