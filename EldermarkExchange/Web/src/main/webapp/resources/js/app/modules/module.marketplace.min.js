$(document).on("ready",function(){function e(e){return e?"addClass":"removeClass"}function t(t){$(t)[e(t.value)]("x")}function n(){$(".truncated-text").each(function(){!function(e){for(var t=e.innerHTML.split(" ");e.scrollHeight>e.offsetHeight;)t.pop(),e.innerHTML=t.join(" ")+"..."}(this)})}function o(){var e=v.getPlace();if(e.geometry){L=e.geometry.viewport,y=e.geometry.location;i({lat:e.geometry.location.lat(),lng:e.geometry.location.lng()}),console.log("onPlaceChanged selectedLatLng "+e.geometry.location.lat()+" "+e.geometry.location.lng())}}function a(){console.log("showSelectLocationDialog"),$("#startLocationModalId").modal(),$("#startLocationModalId").on("hide.bs.modal",function(){$("#startLocationAutocompleteId").val("")}),$("#marketLocationButtonIdBack").click(function(){window.location.replace("login")}),$("#marketLocationButtonIdGo").click(function(){if(void 0!==y){i({lat:y.lat(),lng:y.lng()}),l()}else{i({lat:44.977753,lng:-93.2650108}),l()}$("#startLocationModalId").val("").modal("toggle")}),(v=new google.maps.places.Autocomplete(document.getElementById("startLocationAutocompleteId"),{types:["(regions)"]})).addListener("place_changed",o)}function i(e){sessionStorage.lat=e.lat,sessionStorage.lng=e.lng;var t=$("#marketplaceFilterFrom");t.find("input[name='initLatitude']").val(e.lat),t.find("input[name='initLongitude']").val(e.lng)}function l(){console.log("postFilterForm"),$("#marketplaceFilterFrom").submit()}function c(){if("false"==$(".marketplaceMap").attr("data-init-location-was-set"))navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){i(b={lat:e.coords.latitude,lng:e.coords.longitude}),l()},function(e){a()}):a();else{!function(e){h=new google.maps.Map(document.getElementById("map"),{center:e,fullscreenControl:!1,streetViewControl:!1,mapTypeControl:!1,zoomControl:!0}),google.maps.event.addListenerOnce(h,"idle",function(){f.hideLoader()}),w=e,addYourLocationButton(h,e),r()}({lat:parseFloat(sessionStorage.lat),lng:parseFloat(sessionStorage.lng)}),h.setZoom(x)}}function r(){$("#communityList").children(".communityItem ").each(function(){!function(e){e.data("addmarker")&&function(e,t,o){var a=o.length;if(e&&t){var i=new google.maps.Marker({position:{lat:e,lng:t},map:h,icon:T[a-1]});google.maps.event.addListener(i,"mouseover",function(){p(),google.maps.event.trigger(this,"click")}),i.addListener("click",function(){p(),u(),this.setIcon(_[a-1]),C=this,F=a,$.ajax({url:"marketplace/popup",data:{ids:o},type:"POST",success:function(e){var t=$(e);t.find(".viewDetails").click(function(e){e.preventDefault(),s($(this))}),p(),(k=new google.maps.InfoWindow({content:t[0],maxWidth:400})).open(h,i),setTimeout(n,200)}})}),B.push(i)}}(e.data("latitude"),e.data("longitude"),e.data("sameaddrids"))}($(this).find(".communityAddress"))})}function s(e){$("#market-place-filter-content").hide(),$("#market-place-community-details-header").show(),$("#filter #communityId").html("#"+e.data("id")),$.ajax("marketplace/"+e.data("id")+"/details").success(function(e){$("#marketplaceMenuContent").hide();var t=$("#marketplaceDetailsContent");t.hide(),t.empty(),t.append(e),t.show(),$("#content").find(".backToCommunity").on("click",function(){t.hide(),$("#marketplaceMenuContent").show(),$("#market-place-filter-content").show(),$("#market-place-community-details-header").hide()}),$(".marketplace-service-description .more").on("click",function(){var e=$(this).parent(".marketplace-service-description"),t=e.find(".additionalTextSpan"),n=e.find(".more");t.toggle(),n.toggle()}),$(".community-details-services-panel").first().click()})}function d(){$(".marketplaceDetailsLink").on("click",function(){s($(this))})}function m(){d(),function(e){for(var t=0;t<B.length;t++)B[t].setMap(e)}(null),r(),n()}function u(){C&&C.setIcon(T[F-1])}function p(){void 0!==k&&k.close()}function g(e){e.val("0"),e.selectpicker("refresh")}var f=ExchangeApp.utils.module;f.showLoader(),$(document).on("input",".clearable",function(){t(this)}).on("mousemove",".x",function(t){$(this)[e(this.offsetWidth-38<t.clientX-this.getBoundingClientRect().left)]("onX")}).on("click",".onX",function(){$(this).removeClass("x onX").val("").change()}).on("change paste keyup",function(){t(this)}),n();var h,v,k,y,L,C,F,w,x=8,I=1,M="resources/images/pins/",T=[M+"pin.png",M+"pin_2.png",M+"pin_3.png",M+"pin_4.png",M+"pin_5.png",M+"pin_5_.png"],_=[M+"pingreen.png",M+"pin_2green.png",M+"pin_3green.png",M+"pin_4green.png",M+"pin_5green.png",M+"pin_5_green.png"],S=$("#marketplaceFilterFrom").find(".spicker");S.selectpicker(),S.on("changed.bs.select",f.noneOptionHandler),S.on("changed.bs.select",f.allOptionHandler);var b,B=[];window.initMap=function(){c()},$('input[id="searchField"]').val($('input[name="searchText"]').val()),$("#searchField.clearable").each(function(){var e=$(this);""!=e.val()&&e.addClass("x")}),function(){var e=$("#searchField").val();e&&""!==e&&$(".communityName, .marketplace-community-type, .communityAddress").each(function(){var t=$(this),n=t.text().replace(new RegExp("("+e+")","gi"),"<span class='highlight-green'>$1</span>");t.html(n)})}(),$("#communitySearchButton").on("click",function(){$('input[name="searchText"]').val($('input[id="searchField"]').val()),l()}),$("#communitySearchForm").on("submit",function(e){e.preventDefault(),$("#communitySearchButton").click()}),d(),$("#communityList").on("scroll",function(){var e=$(this);if($(this).scrollTop()+$(this).innerHeight()>=$(this)[0].scrollHeight&&!$("#marketplaceMenuContent").data("scroll-last")){f.showLoader(),$('input[name="searchText"]').val($('input[id="searchField"]').val());$("#marketplaceFilterFrom").serialize();$('input[name="pageNumber"]').val(I),$.ajax({url:"marketplace/scroll",data:$("#marketplaceFilterFrom").serialize(),type:"POST",success:function(t){t.last&&$("#marketplaceMenuContent").data("scroll-last",!0);var n=t.content;if(n.length>0){var o;for(o=0;o<n.length;o++){var a=e.find(".communityItem:last").clone();a.toggleClass("odd").toggleClass("even"),a.find(".communityName").text(n[o].communityName),a.find(".marketplace-community-type").text(n[o].communityTypes.join());var i=a.find(".communityAddress");i.text(n[o].address),i.attr("data-markercount",n[o].markerCount),i.data("sameaddrids",n[o].sameAddrIds),i.data("latitude",n[o].location.latitude),i.data("longitude",n[o].location.longitude),i.attr("data-addmarker",n[o].addMarker),a.find(".marketplaceDetailsLink").attr("data-id",n[o].id),a.find(".community-distance").text(n[o].location.displayDistanceMiles),e.append(a)}I++,m()}f.hideLoader()},error:function(e){alert(e.responseText)}})}}),$(document).mouseup(function(e){!function(e){var t=$("#organizationInfoPopup");t.is(e.target)||0!==t.has(e.target).length||void 0===k||(p(),u())}(e)}),$("#filterClear").click(function(){console.log("filterClear");var e=$(this).closest("form");console.log("filterClear "+e.find("#orgPrimaryFocus").val()),g(e.find("#orgPrimaryFocus")),g(e.find("#orgCommunityType")),g(e.find("#serviceId")),e.find(".choose-different-insurance").trigger("click",!0)}),$("#marketplaceFilterFrom").submit(function(){f.showLoader()})});