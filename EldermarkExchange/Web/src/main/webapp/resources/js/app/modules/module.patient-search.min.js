ExchangeApp.modules.PatientSearch=function(){function e(){a().random=h.rand(),function(e,t){var r=a(),n=e||r.$html,s=t||r.random;n=h.randomize(n,s,!1)}(),function(e,t){var r=a();r.ajaxMap||(r.ajaxMap={});var s=e||r.$html,i=t||r.random,o=h.findAjaxUrls(s,i);$.each(o,function(e,a){r.ajaxMap[n(a,{params:!0})]=a}),h.find(s,i,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),a=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),r=h.getUrl(e,a,t);return u.route(r),!1}),h.find(s,i,'[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href"));return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1})}()}function a(){return l[n(c,{params:!0})]}function t(){return n(c,{params:!0}).replace(/[/&\?=]/g,"_")}function r(){return $(document.getElementById(t()))}function n(e,a){return h.stringifyUrl(e,a)}function s(e){var t=a();return h.find(t.$html,t.random,e)}function i(){return s("input[name='searchScopes']").toArray().reduce(function(e,a){return e[a.value]=a.checked,e},{})}function o(){a().widgets.patientSearchList=function(e){var t=a();return g.grid(t.$html,t.random,e)}({tableId:"patientList",searchFormId:"patientFilterForm",totalDisplayRows:25,colSettings:{residentNumber:{order:"asc"},actions:{width:"75px"}},order:[[1,"asc"],[0,"asc"]],fetchServerData:function(e,a,t){var r={dataType:"json",type:a,url:e},n=function(e,a){this.callbacks&&this.callbacks[a]&&this.callbacks[a](e)},i=s("#"+this.tableId),o=s("#"+this.searchFormId);if(o.valid()){s("#searchMergedCheckLayout").addClass("hidden");var d,l=o.serializeArray().reduce(function(e,a){return"searchScopes"===a.name?e[a.name]=e.hasOwnProperty(a.name)?e[a.name].concat(a.value):[a.value]:e[a.name]=a.value,e},{}),c=l.ssn1,p=l.ssn2;d=void 0!==c&&void 0!==p?c+p+l.lastFourDigitsOfSsn:l.lastFourDigitsOfSsn,r.data=o.serialize(),r.data+="&ssn="+d;var g=0,m=[],f=$.when();l.searchScopes.indexOf("ELDERMARK")>-1&&(f=f.then(function(){var e=$.extend({},r);return e.url+="&searchScope=ELDERMARK",$.ajax(e)}).then(function(e){return g+=e.totalElements,m=m.concat(e.content),n(e,"successCallback"),e}).fail(function(e){return ExchangeApp.utils.module.onAjaxError(e),n(e,"errorCallback"),{iTotalDisplayRecords:0,content:[]}}).always(function(e){e.iTotalDisplayRecords=g,e.content=m,t(e)})),l.searchScopes.indexOf("NWHIN")>-1&&f.then(function(){i.find("tbody").append($('<tr><td id="process_msg" colspan="7">Searching the patient in NwHIN...</td></tr>'));var e=$.extend({},r);return e.url+="&searchScope=NWHIN",$.ajax(e)}).then(function(e){return g+=e.totalElements,m=function(e,a){for(var t,r=-1,n=e.length,s=a.length;++r<s;){var i=a[r],o=!1;for(t=-1;++t<n;){var d=e[t];if(d.id===i.id&&d.hashKey===i.hashKey){o=!0;break}}o?e[t]=i:e.push(i)}return e}(m,e.content),n(e,"successCallback"),e}).fail(function(e){return ExchangeApp.utils.module.onAjaxError(e),n(e,"errorCallback"),{iTotalDisplayRecords:0,content:[]}}).always(function(e){e.iTotalDisplayRecords=g,e.content=m,t(e)}),f.always(function(){var e=m.filter(function(e){return"ELDERMARK"===e.searchScope}).length>0,a=m.filter(function(e){return e.mergedId}).length>0;if(e&&a){var t;i.find(".mergedResident").each(function(){var e=$(this).next(),a=$(this).prev();a.is(".mergedResident")||(t=a.clone()),0!==e.length&&e.is(".mergedResident")||($(this).after(t),t.empty(),t.append($('<td colspan="100" align="right"><a class="showAggregatedRecordLabel">Show Aggregated Record</a></td>')),t.removeClass("even"),t.removeClass("odd"),$(this).is(".odd")?t.addClass("even"):t.addClass("odd"),t.addClass("showAggregatedRecord"),t.on("click",t,function(e){var a=e.data,t=a.attr("data-ajax-url-tmpl");t+="/aggregated";var r=a.attr("data-ajax-url-vars"),n=a.attr("data-ajax-url-params"),s=h.getUrl(t,r,n);return u.route(s),!1}),t.hide())})}})}else t({iTotalDisplayRecords:0,content:[]})},callbacks:{rowCallback:function(e,t,r){var i=$(e),o=s("#patientPreviewTemplate").clone(),d="patientPreview-"+r;if(o.attr("id",d),null!==t){var l=o.find(".recordLink");l.attr("href","patient-info");var c=l.attr("href")+"/{residentId}",p="hashKey="+t.hashKey+"&databaseId="+t.databaseId,g="residentId="+t.id;l.attr("href","#"+c+"?"+p);var m=h.getUrl(c,g,p);a().ajaxMap[n(m,{params:!0})]=m,l.attr("data-ajax-url-tmpl",c),l.attr("data-ajax-load",!0),l.attr("data-ajax-url-params",p),l.attr("data-ajax-url-vars",g),l.on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),a=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),r=h.getUrl(e,a,t);return u.route(r),!1}),i.attr("data-ajax-url-tmpl",c),i.attr("data-ajax-load",!0),i.attr("data-ajax-url-vars",g),i.attr("data-ajax-url-params",p),i.on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),a=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),r=h.getUrl(e,a,t);return u.route(r),!1});for(var x=["fullName","dateOfBirth","genderDisplayName","ssn","streetAddress","cityStateAndPostalCode"],C=0;C<x.length;C++){var y=x[C],b="";t[y]&&"null"!=t[y]&&(b=t[y]);h.find(o,a().random,"#"+y).text(b)}o.removeClass("hidden"),i.popover({html:!0,content:o[0],trigger:"hover",delay:300,placement:function(){return i.addClass("hasPopover"),"bottom"}}),i.on("show.bs.popover",function(){s(".popover").trigger("mouseout")}).on("shown.bs.popover",function(){s(".popover").on("mouseout",function(){$(this).is(":hover")||i.removeClass("hasPopover").popover("hide")})}).on("hide.bs.popover",function(){if($(this).hasClass("hasPopover"))return!1}),t.mergedId&&"null"!==t.mergedId?(i.addClass("mergedResident"),i.attr("data-merged-id",t.mergedId),v||i.hide()):f=!f,f?(i.removeClass("even"),i.addClass("odd")):(i.removeClass("odd"),i.addClass("even"));var N=i.children("td:eq(7)");if(N.empty(),t.hasMerged){var E=$('<a class="showMergedLink"></a>');v?E.text("Hide Matches"):E.text("Show Matches"),N.on("click",function(){return function(e,a){var t=$("[data-merged-id='"+e+"'], .showAggregatedRecord[data-ajax-url-vars='residentId="+e+"']");t.is(":visible")?(t.hide(),a.find(".showMergedLink").text("Show Matches"),a.removeClass("hasMergedResidents")):(t.show(),a.find(".showMergedLink").text("Hide Matches"),a.addClass("hasMergedResidents"))}(t.id,i),!1}),N.append(E)}}},errorCallback:function(e){h.onAjaxError(e,function(a){_alert({action:"add",placeSelector:".patientFilterBox .boxBody",message:e.responseText,closable:{timer:45e3,btn:!0}})})},footerCallback:function(e,a,t,r,n){$(e).show();a.length<20&&$(e).hide()}}})}var d,l={},c={template:"patient-search"},p={reloadNeeded:!1},u=ExchangeApp.routers.ModuleRouter,h=ExchangeApp.utils.module,g=ExchangeApp.utils.wgt,m=ExchangeApp.loaders.FragmentLoader.init("patientSearch"),f=!1,v=!1;return $.fn.clearForm=function(){return this.each(function(){var e=this.tagName.toLowerCase();if("form"===e)return $(":input:not(.hidden)",this).clearForm();var a=this.type;"text"===a||"password"===a||"textarea"===e?(this.value="",$(this).trigger("refresh")):"checkbox"===a?(this.checked=!1,$(this).trigger("refresh")):"select"===e&&(this.selectedIndex=0,$(this).trigger("change"))})},{init:function(t){c=t,$("#content").addClass("loading"),this.renderHolder(),this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=a();d=function(){var e="true"==s("#ssnRequired").val(),a="true"==s("#dateOfBirthRequired").val(),t=new ExchangeApp.utils.wgt.Validation({rules:{searchScopes:{required:!0},firstName:{required:!0},lastName:{required:!0},gender:{required:!0},dateOfBirth:{dateExp:/^\d{2}\/\d{2}\/\d{4}$/,required:function(e){return!i().ELDERMARK||a}},ssn1:{integer:!0,required:{depends:function(e){return""!=s("#ssn2").val()}}},ssn2:{integer:!0,required:{depends:function(e){return""!=s("#ssn1").val()}}},lastFourDigitsOfSsn:{integer:!0,required:function(a){return!!i().ELDERMARK&&e}},phone:{phone:!0},city:{required:function(e){return i().NWHIN}},street:{required:function(e){return i().NWHIN}},state:{stateUS:!0,required:function(e){return i().NWHIN}},postalCode:{required:function(e){return i().NWHIN}}},messages:{lastName:{required:"Please enter Last Name that matches ID record"},firstName:{required:"Please enter First Name that matches ID record"},gender:{required:getErrorMessage("field.empty")},dateOfBirth:{dateExp:getErrorMessage("field.dateFormat"),required:getErrorMessage("field.empty")},ssn:{integer:getErrorMessage("field.integer"),required:getErrorMessage("field.empty")},state:{stateUS:getErrorMessage("field.state"),required:getErrorMessage("field.empty")},postalCode:{required:getErrorMessage("field.empty")},street:{required:getErrorMessage("field.empty")},city:{required:getErrorMessage("field.empty")}}});return $.extend(t,{ignore:""}),s("#patientFilterForm").validate(t)}(),e.widgets={},o(),s("input.datepicker").datepicker(),s("input.datepicker").change(function(){var e=new Date($(this).val());isNaN(e.getTime())?$(this).val(""):$(this).datepicker("setValue",e)}),s("input[name='searchScopes']:checked").change(function(e){var a=i(),t=['label[for="street"] span.mandatory-asterisk','label[for="city"] span.mandatory-asterisk','label[for="state"] span.mandatory-asterisk','label[for="postalCode"] span.mandatory-asterisk'].join();a.NWHIN?$(t).show():$(t).hide(),a.ELDERMARK?$(".ssn-xxxx span.mandatory-asterisk").show():$(".ssn-xxxx span.mandatory-asterisk").hide();var r=["#ssn1","#ssn2"].join();a.NWHIN?s(r).prop("disabled",!1):s(r).prop("disabled",!0),a.NWHIN&&a.ELDERMARK?$(".ssn-help-msg").show():$(".ssn-help-msg").hide(),d.resetForm()}),s("input[type='radio']").styler(),s("input[type='checkbox']").styler(),function(){var e=function(e){s("#firstName").val(e.firstName),s("#lastName").val(e.lastName),s("input[id^=gender][id*="+a().random+"]").each(function(a){var t=$(this);t.prop("checked",t.val()==e.gender),t.trigger("refresh")}),s("#dateOfBirth").data("datepicker").setValue(e.birthDate),s("#lastFourDigitsOfSsn").val(e.ssn)};if(c.params&&c.params.firstName&&c.params.lastName&&c.params.birthDate&&c.params.gender&&c.params.ssn){v=!0;var t=new Date(c.params.birthDate),r=t.getMonth()+1+"/"+t.getDate()+"/"+t.getFullYear();e({firstName:c.params.firstName,lastName:c.params.lastName,birthDate:r,gender:c.params.gender.toUpperCase(),ssn:c.params.ssn}),s(":checkbox[value='NWHIN']").prop("checked",!1).trigger("refresh"),a().widgets.patientSearchList.api().ajax.reload()}else $.ajax({type:"GET",contentType:"json",url:s("#loggedInEmployeeUrl").attr("href"),success:function(a){a.alternativeDatabaseId.toUpperCase()=="EMTest_21250".toUpperCase()?(a.login.toUpperCase()=="Greg".toUpperCase()&&e({firstName:"Greg",lastName:"Bertagnoli",birthDate:"9/27/1970",gender:"MALE",ssn:"1111"}),a.login.toUpperCase()=="MAnderson".toUpperCase()&&e({firstName:"Mark",lastName:"Anderson",birthDate:"2/4/1995",gender:"MALE",ssn:"1111"}),a.login.toUpperCase()=="GRobertson".toUpperCase()&&e({firstName:"Greg",lastName:"Robertson",birthDate:"6/18/1973",gender:"MALE",ssn:"1111"}),a.login.toUpperCase()!=="Craig".toUpperCase()&&a.login.toUpperCase()!=="aduzhynskaya".toUpperCase()&&a.login.toUpperCase()!=="phomal@scnsoft.com".toUpperCase()&&a.login.toUpperCase()!=="dweber".toUpperCase()&&a.login.toUpperCase()!=="nate".toUpperCase()||e({firstName:"Craig",lastName:"Patnode",birthDate:"12/19/1969",gender:"MALE",ssn:"6379"}),a.login.toUpperCase()=="Kevin".toUpperCase()&&e({firstName:"Kevin",lastName:"King",birthDate:"8/8/1953",gender:"MALE",ssn:"1111"}),a.login.toUpperCase()=="Ben".toUpperCase()&&e({firstName:"Ben",lastName:"Kelly",birthDate:"10/1/1975",gender:"MALE",ssn:"1111"})):a.alternativeDatabaseId.toUpperCase()=="RBA".toUpperCase()&&a.login.toUpperCase()=="nate.tyler@eldermark.com".toUpperCase()&&e({firstName:"Craig",lastName:"Patnode",birthDate:"12/19/1969",gender:"MALE",ssn:"6379"})}})}(),this.setEvents(),$("#content").removeClass("loading"),this.render(),this.show(),e.inited=!0,this.loaded()}})},update:function(e){c=e,a().widgets.patientSearchList.api().ajax.reload(),this.loaded()},loadFragment:function(e){var a=this;m.load({url:c,callbacks:{onFragmentLoaded:function(t){p.reloadNeeded=!1;var r=$(t).find("#content .markup-frg"),s=n(c,{params:!0});l[s]={$html:r,url:h.clone(c)},e.onFragmentLoaded.apply(a)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(a)}}})},loaded:function(){$.each($(".baseHeader .ldr-head-lnk.active"),function(){$(this).removeClass("active"),$(this).removeClass("bottom")});$(".baseHeader .ldr-head-lnk.personalHealthRecordLnk ").addClass("active bottom")},render:function(){var e=a().$html;r().empty(),r().append(e)},renderHolder:function(){if(!document.getElementById(t())){var e=$("<div/>");e.attr("id",t()),e.hide(),$("#content").append(e)}},hide:function(){r().hide();if(a()){s(".popover").addClass("hidden");var e=s("#hashKeyError");e&&e.remove()}$("#content").addClass("loading")},show:function(){0==$("#content > div:visible").length&&r().show(),$("#content").removeClass("loading")},getFragment:function(e){return l[n(e,{params:!0})]},isFragmentInited:function(e){var a=this.getFragment(e);return a&&a.inited},setEvents:function(){var e=function(){v=!1,f=!1,a().widgets.patientSearchList.api().order([[1,"asc"],[0,"asc"]]),a().widgets.patientSearchList.api().ajax.reload()};s("#patientFilterForm input").on("keydown",function(a){if(13==a.keyCode)return a.preventDefault(),e(),!1}),s("#search").on("click",function(){return e(),!1}),s("#clear").on("click",function(){s("#patientFilterForm").clearForm();var e=s("#patientList"),a=e.dataTable().fnSettings();return e.dataTableExt.oApi.fnClearTable(a),!1})},reloadNeeded:function(){return p.reloadNeeded}}}();