ExchangeApp.modules.Header=function(){function e(){var e=n();e.$holder=$("#header"),e.random=m.rand(),function(e,t){var a=n(),r=e||a.$html,o=t||a.random;r=m.randomize(r,o,!1)}(),function(e,a){var r=n();r.ajaxMap||(r.ajaxMap={});var o=e||r.$html,i=a||r.random,s=m.findAjaxUrls(o,i);$.each(s,function(e,n){r.ajaxMap[t(n,{params:!0})]=n}),m.find(o,i,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),n=$(this).attr("data-ajax-url-vars"),t=$(this).attr("data-ajax-url-params"),a=m.getUrl(e,n,t);return h.route(a),!1}),m.find(o,i,'[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href"));return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1})}()}function n(){return d[t(g,{params:!0})]}function t(e,n){return m.stringifyUrl(e,n)}function a(e){var t=n();return m.find(t.$html,t.random,e)}function r(){var e=ExchangeApp.routers.ModuleRouter.getUrlTemplate(),n=a("#subMenu"),t=a("#subMenuCommunityLabel"),r=a("#subMenuCommunityInput"),o=a("#subMenuOrgLabel"),i=a("#subMenuOrgInput");if(n){var s=!0,c=!0,l=!0;-1===e.indexOf("care-coordination")?(s=!1,c=!1,l=!1):-1!==e.indexOf("organizations")?(c=!1,l=!1):-1!==e.indexOf("contacts")?l=!1:-1!==e.indexOf("communities")&&(l=!1),e.endsWith("care-coordination")&&(r=null,i=null),!0===s?(n.show(),r&&(l?(t.css("display","table-cell"),r.css("display","table-cell")):(t.hide(),r.hide())),i&&(c?(o.css("display","table-cell"),i.css("display","table-cell")):(o.hide(),i.hide()))):n.hide()}}function o(){var e=a("#availableOrganizationChooser");0!==e.length&&$.ajax({type:"GET",contentType:"json",url:v,success:function(n){e.empty();for(var t in n){var a=n[t],r=$("<option />").attr("value",a.id).text(a.label);a.selected&&(r.attr("selected","selected"),c=a.id),e.append(r)}s(e.find("option:selected"),230),e.selectpicker("refresh")}})}function i(){var e=a("#availableCommunitiesChooser");e&&$.ajax({type:"GET",contentType:"json",url:b,success:function(n){e.empty(),l=[];for(var t in n){var a=n[t],r=$("<option />").attr("value",a.id).text(a.label);a.selected&&(r.attr("selected","selected"),e.push(a.id)),e.append(r)}e.selectpicker("refresh"),e.trigger("chosen:updated")}})}function s(e,n){var t=e.text();t=function(e,n){var t=e,r=a("#testWidthSpan");r.html(t);for(var o=r.width(),i=!1;o>n;)i=!0,t=t.substr(0,t.length-1),r.html(t),o=r.width();return i&&(t+="..."),t}(t,n),e.text(t)}var c,l,u,d={},g={template:"header"},p={reloadNeeded:!1},h=ExchangeApp.routers.ModuleRouter,m=ExchangeApp.utils.module,f=ExchangeApp.loaders.FragmentLoader.init("header"),v="care-coordination/organizations/selectList",b="care-coordination/communities/selectList",x=null;return{init:function(t){g=t,this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=n();e.widgets={},this.setEvents(),function(){var e=ExchangeApp.routers.ModuleRouter.getUrlTemplate();e.indexOf("secure-messaging")>-1?a(".secureMsgLnk").addClass("bottom active"):e.indexOf("patient")>-1?a(".personalHealthRecordLnk").addClass("bottom active"):e.indexOf("care-coordination")>-1?a(".careCoordinationLnk").addClass("bottom active"):e.indexOf("reports")>-1?a(".reportsLnk").addClass("bottom active"):e.indexOf("administration")>-1&&a(".administrationLnk").addClass("bottom active"),r()}(),e.inited=!0,this.render()}})},update:function(e){g=e},getFragment:function(e){return d[t(e,{params:!0})]},isFragmentInited:function(e){var n=this.getFragment(e);return n&&n.inited},loadFragment:function(e){var n=this;f.load({url:g,callbacks:{onFragmentLoaded:function(a){p.reloadNeeded=!1;var r=$(a).find("#header .markup-frg"),o=t(g,{params:!0});d[o]={$html:r,url:m.clone(g)},e.onFragmentLoaded.apply(n)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(n)}}})},render:function(){var e=n();e&&e.$holder&&(e.$holder.empty(),e.$holder.append(e.$html))},hide:function(){var e=n();e&&e.$holder.hide()},show:function(){var e=n();e&&e.$holder&&e.$holder.show()},setEvents:function(){a(".logOut").on("click",function(){return $.ajax({type:"GET",url:"session-active",success:function(e){a("#logoutForm").submit(),$.ajax({type:"GET",url:window.auditReportLogoutUrl})},error:function(e){m.onAjaxError(e)}}),!1}),a(".ldr-head-lnk").on("click",function(){a(".ldr-head-lnk.active").removeClass("bottom active"),$(this).addClass("bottom active")}),a(".userOptions .option").on("click",function(){a(".userOptions").removeClass("open")}),a(".manageSES").on("click",function(){var e=a(".secureMsgLnk");e.hasClass("bottom active")||(a(".ldr-head-lnk.active").removeClass("bottom active"),e.addClass("bottom active"))}),$.ajax({type:"GET",contentType:"json",url:a("#unreadInboxCountUrl").attr("href"),success:function(e){a("#secureMessageTotal").toggleClass("hidden",!e),a("#secureMessageTotal").text(e)}}),$.ajax({type:"GET",contentType:"json",url:a("#employeInfoUrl").attr("href"),success:function(e){a(".user").text(e.fullName),e.roleDisplayName&&a(".roleLabel").text(e.roleDisplayName),u=e.id,e.logoUrl?(a("#mainLogoImage").attr("src","resources/images/internal/"+e.logoUrl).attr("height",70),a("#sponsoredLogoHeader").show()):a("#defaultLogoHeader").show(),e.alternativeLogoUrl&&(a("#altLogoImage").attr("src","resources/images/internal/"+e.alternativeLogoUrl),a("#altLogoBlock").css("display","table-cell"))}});var e=a("#availableOrganizationChooser");0!=e.length&&(o(),e.on("change",function(n,t,a,r){s(e.find("option:selected"),230),$.ajax({type:"POST",contentType:"json",url:"care-coordination/admin/databaseId?databaseId="+e.val(),beforeSend:function(e){m.csrf(e)},success:function(n){1!=n.showCommunitiesTab||$("[id^=communitiesTab]").is(":visible")?0==n.showCommunitiesTab&&$("[id^=communitiesTab]").is(":visible")&&$("[id^=communitiesTab]").hide():$("[id^=communitiesTab]").show(),c=e.val(),null===h.getUrlTemplate()?h.reload():h.reload({template:h.getUrlTemplate()}),ExchangeApp.managers.EventManager.publish("community_list_changed"),ExchangeApp.managers.EventManager.publish("patients_list_changed")},error:function(e){m.onAjaxError(e)}}),ExchangeApp.managers.EventManager.publish("org_and_community_settings_changed",{org:e.val()})}));var n=a("#availableCommunitiesChooser");n&&0!=n.length&&(i(),n.on("changed.bs.select",function(e,t,a,r){var o=$(this).val();!o||0==t&&a?($(this).selectpicker("val",0),$(this).selectpicker("refresh")):t>0&&a&&($(this).find("[value=0]").prop("selected",!1),$(this).selectpicker("refresh")),x&&clearTimeout(x),x=setTimeout(function(){$.ajax({type:"POST",contentType:"json",url:"care-coordination/admin/communityId?communityId="+n.val(),beforeSend:function(e){m.csrf(e)},success:function(e){l=n.val(),h.reload({template:h.getUrlTemplate()}),ExchangeApp.managers.EventManager.publish("patients_list_changed")},error:function(e){m.onAjaxError(e)}}),ExchangeApp.managers.EventManager.publish("org_and_community_settings_changed",{community:o})},300)}));var t=function(){$.ajax({type:"GET",contentType:"json",url:a("#employeeSecureEmailUrl").attr("href"),success:function(e){a(".email").text(e)},error:function(e){m.onAjaxError(e,function(){a(".email").text(e.responseText)})}})},d=function(){$.ajax({type:"GET",contentType:"json",url:a("#unreadInboxCountUrl").attr("href"),success:function(e){a("#secureMessageTotal").toggleClass("hidden",!e),a("#secureMessageTotal").text(e)}})};t(),d(),ExchangeApp.managers.EventManager.subscribe("inbox_count_changed",function(){d()}),ExchangeApp.managers.EventManager.subscribe("messaging_setup_changed",function(){d(),t()}),ExchangeApp.managers.EventManager.subscribe("page_changed",function(){r()}),ExchangeApp.managers.EventManager.subscribe("community_list_changed",function(){i()}),ExchangeApp.managers.EventManager.subscribe("org_list_changed",function(){o()}),ExchangeApp.managers.EventManager.subscribe("change_org_list",function(e){console.log("change org list ",e)})},reloadNeeded:function(){return p.reloadNeeded},getCurrentOrganizationFilter:function(){return c},getCurrentCommunityFilter:function(){return l?l.slice(0):void 0},setCurrentOrg:function(e){a("#availableOrganizationChooser").val(e).change()},showCurrentOrg:function(){a("#subMenuOrgLabel").show(),a("#subMenuOrgInput").show()},addOptionToOrganizationChooserIfAbsent:function(e,n){var t=a("#availableOrganizationChooser");0===t.has('option[value="'+e+'"]').length&&t.append($("<option>",{value:e,text:n}))},hideCurrentOrg:function(){a("#subMenuOrgLabel").hide(),a("#subMenuOrgInput").hide()},getCurrentUserId:function(){return u}}}();