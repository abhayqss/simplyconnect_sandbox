ExchangeApp.utils.patientccd=function(){var e,t,n,o=ExchangeApp.utils.module,a=ExchangeApp.routers.ModuleRouter,i=function(e){return $(e)};function d(t){var n=e();return o.find(n.$html,n.random,t)}function r(a,d,r,c,s,u){e().widgets.documentList=u({tableId:"documentList",searchFormId:"documentFilterForm",totalDisplayRows:25,colSettings:{documentType:{mRender:function(e,t,n){return!0===n.cdaViewable?"Ccd":(e[0].toUpperCase()+e.toLowerCase().substring(1)).replace("_"," ")},bSortable:!1},dataSource:{bSortable:!1,customRender:function(e,t,n){return e?'<a href="#" id="resident-document-'+n.id+'" onclick="return false">'+e+"</a>":""}}},selectable:{type:"multiple"},callbacks:{rowCallback:function(t,a,u){!function(t,a,d,r,c){if(!t)return;var s=i("#documentDataSourceDetailsTemplate").clone(),u="documentDataSourceDetailsTemplate-"+t.id;s.attr("id",u),s.removeClass("hidden"),$(t).popover({html:!0,content:s[0],trigger:"hover",placement:function(){return"bottom"}});var l={dataSourceName:a,dataSourceOID:d,communityName:r,communityOID:c};for(var m in l)l[m]?n?s.find("#"+m).text(l[m]):o.find(s,e().random,"#"+m).text(l[m]):n?s.find("#"+m+"Layout").hide():o.find(s,e().random,"#"+m+"Layout").hide()}($(t).find("#resident-document-"+a.id)[0],a.dataSource,a.dataSourceOid,a.community,a.communityOid);var l,m=$("<a>");if(!0===a.cdaViewable)l="documents/"+a.id+"/cda-view",m.attr("target","_blank"),m.attr("rel","nofollow noopener");else{l=s;var f=a.documentType.toLowerCase();"ccd"===f||"facesheet"===f?(l+=f+"/download",a.id=f):"custom"!==f&&"nwhin"!==f&&"lab_results"!==f||(l+="custom/"+a.id+"/download"),l+="?hashKey="+r,l+="&databaseId="+d,l+="&documentName="+a.documentTitle,"ccd"!==f&&"facesheet"!==f||(l+="&aggregated="+c),l+="&timeZoneOffset="+(new Date).getTimezoneOffset()}m.attr("href",l),m.html(a.documentTitle);var p=e().widgets.documentList.api().column("documentTitle:name").nodes()[u];$(p).html(m)},errorCallback:function(e){o.onAjaxError(e,function(e){t({action:"add",placeSelector:".documents",message:e.responseText,closable:{timer:45e3,btn:!0}})})}}})}function c(n,a,i,d,r,c,s){var u=e().widgets.documentList.fnSettings().oInit.store.items;switch(n.operationName){case"delete":var l=u.filter(function(e){return-1==e.indexOf("ccd")&&-1==e.indexOf("facesheet")||(t({action:"add",placeSelector:".documents",message:("ccd"==e?"CCD.XML":"FACESHEET.PDF")+" cannot be deleted.",closable:{timer:45e3,btn:!0}}),!1)}),m=function(e){o.onAjaxError(e,function(e){t({action:"add",placeSelector:".documents",message:e.responseText,closable:{timer:45e3,btn:!0}})})};$.each(l,function(t,n){$.ajax({type:"DELETE",data:{hashKey:d},url:r+"custom/"+n+"/delete?hashKey="+d+"&databaseId="+i,beforeSend:function(e){o.csrf(e)},success:function(){e().widgets.documentList.api().ajax.reload(),e().widgets.documentList.fnSettings().oInit.store.removeItem(n),s(-1)},error:m})});break;case"download":$.each(u,function(t,n){var o=$.grep(e().widgets.documentList.api().data(),function(e){return e.id===n})[0],a=o.documentType.toLowerCase(),s=r,u=null;"ccd"===a||"facesheet"===a?(s+=a+"/download",u=c):"custom"!==a&&"nwhin"!==a&&"lab_results"!==a||(s+="custom/"+n+"/download"),$.fileDownload(s,{data:{hashKey:d,databaseId:i,documentName:o.documentTitle,aggregated:u},failCallback:m})})}}function s(){return i("#"+"uploadDocumentForm"+" input").on("change",function(){$(this).trigger("focusout")}),i("#uploadDocumentForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{document:{required:!0,filesize:1e9},sharingOption:{required:!0}},messages:{document:{required:getErrorMessage("field.empty"),filesize:"File must be less than 1 GB."},sharingOption:{required:"Please select a sharing option."}}}))}return{init:function(o,a,d,r,c,s){e=o,a,t=d,r,n=c,s&&(i=s)},initCompanyName:function(){$.ajax({type:"GET",contentType:"json",url:i("#companyNameUrl").attr("href"),success:function(e){i("#companyName").text(e)},error:function(){i("#companyName").text("My company")}})},initDocumentList:function(e,t,n,o,a,i){return r(0,t,n,o,a,i)},initUploadForm:function(n,a,d,r,c,u){return function(n,a,d,r,c,u){s(),i(":file").each(function(e,t){var n=$(t).attr("data-buttonText"),o="true"==$(t).attr("data-icon");$(t).filestyle({icon:o,buttonText:n})}),i("input[type='radio']").styler(),i("#uploadDocumentForm").submit(function(){return!!$(this).valid()&&($(r).hide(),$("#content").addClass("loading"),i("#uploadDocumentBtn").prop("disabled",!0),$.ajax({url:c+"upload?hashKey="+d+"&databaseId="+a,type:"POST",enctype:"multipart/form-data",data:new FormData(this),processData:!1,contentType:!1,beforeSend:function(e){o.csrf(e)},success:function(t){i(".modal").modal("hide"),i("#uploadDocumentBtn").prop("disabled",!1),u(1),e().widgets.documentList&&e().widgets.documentList.api().ajax.reload(),$("#content").removeClass("loading"),$(r).show()},error:function(e){i(".modal").modal("hide"),i("#uploadDocumentBtn").prop("disabled",!1),$("#content").removeClass("loading"),$(r).show(),o.onAjaxError(e,function(){t({action:"add",placeSelector:".documents",message:e.responseText,closable:{timer:45e3,btn:!0}})})}}),!1)}),i(".modal").on("hide.bs.modal",function(){i("#uploadDocumentForm")[0].reset(),i("input[type='radio']").trigger("refresh")})}(0,a,d,r,c,u)},setDocumentListPanelEvents:function(t,n,r,s,u,l,m,f){return function(t,n,r,s,u,l,m,f){i("#docSearchBtn").on("click",function(t){return e().widgets.documentList.api().ajax.reload(),!1}),i("#deleteDocsBtn").on("click",function(e){c({operationName:"delete"},0,n,r,s,u,l)}),i("#downloadDocsBtn").on("click",function(e){c({operationName:"download"},0,n,r,s,u,l)}),i("#"+f).on("click",function(t){var n=e().widgets.documentList.fnSettings().oInit.store.items,i=[],d=[];n.forEach(function(e){-1!=e.indexOf("ccd")||-1!=e.indexOf("facesheet")?d.push(e):i.push(e)});var r=$(this).attr("data-ajax-url-tmpl"),c=$(this).attr("data-ajax-url-vars"),s=$(this).attr("data-ajax-url-params")+"&clinical="+d+"&documentIds="+i+"&isCCModule="+m,u=o.getUrl(r,c,s);return a.route(u),!1});var p=function(e,t){var n=$(e.target);t>0?(n.find(".badgeValue").html(t),n.removeClass("hidden")):(n.find(".badgeValue").html(0),n.addClass("hidden"))},h=e();h.widgets.documentList.fnSettings().oInit.store.onCountChanged(d(".documents button .badge"),p),h.widgets.documentList.fnSettings().oInit.store.onCountChanged(d(".documents a .badge"),p)}(0,n,r,s,u,l,m,f)}}}();