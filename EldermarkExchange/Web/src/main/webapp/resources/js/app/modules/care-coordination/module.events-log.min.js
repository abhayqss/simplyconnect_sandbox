ExchangeApp.modules.CareCoordinationEventsLog=function(){function e(){o().random=D.rand(),function(e,t){var n=o(),a=e||n.$html,i=t||n.random;a=D.randomize(a,i,!1)}(),function(e,t){var n=o();n.ajaxMap||(n.ajaxMap={});var a=e||n.$html,i=t||n.random,r=D.findAjaxUrls(a,i);$.each(r,function(e,t){n.ajaxMap[d(t,{params:!0})]=t}),D.find(a,i,'[data-ajax-load="true"]').on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),t=$(this).attr("data-ajax-url-vars"),n=$(this).attr("data-ajax-url-params"),a=D.getUrl(e,t,n);return y.route(a),!1}),D.find(a,i,'[data-ajax-anchor="true"]').on("click",function(){var e=$($(this).attr("href"));return e.length&&$("html, body").animate({scrollTop:e.offset().top},200),!1})}()}function t(){f=!0,$("#incidentReportPopup").css({display:"none"}),o().widgets.eventNotificationList=C.grid(o().$html,"",{tableId:"eventNotificationList",totalDisplayRows:25,callbacks:{rowCallback:function(e,t,n){var a=$(e);t&&a.children("td:eq(0)").html(moment(t.dateTime).format("<b>MM/DD/YYYY</b> <br/> hh:mm A")),a.popover({html:!0,content:t.sentToText+" with text : "+t.details,trigger:"hover",delay:300,placement:function(){return a.addClass("hasPopover"),"top"}})},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()}}}),o().widgets.eventNotificationList.api().ajax.reload()}function n(){s("#dateFrom").datepicker(),s("#dateTo").datepicker(),s("#dateFrom,#dateTo").change(function(){var e=new Date($(this).val());isNaN(e.getTime())?$(this).val(""):$(this).datepicker("setValue",e)}),s(".event-filter-from input[type=checkbox]").each(function(){$(this).styler()})}function a(){m=null,o().widgets.eventList=function(e){var t=o();return C.grid(t.$html,t.random,e)}({tableId:"eventList",searchFormId:"eventsFilterFrom",totalDisplayRows:25,selectable:{type:"single"},callbacks:{rowCallback:function(e,t,n){var a=$(e);if(null!==t){var o=t.eventId;a.children("td:eq(0)").html('<div class="col-md-8">'+t.residentName+" <br/> "+t.eventType+'</div><div class="col-md-4"> '+moment(t.eventDate).format("<b>MM/DD/YYYY</b> <br/> hh:mm A")+"</div>"),a.attr("data-id",o),a.on("click",function(){i(o)})}},drawCallback:function(e){if(b.params&&b.params.id){var t=s("[data-id='"+b.params.id+"']");0!==t.length&&t.addClass("selected")}else s("#eventDetails").hide()},errorCallback:function(e){alert(e.responseText)},footerCallback:function(e,t,n,a,i){$(e).hide()},headerCallback:function(e,t,n,a,i){$(e).hide()}}}),o().widgets.eventList.api().ajax.reload(),h=ExchangeApp.modules.Header.getCurrentOrganizationFilter(),v=ExchangeApp.modules.Header.getCurrentCommunityFilter()}function i(e,n){$.ajax({type:"GET",url:"care-coordination/events-log/event/"+e+"/event-details",headers:{"X-Content-Compressing":"enabled"}}).success(function(a){var r=s("#eventDetails");r.empty(),r.append(a),r.show(),t(),r.find("#downloadBtn").on("click",function(t){$.fileDownload("care-coordination/events-log/event/"+e+"/download-pdf",{})}),r.find("#incidentReport").on("click",function(e){$("#incidentReportPopup").css({display:"flex"})}),r.on("click",function(e){$(e.target).closest("#incidentReport").length||$("#incidentReportPopup").css({display:"none"})});var d=r.find("#editIncidentReport");if(d.length){var f=d.data("reportId");l(D.find(o().$html,"","#editIncidentReport"),"",e,f)}else l(D.find(o().$html,"","#createIncidentReport"),"",e);var m=r.find("#viewIncidentReport");m.length&&m.on("click",function(t){var n=(new Date).getTimezoneOffset();window.open("ir/events/"+e+"/pdf-incident-report?timeZoneOffset="+n)}),function(e,t,n,a,i){var r=D.find(o().$html,"","#noteContainer");e.on("click",function(){var e=$(this);if(!e.hasClass("pending"))return e.addClass("pending"),$.ajax(t).success(function(t){r.empty(),r.append(t),r.find('[id^="lastModifiedDate"]').datetimepicker({defaultDate:new Date,format:"YYYY-MM-DD hh:mm A Z",maxDate:new Date}),r.find('[id^="encounterDate"]').datetimepicker({defaultDate:new Date,format:"MM/DD/YYYY"}),r.find('[id^="from"]').timepicker({timeFormat:"h:mm p",interval:30,minTime:"00",maxTime:"11:30pm",defaultTime:c(r,new Date),startTime:"12:00am",dynamic:!1,dropdown:!0,scrollbar:!0}),r.find('[id^="to"]').timepicker({timeFormat:"h:mm p",interval:30,minTime:"00",maxTime:"11:30pm",defaultTime:c(r,new Date),startTime:"12:00am",dynamic:!1,dropdown:!0,scrollbar:!0}),D.randomize(r,o().random,!1);var d=D.find(r,o().random,"#noteModal");D.find(r,o().random,"#lastModifiedDate").datetimepicker({defaultDate:new Date,format:"YYYY-MM-DD hh:mm A Z",maxDate:new Date}),r.find('[id^="timeZoneOffset"]').val((new Date).getTimezoneOffset());var s=r.find('[id^="subTypeId"]'),l=r.find('[id^="noteResidentAdmittanceHistoryDtoId"]'),f=r.find('[id^="from"]'),m=r.find('[id^="to"]');u(r),f.on("blur",function(){window.setTimeout(function(){u(r,!0)},500)}),m.on("blur",function(){window.setTimeout(function(){u(r,!1)},500)}),s.on("change",function(){var e=$(this).find(":selected");$.inArray(e.attr("data-encounter-code"),A)>=0?(l.attr("disabled","disabled"),r.find('*[id^="encounter-note-type-content"]').show()):r.find('*[id^="encounter-note-type-content"]').hide()});s=D.find(r,o().random,"#subTypeId");1===(l=D.find(r,o().random,"#noteResidentAdmittanceHistoryDtoId")).children("option").length?(l.attr("disabled","disabled"),s.find("[data-follow-up-code]").attr("disabled","disabled"),s.find("[data-follow-up-code]").attr("title",'Please add the admittance information or the intake date on the "Patient Details" screen')):(s.on("change",function(){var e=$(this).find(":selected");$.inArray(e.attr("data-encounter-code"),A)>=0?(l.attr("disabled","disabled"),r.find('*[id^="encounter-note-type-content"]').show()):r.find('*[id^="encounter-note-type-content"]').hide(),-1===$.inArray(e.attr("data-follow-up-code"),k)?(l.prop("selectedIndex",0),l.attr("disabled","disabled"),l.blur(),s.children("option").removeAttr("disabled"),s.children("option").removeAttr("title")):(l.removeAttr("disabled"),l.children("option").removeAttr("title"),$.ajax("care-coordination/notes/event/"+n+"/followUp/"+e.attr("data-follow-up-code")+"/getTaken").success(function(t){l.children("option").removeAttr("disabled"),t.forEach(function(t){l.val()==t&&l.prop("selectedIndex",0);var n=l.find("[value="+t+"]");n.attr("disabled","disabled"),n.attr("title",'"'+e.text()+'" note has been already created for this admit/intake date.')})}))}),l.on("change",function(){var e=s.children("option");e.removeAttr("disabled"),e.removeAttr("title"),$(this).val()&&$.ajax("care-coordination/notes/event/"+n+"/admit/"+$(this).val()+"/getTaken").success(function(e){e.forEach(function(e){s.find(":selected").attr("data-follow-up-code")===e&&s.prop("selectedIndex",0);var t=s.find("[data-follow-up-code="+e+"]");t.attr("disabled","disabled"),t.attr("title",'"'+t.text()+'" note has been already created for this admit/intake date.')})})})),function(e){D.find(e,o().random,"#noteForm").validate(new ExchangeApp.utils.wgt.Validation({rules:{subjective:{required:function(t){return D.find(e,o().random,"#objective").is(":blank")&&D.find(e,o().random,"#assessment").is(":blank")&&D.find(e,o().random,"#plan").is(":blank")},maxlength:2e4},objective:{maxlength:2e4},assessment:{maxlength:2e4},plan:{maxlength:2e4},lastModifiedDate:{required:!0},"subType.id":{required:!0},"noteResidentAdmittanceHistoryDto.id":{required:function(e){return!e.disabled}},encounterDate:{required:!0},from:{required:!0},to:{required:!0}},messages:{subjective:{required:getErrorMessage("field.empty")},lastModifiedDate:{required:getErrorMessage("field.empty")},"subType.id":{required:getErrorMessage("field.empty")},"noteResidentAdmittanceHistoryDto.id":{required:getErrorMessage("field.empty")},encouterNoteTypeId:{required:getErrorMessage("field.empty")},encounterDate:{required:getErrorMessage("field.empty")},from:{required:getErrorMessage("field.empty")},to:{required:getErrorMessage("field.empty")}}}))}(r),D.find(r,o().random,"#submitNoteBtn").on("click",function(){var e=D.find(r,o().random,"#noteForm");if(!e.valid())return!1;var t=$(this);return t.hasClass("pending")||(t.addClass("pending"),$.ajax({url:e.attr("action"),data:new FormData(e[0]),type:"POST",enctype:"multipart/form-data",processData:!1,contentType:!1,beforeSend:function(e){D.csrf(e)},success:function(e){d.modal("hide"),bootbox.alert(a,function(){void 0!==i&&i(e)})},error:function(e){D.onAjaxError(e,function(){alert(e.responseText)}),d.modal("hide"),t.removeClass("pending")}}).complete(function(){})),!1}),D.find(r,o().random,".cancelBtn").on("click",function(){return d.modal("hide"),!1}),e.removeClass("pending"),d.modal("show")}).fail(function(t){e.removeClass("pending"),alert(t.responseText)}),!1})}(D.find(o().$html,"","#addEventNote"),"care-coordination/notes/event/"+e+"/new-note",e,"A note has been created",function(t){i(e,function(){D.find(r,o().random,'[data-ajax-url-params^="note='+t+'"].relatedNoteLink').click()})}),D.find(r,o().random,".relatedNoteLink").on("click",function(){var e=$(this).attr("data-ajax-url-tmpl"),t=$(this).attr("data-ajax-url-vars"),n=$(this).attr("data-ajax-url-params"),a=D.getUrl(e,t,n);return y.route(a),!1}),void 0!==n&&n()})}function o(){return g[d(b,{params:!0})]}function r(){return $('[id^="'+x+'"]')}function d(e,t){return D.stringifyUrl(e,t)}function s(e){var t=o();return D.find(t.$html,t.random,e)}function l(e,t,n,a){requirejs(["app/components/care-coordination/events/IncidentReportModal"],function(t){var o=null,r={isOpen:!0,container:document.body,eventId:n,reportId:a,onHide:function(e){o.isReportChanged()&&!o.isReportChangeIgnored()&&(e.preventDefault(),bootbox.confirm({message:"The changes will not be saved",buttons:{confirm:{label:"OK"},cancel:{label:"CANCEL"}},callback:function(e){e&&(o.ignoreReportChange(),setTimeout(function(){o.hide()}))}}))},onSubmitReportSuccess:function(e){o.hide(),r.reportId=e,bootbox.confirm({message:"The updates have been saved. The pdf file sent to a mandated reporting governing body",buttons:{confirm:{label:"View pdf file"},cancel:{label:"Close"}},callback:function(e){if(e){var t=(new Date).getTimezoneOffset();window.open("ir/events/"+n+"/pdf-incident-report?timeZoneOffset="+t)}}}),i(n)},onSubmitReportFailure:function(){bootbox.alert("Cannot save the updates. Please try again later")},onSaveReportDraftSuccess:function(e){o.hide(),r.reportId=e,bootbox.confirm({message:"The incident report has been saved",buttons:{confirm:{label:"Edit"},cancel:{label:"Close"}},callback:function(e){e&&(o=new t(r)).mount()}}),i(n)},onSaveReportDraftFailure:function(){bootbox.alert("Cannot save the incident report. Please try again later")}};e.on("click",function(){(o=new t(r)).mount(),setTimeout(function(){$("#incidentReportPopup").css({display:"none"})})})})}function c(e,t){if(""==e.find('[id^="from"]')[0].value&&""==e.find('[id^="to"]')[0].value){var n=t.getMinutes(),a=t;if(0!=n){var i=n>30?60-n:30-n;a=new Date(t.getTime()+6e4*i)}return function(e){var t=e.getHours(),n=e.getMinutes(),a=t>=12?"pm":"am";return t%=12,t=t||12,n=n<10?"0"+n:n,t+":"+n+" "+a}(a)}}function u(e,t){var n=e.find('[id^="from"]'),a=e.find('[id^="to"]'),i=e.find('[id^="totalTimeSpent"]'),o=e.find('[id^="range"]'),r=e.find('[id^="unit"]'),d=moment(n.val(),"hh:mm A");t&&(s=moment(d).add(30,"minutes").format("h:mm A"),a.val(s));var s=moment(a.val(),"hh:mm A"),l=moment.duration(s.diff(d)).asMinutes();l<1&&(s=moment(d).add(30,"minutes").format("h:mm A"),a.val(s),l=30),i.val(l);var c=Math.floor(l/15);l%15>7&&(c+=1);var u=15*c-7,f=15*c+7;u<0&&(u=0),o.val(u+" mins - "+f+" mins"),r.val(c)}var f,m,p,h,v,g={},b={template:"care-coordination/events-log"},w={reloadNeeded:!0},x="eventsLogTabContent",y=ExchangeApp.routers.ModuleRouter,D=ExchangeApp.utils.module,C=ExchangeApp.utils.wgt,T=ExchangeApp.loaders.FragmentLoader.init("careCoordinationEventsLog"),k=["CM_24H","CM_14D","CM_ADDITIONAL"],A=["FACE_TO_FACE_ENCOUNTER","NON_FACE_TO_FACE_ENCOUNTER"];return $.fn.clearForm=function(){return this.each(function(){var e=this.tagName.toLowerCase();if("form"===e)return $(':input:not([disabled="disabled"] ,[type="hidden"])',this).clearForm();var t=this.type;"text"===t||"password"===t||"textarea"===e?(this.value="",$(this).trigger("refresh")):"select"===e?(this.selectedIndex=0,$(this).trigger("change")):"checkbox"!==t&&"radio"!==t||(this.checked=!1,$(this).trigger("refresh")),this.id==="dateFrom"+o().random&&(this.value=s("#defaultDateFrom").val()),this.id==="dateTo"+o().random&&(this.value=s("#defaultDateTo").val())})},{init:function(i,r){b=i,p=r,this.loadFragment({onFragmentLoaded:function(){e()},onResourcesLoaded:function(){var e=o();if(e.widgets={},n(),a(),this.setEvents(),e.inited=!0,this.render(),b.params&&b.params.id){var i=b.params.id;$.ajax({url:"care-coordination/events-log/event/"+i+"/event-details",success:function(e){s("#eventDetails").empty(),s("#eventDetails").append(e),s("#eventDetails").show(),t();var n=o().widgets.eventList.api().row("[data-id='"+i+"']");0==n.length?$.ajax("care-coordination/events-log/event/"+i+"/page-number").success(function(e){o().widgets.eventList.api().page(e).draw(!1)}):n.nodes().to$().addClass("selected")},error:function(e){bootbox.alert(e.responseText)}})}else s("#eventDetails").hide(),this.show(),this.getParentModule()&&this.getParentModule().show()}})},update:function(e){h===ExchangeApp.modules.Header.getCurrentOrganizationFilter()&&JSON.stringify(v)===JSON.stringify(ExchangeApp.modules.Header.getCurrentCommunityFilter())||ExchangeApp.routers.ModuleRouter.reload(),b=e},getFragment:function(e){return g[d(e,{params:!0})]},isFragmentInited:function(e){var t=this.getFragment(e);return t&&t.inited},loadFragment:function(e){var t=this;T.load({url:b,callbacks:{onFragmentLoaded:function(n){w.reloadNeeded=!1;var a=$(n).find("#content").children(),i=d(b,{params:!0});g[i]={$html:a,url:D.clone(b)},e.onFragmentLoaded.apply(t)},onResourcesLoaded:function(){e.onResourcesLoaded.apply(t)}}})},render:function(){var e=o().$html;r().empty(),r().append(e)},hide:function(){$.each($("#care-coordination").find(".eventTabs"),function(){if($(this).hasClass("active")){switch($(this).attr("id")){case"eventsDescriptionTab":m="eventsDescriptionContent";break;case"sentNotificationsTab":m="sentNotificationsContent"}}}),r().hide(),$("#content").addClass("loading")},show:function(){0==$("#content").find(".tab-pane:visible").length&&($.each($("#care-coordination").find(".nav li"),function(){$(this).removeClass("active")}),$('a[data-target^="#'+x+'"]').parent("li").addClass("active"),r().show()),m&&$('a[href^="#'+m+'"]').parent("li").addClass("active"),$("#content").removeClass("loading")},setEvents:function(){return s("#eventSearch").on("click",function(){return o().widgets.eventList.api().ajax.reload(),!1}),s("#eventSearchClear").on("click",function(){return s("#eventsFilterFrom").clearForm(),!1}),!1},reloadNeeded:function(){return w.reloadNeeded},getParentModule:function(){return p}}}();