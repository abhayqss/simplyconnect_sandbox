define(["underscore","redux","redux-utils",path("app/lib/Utils"),path("app/lib/Constants"),path("./IncidentLevelReportingSettingsModal"),path("app/redux/event/details/eventDetailsActions"),path("app/redux/event/incident/report/form/incidentReportFormActions"),path("app/redux/event/incident/report/details/incidentReportDetailsActions"),path("app/redux/event/incident/report/initialized/incidentReportInitializedActions"),path("app/redux/profile/details/profileDetailsActions"),path("app/redux/patient/diagnosis/list/patientDiagnosisListActions"),path("app/redux/patient/medication/active/list/patientActiveMedicationListActions"),path("app/redux/patient/medication/inactive/list/patientInactiveMedicationListActions"),path("app/redux/directory/race/list/raceListActions"),path("app/redux/directory/state/list/stateListActions"),path("app/redux/directory/gender/list/genderListActions"),path("app/redux/directory/incident/type/list/incidentTypeListActions"),path("app/redux/directory/incident/place/list/incidentPlaceListActions"),path("app/redux/directory/classMember/type/list/classMemberTypeListActions"),path("app/redux/directory/incident/level/reporting/settings/incidentLevelReportingSettingsActions")],function(e,t,i,n,a,d,o,s,r,l,c,p,h,u,m,v,f,g,y,I,x){function b(e,t){for(var i=null,n=0;n<e.length;n++){var a=e[n];if(a.id===t?i=a:a.incidentTypes&&(i=b(a.incidentTypes,t)),i)break}return i}function C(t,i,n,a){return e.map(t,function(t){var d=t[n];t=$.extend({},t,{isChecked:e.isArray(i)?e.any(i,function(e){return e[n]===d}):i===d});var o=a&&t[a];return o&&(t[a]=C(o,i,n,a)),t})}function S(e){var t=e.onChange,i={"<>":"input",type:"checkbox",name:e.name,value:e.value,onchange:function(i){t&&t(e.value,$(i.event.target).prop("checked"))}};return e.checked&&(i.checked=!0),e.tooltipPosition&&(i["data-tooltip-position"]=e.tooltipPosition),i}function A(e){var t=e.onChange,i={"<>":"input",type:"radio",name:e.name,value:e.value,onchange:function(i){t&&t(e.name,e.value,$(i.event.target).prop("checked"))}};return e.checked&&(i.checked=!0),e.tooltipPosition&&(i["data-tooltip-position"]=e.tooltipPosition),i}function D(t){var i=t.id,a=t.level,d=t.isChecked,o={"<>":"div",class:"checkbox incident-type",html:[{"<>":"label",html:[S({value:i,name:"level"+a,checked:d,onChange:function(e,i){t.onChange(a,e,null,i)}}),{"<>":"span",text:t.title}]},t.isFreeText?{"<>":"div",class:"form-group incident-type__text",html:[{"<>":"input",name:"incidentTypeText",type:"text",class:"form-control",placeholder:"",value:t.text||"",onchange:function(e){t.onChange(a,i,$(e.event.target).prop("value"),d)}}]}:void 0]};return t.incidentTypes?{"<>":"div",html:[o,{"<>":"div",class:n.interpolate("incident-level-$0-section__specific-incident-types",a),html:[e.map(t.incidentTypes,function(e){return D($.extend({},e,{onChange:t.onChange}))})]}]}:o}function P(e,t){return{"<>":"h5",html:[{"<>":"div",class:n.interpolate("incident-level-$0-types-section__title",e),text:["Level I – Urgent; Critical Incident","Level II – Serious; Reportable Incident","Level III – Significant; Reportable Incident"][e-1]},{"<>":"button",type:"button",class:n.interpolate("incident-level-$0-types-section__incident-reporting-settings",e),html:[{"<>":"img",src:w,class:n.interpolate("incident-level-$0-types-section__incident-reporting-settings-icon",e)}],onclick:function(){t(e)}}],class:n.interpolate("section__header incident-level-$0-types-section__header",e)}}function T(){Form.apply(this,arguments),this.validator=null;var e=this.props.data;this.state={count:0,isValid:!0,isDraft:!1,isLoading:!1,isChanged:!1,isInitialized:!1,arePlainFieldsUpdated:!1,areReportDetailsLoaded:!1,isInitializedReportLoaded:!1,areClassMemberTypesLoaded:!1,areGendersLoaded:!1,areRacesLoaded:!1,areIncidentPlacesLoaded:!1,areIncidentTypesLoaded:!1,areStatesLoaded:!1,data:$.extend({activeMedications:[],currentDiagnoses:[],wereIndividualsInvolvedInIncident:!1,incidentPlaces:[],incidentInvolvedIndividuals:[],level1IncidentTypes:[],level2IncidentTypes:[],level3IncidentTypes:[]},e)}}var L=ExchangeApp.info.context,R=L+"/resources/images/add-button-rounded.svg",_=L+"/resources/images/trash.svg",w=L+"/resources/images/info-tip-gray.svg",M=(n.Date.format,n.Date.formats.americanMediumDate,[1,2,3]),q=["id","clientName","clientClassMemberId","clientRIN","clientBirthDate","clientGenderId","clientRaceId","clientTransitionToCommunityDate","clientClassMemberCurrentAddress","agencyName","agencyAddress","qualityAdministrator","careManagerOrStaffWithPrimServRespAndTitle","careManagerOrStaffPhone","careManagerOrStaffEmail","mcoCareCoordinatorAndAgency","mcoCareCoordinatorPhone","mcoCareCoordinatorEmail","wereIndividualsInvolvedInIncident","incidentDateTime","incidentDiscoveredDate","wasProviderPresentOrScheduled","wasIncidentCausedBySubstance","incidentNarrative","agencyResponseToIncident","reportAuthor","reportCompletedDate","reportDate"];return T.prototype=Object.create(Form.prototype),T.prototype.constructor=T,T.prototype.getDefaultProps=function(){return $.extend({},{fields:{},isReadonly:!1,currentUser:null,onLoading:function(){}})},T.prototype.componentDidMount=function(){Form.prototype.componentDidMount.apply(this),this.isNew()?this.loadInitializedReport():this.loadReportDetails(),this.$element.find('input[type="checkbox"], input[type="radio"]').styler();var e=this.props.isReadonly,t=this;this.$element.find('input[data-type="date"], input[data-type="datetime"]').each(function(){var e=$(this),i=e.data("type"),n=e.attr("name"),a={format:"MM/DD/YYYY",keepOpen:!0};"datetime"===i&&(a.sideBySide=!0,a.format="MM/DD/YYYY hh:mm A"),"clientBirthDate"===n&&(a.maxDate="now"),e.datetimepicker(a).on("dp.change",function(e){t.state.arePlainFieldsUpdated&&t.onChange(e)})}),this.$element.find(".info-tip").popover(),this.$element.find("input, select, textarea").each(function(){var t=$(this);t.is('textarea[data-autoresizable="true"]')&&t.autoresize(),e&&t.attr(t.is("select")?"disabled":"readonly","true")}),this.addOnChangeHandler(function(e){t.onChange(e)})},T.prototype.componentDidUpdate=function(t,i){this.updateLoading();this.state.isInitialized&&!i.isInitialized&&this.updatePlainFields();var n=this.state.areReportDetailsLoaded,a=this.state.isInitializedReportLoaded;(n&&!i.areReportDetailsLoaded||a&&!i.isInitializedReportLoaded)&&(this.init(),this.loadClassMemberTypes(),this.loadGenders(),this.loadRaces(),this.loadIncidentPlaces(),this.loadIncidentTypes(),this.loadStates());var d=this.state.data;!i.data.activeMedications.length&&d.activeMedications.length&&this.updateActiveMedicationsPanel(),!i.data.currentDiagnoses.length&&d.currentDiagnoses.length&&this.updateCurrentDiagnosesPanel();this.state.areClassMemberTypesLoaded&&!i.areClassMemberTypesLoaded&&this.updateClassMemberTypesSection();this.state.areStatesLoaded&&!i.areStatesLoaded&&this.updateAgencyStateField();this.state.areGendersLoaded&&!i.areGendersLoaded&&this.updateClientGenderField();this.state.areRacesLoaded&&!i.areRacesLoaded&&this.updateClientRaceField();this.state.areIncidentPlacesLoaded&&!i.areIncidentPlacesLoaded&&this.updateIncidentPlacesField(),d.incidentPlaces!==i.data.incidentPlaces&&this.updateIncidentPlacesField(),d.wereIndividualsInvolvedInIncident&&!i.data.wereIndividualsInvolvedInIncident&&(this.setVisibleAddIncidentInvolvedIndividualBtn(!0),this.setVisibleIncidentInvolvedIndividuals(!0)),!d.wereIndividualsInvolvedInIncident&&i.data.wereIndividualsInvolvedInIncident&&(this.setVisibleAddIncidentInvolvedIndividualBtn(!1),this.setVisibleIncidentInvolvedIndividuals(!1)),d.incidentInvolvedIndividuals!==i.data.incidentInvolvedIndividuals&&(this.updateIncidentInvolvedIndividuals(),d.wereIndividualsInvolvedInIncident&&this.triggerWereIndividualsInvolvedInIncidentField(!0));if(this.state.areIncidentTypesLoaded&&!i.areIncidentTypesLoaded){var o=this;e.each(M,function(e){o.updateIncidentLevelSection(e)})}d.level1IncidentTypes!==i.data.level1IncidentTypes&&this.updateIncidentLevelSection(1);d.level2IncidentTypes!==i.data.level2IncidentTypes&&this.updateIncidentLevelSection(2);d.level3IncidentTypes!==i.data.level3IncidentTypes&&this.updateIncidentLevelSection(3)},T.prototype.onChange=function(e){var t=$(e.target),i=t.attr("data-type")||t.attr("type");if(!["radio","checkbox"].includes(i)){var n=t.attr("name"),a=t.val();["date","datetime"].includes(i)&&(a=e.date.toDate().getTime()),this.changeField(n,a)}},T.prototype.onSubmit=function(e){this.setDraft(!1);var t=this;this.isValid().then(function(e){e&&t.submit()})},T.prototype.onSaveDraft=function(e){this.setDraft();var t=this;this.isValid().then(function(e){e&&t.saveDraft()})},T.prototype.onAddIncidentInvolvedIndividual=function(){this.addIncidentInvolvedIndividual({})},T.prototype.onIncidentLevelReportingSettings=function(e){this.incidentLevelReportingSettingsModal=new d({container:document.body,level:e,isOpen:!0}),this.incidentLevelReportingSettingsModal.mount()},T.prototype.addIncidentInvolvedIndividual=function(t){var i=this.state.data,n=i.incidentInvolvedIndividuals;this.setState({data:$.extend({},i,{incidentInvolvedIndividuals:e.union(n,[{index:n.length||0,name:t.name||"",relationship:t.relationship||"",phone:t.phone||""}])})}),this.registerChange()},T.prototype.removeIncidentInvolvedIndividual=function(t){var i=$.extend({},this.state.data),n=e.filter(i.incidentInvolvedIndividuals,function(e,i){return i!==t});i.incidentInvolvedIndividuals=e.map(n,function(e,t){return $.extend({},e,{index:t})}),this.setState({data:i}),this.registerChange()},T.prototype.changeIncidentInvolvedIndividual=function(t,i,n){var a=$.extend({},this.state.data),d={};d[i]=n;var o=a.incidentInvolvedIndividuals;a.incidentInvolvedIndividuals=e.map(o,function(e,i){return i===t?$.extend({},e,d):e}),this.setState({data:a}),this.registerChange()},T.prototype.changeIncidentPlace=function(t,i,n){var a=$.extend({},this.state.data),d=a.incidentPlaces;if(n||i){var o=e.findWhere(d,{id:t});o?o.text=i:a.incidentPlaces=e.union(d,[{id:t,text:i||""}])}else a.incidentPlaces=e.reject(d,function(e){return e.id===t});this.setState({data:a}),this.registerChange()},T.prototype.changeIncidentTypesField=function(t,i,a,d){var o=$.extend({},this.state.data),s=n.interpolate("level$0IncidentTypes",t),r=o[s];if(d||a){var l=e.findWhere(r,{id:i});l?l.text=a:o[s]=e.union(r,[{id:i,text:a||""}])}else o[s]=e.reject(r,function(e){return e.id===i});this.setState({data:o}),this.registerChange()},T.prototype.getStore=function(){return ExchangeApp.redux.store},T.prototype.addOnChangeHandler=function(e){this.$element.on("change",e)},T.prototype.changeField=function(e,t){var i=$.extend({},this.state.data);i[e]=t,this.setState({data:i}),this.registerChange()},T.prototype.loadReportDetails=function(){var e=this;this.props.actions.event.incident.report.details.load(this.props.reportId).then(function(){e.setState({areReportDetailsLoaded:!0})})},T.prototype.loadInitializedReport=function(){var e=this;this.props.actions.event.incident.report.initialized.load(this.props.eventId).then(function(){e.setState({isInitializedReportLoaded:!0})})},T.prototype.changeFields=function(e){this.setState({data:$.extend({},this.state.data,e)}),this.registerChange()},T.prototype.addValidation=function(){function t(e){return"Please enter at least "+e+" symbols."}function i(e){return"Please enter no more than "+e+" symbols."}var a=this.state.isDraft,d={clientClassMemberTypeId:{required:!0},clientRIN:{required:!a,maxlength:256},clientBirthDate:{required:!0},clientGenderId:{required:!0},clientRaceId:{required:!0},clientTransitionToCommunityDate:{required:!a},clientClassMemberCurrentAddress:{required:!a,maxlength:256},agencyName:{required:!a,maxlength:256},agencyAddress:{required:!a,maxlength:256},qualityAdministrator:{required:!a,maxlength:256},careManagerOrStaffWithPrimServRespAndTitle:{required:!a,maxlength:256},careManagerOrStaffPhone:{required:!a,digits:!0,maxlength:16},careManagerOrStaffEmail:{required:!a,emails:!0},mcoCareCoordinatorAndAgency:{required:!a,maxlength:256},mcoCareCoordinatorPhone:{required:!a,digits:!0,maxlength:16},mcoCareCoordinatorEmail:{required:!a,emails:!0},incidentDateTime:{required:!a},incidentDiscoveredDate:{required:!a},wasProviderPresentOrScheduled:{required:!a},incidentPlaces:{required:!a},incidentNarrative:{maxlength:2e4},agencyResponseToIncident:{maxlength:2e4},reportAuthor:{required:!0,maxlength:256},reportCompletedDate:{required:!0},reportDate:{required:!0}};e.each(this.state.data.incidentInvolvedIndividuals,function(e,t){d[n.interpolate("individual-$0-name",t)]={required:!0,maxlength:512},d[n.interpolate("individual-$0-relationship",t)]={required:!0,maxlength:256},d[n.interpolate("individual-$0-phone",t)]={required:!0,digits:!0,maxlength:16}});var o=getErrorMessage("field.empty"),s=getErrorMessage("field.digits"),r=getErrorMessage("field.email"),l=i(256),c=i(512),p=i(2e4),h=(t(16),i(16)),u=(t(5),i(5),{clientClassMemberTypeId:{required:o},clientRIN:{required:o,maxlength:l},clientBirthDate:{required:o},clientGenderId:{required:o},clientRaceId:{required:o},clientTransitionToCommunityDate:{required:o},clientClassMemberCurrentAddress:{required:o,maxlength:l},agencyName:{required:o,maxlength:l},agencyAddress:{required:o,maxlength:l},qualityAdministrator:{required:o,maxlength:l},careManagerOrStaffWithPrimServRespAndTitle:{required:o,maxlength:l},careManagerOrStaffPhone:{required:o,digits:s,maxlength:h},careManagerOrStaffEmail:{required:o,emails:r},mcoCareCoordinatorAndAgency:{required:o,maxlength:l},mcoCareCoordinatorPhone:{required:o,digits:s,maxlength:h},mcoCareCoordinatorEmail:{required:o,emails:r},incidentDateTime:{required:o},incidentDiscoveredDate:{required:o},wasProviderPresentOrScheduled:{required:o},incidentPlaces:{required:o},incidentNarrative:{maxlength:p},agencyResponseToIncident:{maxlength:p},reportAuthor:{required:o,maxlength:l},reportCompletedDate:{required:o},reportDate:{required:o}});e.each(this.state.data.incidentInvolvedIndividuals,function(e,t){u[n.interpolate("individual-$0-name",t)]={required:o,maxlength:c},u[n.interpolate("individual-$0-relationship",t)]={required:o,maxlength:l},u[n.interpolate("individual-$0-phone",t)]={required:o,digits:s,maxlength:h}}),this.validator=this.$element.validate(new ExchangeApp.utils.wgt.Validation({position:"top",rules:d,messages:u}))},T.prototype.updateValidation=function(e){this.validator&&this.validator.destroy(),this.addValidation()},T.prototype.isNew=function(){return n.isEmpty(this.props.reportId)},T.prototype.isValid=function(){var e=this;return n.defer().then(function(){e.updateValidation();var t=e.$element.valid();return e.setState({isValid:t,count:e.state.count+1}),t||e.props.onValidationError(),t})},T.prototype.updateLoading=function(){var e=this.state,t=(e.areReportDetailsLoaded||e.isInitializedReportLoaded)&&e.areClassMemberTypesLoaded&&e.areGendersLoaded&&e.areRacesLoaded&&e.areIncidentPlacesLoaded&&e.areIncidentTypesLoaded&&e.areStatesLoaded;e.isLoading&&t&&(this.props.onLoading(!1),this.setState({isLoading:!1})),e.isLoading||t||(this.props.onLoading(!0),this.setState({isLoading:!0}))},T.prototype.shouldValidate=function(){return this.state.count>0&&!this.state.isValid},T.prototype.scrollToStart=function(){$(this.props.container).scrollTo(this.$element.find(".start-anchor"),500)},T.prototype.loadStates=function(){var e=this;this.props.actions.directory.state.list.load().then(function(){e.setState({areStatesLoaded:!0})})},T.prototype.loadIncidentTypes=function(){var e=this;this.props.actions.directory.incident.type.list.load().then(function(){e.setState({areIncidentTypesLoaded:!0})})},T.prototype.loadIncidentPlaces=function(){var e=this;this.props.actions.directory.incident.place.list.load().then(function(){e.setState({areIncidentPlacesLoaded:!0})})},T.prototype.loadClassMemberTypes=function(){var e=this;this.props.actions.directory.classMember.type.list.load().then(function(){e.setState({areClassMemberTypesLoaded:!0})})},T.prototype.loadGenders=function(){var e=this;this.props.actions.directory.gender.list.load().then(function(){e.setState({areGendersLoaded:!0})})},T.prototype.loadRaces=function(){var e=this;this.props.actions.directory.race.list.load().then(function(){e.setState({areRacesLoaded:!0})})},T.prototype.updateClassMemberTypesSection=function(){var t=this,i=this.$element.find(".class-member-types-section");i.empty();var n=this.state.data.clientClassMemberTypeId,a=this.props.directory.classMember.type.list.dataSource.data;e.each(a,function(e){i.json2html({},{"<>":"div",class:"radio",html:[{"<>":"label",html:[A({value:e.id,name:"clientClassMemberTypeId",checked:n===e.id,onChange:function(e,i){t.changeField(e,i),t.shouldValidate()&&t.isValid()}}),{"<>":"span",text:e.label}]}]})}),i.find('input[type="checkbox"], input[type="radio"]').styler()},T.prototype.updateClientGenderField=function(){var t=this.props.directory.gender.list.dataSource.data;if(t){var i=this.state.data.clientGenderId,n=$(this.getElement("clientGenderId")).empty();e.each(e.union([{label:"Select"}],t),function(e){var t={"<>":"option",value:e.id,text:e.label||""};"Select"===e.label&&$.extend(t,{value:"",hidden:!0},!i&&{selected:!0}),e.id===i&&$.extend(t,{selected:!0}),n.json2html({},t)})}},T.prototype.updateClientRaceField=function(){var t=this.props.directory.race.list.dataSource.data;if(t){var i=this.state.data.clientRaceId,n=$(this.getElement("clientRaceId")).empty();e.each(e.union([{label:"Select"}],t),function(e){var t={"<>":"option",value:e.id,text:e.label||""};"Select"===e.label&&$.extend(t,{value:"",hidden:!0},!i&&{selected:!0}),e.id===i&&$.extend(t,{selected:!0}),n.json2html({},t)})}},T.prototype.updateIncidentPlacesField=function(){var t=this.props.directory.incident.place.list.dataSource.data;if(t){var i=this.$element.find(".incident-place-list");i.empty();var a=this.state.data.incidentPlaces,d=this;e.each(t,function(t){var o=e.findWhere(a,{id:t.id})||{};i.json2html({},function(e){var t=e.id,i=e.isChecked;return{"<>":"div",class:"checkbox incident-place",html:[{"<>":"label",html:[S({value:t,name:"incidentPlaces",checked:i,tooltipPosition:"right",onChange:function(t,i){e.onChange(t,null,i)}}),{"<>":"span",text:e.label||""}]},e.isFreeText?{"<>":"div",class:"form-group incident-place__text",html:[{"<>":"input",name:"incidentPlaceText",type:"text",class:"form-control",placeholder:"",value:e.text||"",onchange:function(n){e.onChange(t,$(n.event.target).prop("value"),i)}}]}:void 0]}}($.extend({},t,o,{isChecked:n.isNotEmpty(o),onChange:function(e,t,i){d.changeIncidentPlace(e,t,i),d.shouldValidate()&&d.isValid()}})))}),i.find('input[type="checkbox"], input[type="radio"]').styler()}},T.prototype.setVisibleAddIncidentInvolvedIndividualBtn=function(e){var t=this.$element.find(".add-incident-involved-individual-btn");e?t.show():t.hide()},T.prototype.setVisibleIncidentInvolvedIndividuals=function(e){var t=this.$element.find(".individual");e?t.show():t.hide()},T.prototype.updateIncidentInvolvedIndividuals=function(){var t=this.$element.find(".incident-involved-individuals-section");t.find(".individual").remove();var i=this;e.each(this.state.data.incidentInvolvedIndividuals,function(e,a){t.json2html({},function(e){var t=e.index,i=e.onChange;return{"<>":"div",class:"row individual",html:[{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"First and last name"},{"<>":"input",name:n.interpolate("individual-$0-name",t),type:"text",class:"form-control",placeholder:"",value:e.name||"",onchange:function(e){e.event.stopPropagation(),i(t,"name",$(e.event.target).val())}}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Relationship"},{"<>":"input",name:n.interpolate("individual-$0-relationship",t),type:"text",class:"form-control",placeholder:"",value:e.relationship||"",onchange:function(e){e.event.stopPropagation(),i(t,"relationship",$(e.event.target).val())}}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Phone #"},{"<>":"input",name:n.interpolate("individual-$0-phone",t),type:"text",class:"form-control",placeholder:"",value:e.phone||"",onchange:function(e){e.event.stopPropagation(),i(t,"phone",$(e.event.target).val())}}]}]},{"<>":"a",class:"remove-button individual-remove-button",onclick:function(){e.onRemove(e.index)},html:[{"<>":"img",src:_,class:"individual-remove-button__icon"}]}]}}($.extend({},{index:a},e,{onChange:function(e,t,n){i.changeIncidentInvolvedIndividual(e,t,n)},onRemove:function(e){i.removeIncidentInvolvedIndividual(e)}})))})},T.prototype.updateCurrentDiagnosesPanel=function(){var t=this.state.data.currentDiagnoses;if(t){var i=this.$element.find(".incident-report-form__diagnoses");i.empty(),e.each(t,function(e){i.json2html({},function(e){return{"<>":"div",class:"incident-report-form__diagnosis",text:e||""}}(e))})}},T.prototype.updateActiveMedicationsPanel=function(){var t=this.state.data.activeMedications;if(t){var i=this.$element.find(".incident-report-form__medications");i.empty(),e.each(t,function(e){i.json2html({},function(e){return{"<>":"div",class:"incident-report-form__medication",text:e||""}}(e))})}},T.prototype.updatePlainFields=function(){var t=this.state.data,i=this;e.each(q,function(e){i.$element.find(n.interpolate("input[name=$0],textarea[name=$0]",e)).each(function(){var i=$(this),a=t[e],d=i.attr("data-type")||i.attr("type");["checkbox","radio"].includes(d)?n.convertStringToBoolean(i.val())===a&&i.prop("checked",!0).trigger("refresh"):["date","datetime"].includes(d)?i.data("DateTimePicker").date(new Date(a)):i.val(a)})}),this.setState({arePlainFieldsUpdated:!0})},T.prototype.updateAgencyStateField=function(){var t=this.props.directory.state.list.dataSource.data;if(t){var i=this.state.data.agencyStateId,n=$(this.getElement("agencyStateId")).empty();e.each(e.union([{name:"Select"}],t),function(e){var t={"<>":"option",value:e.id,text:e.name||""};"Select"===e.name&&$.extend(t,{value:"",hidden:!0},!i&&{selected:!0}),e.id===i&&$.extend(t,{selected:!0}),n.json2html({},t)})}},T.prototype.triggerWereIndividualsInvolvedInIncidentField=function(e){var t="input[name=wereIndividualsInvolvedInIncident]";this.$element.find(t+"[value=true]").prop("checked",e).trigger("refresh"),this.$element.find(t+"[value=false]").prop("checked",!e).trigger("refresh")},T.prototype.updateIncidentLevelSection=function(t){t=t||1;var i=this,a=n.interpolate(".level-$0-incident-types-section",t),d=this.$element.find(a);d.empty(),d.json2html({},P(t,this.onIncidentLevelReportingSettings));var o=this.getIncidentTypes({level:t}),s=n.interpolate("level$0IncidentTypes",t),r=this.state.data[s];o=C(o,r,"id","incidentTypes"),e.each(r,function(e){if(e.text){var t=b(o,e.id);t&&(t.text=e.text)}}),e.each(o,function(e){d.json2html({},D($.extend({},e,{onChange:function(e,t,n,a){i.changeIncidentTypesField(e,t,n,a),i.shouldValidate()&&i.isValid()}})))}),d.find('input[type="checkbox"], input[type="radio"]').styler()},T.prototype.setDraft=function(e){this.setState({isDraft:!1!==e})},T.prototype.init=function(){var t=this.isNew()?"initialized":"details",i=this.props.event.incident.report[t].data;if(!n.isEmpty(i)){var a=this,d={reportCompletedDate:(new Date).getTime(),wereIndividualsInvolvedInIncident:n.isNotEmpty(i.incidentInvolvedIndividuals)};e.each(i,function(e,t){n.isEmpty(e)||t.includes("IncidentTypes")||(d[t]=e)}),this.changeFields(d);for(var o=1;o<4;o++){var s=n.interpolate("level$0IncidentTypes",o);n.isEmpty(i[s])||e.each(i[s],function(e){a.changeIncidentTypesField(o,e.id,e.text,!0)})}}this.setState({isInitialized:!0})},T.prototype.getInvalidFields=function(){return this.$element.find("input, select, textarea").filter(".error").parent(".form-group")},T.prototype.submit=function(){var e=this.props.eventId,t=this;this.props.actions.event.incident.report.form.save(e,this.getPreparedData()).then(function(e){t.setState({isChanged:!1},function(){t.props.onSubmitSuccess(e)})}).fail(function(e){t.setState({isChanged:!1},function(){t.props.onSubmitFailure(e)})})},T.prototype.saveDraft=function(){var e=this.props.eventId,t=this;this.props.actions.event.incident.report.form.saveDraft(e,this.getPreparedData()).then(function(e){t.setState({isChanged:!1},function(){t.props.onSaveDraftSuccess(e)})}).fail(function(e){t.setState({isChanged:!1},function(){t.props.onSaveDraftFailure(e)})})},T.prototype.getPreparedData=function(){var e=$.extend({},this.state.data);return e.wereIndividualsInvolvedInIncident||(e.incidentInvolvedIndividuals=[]),e},T.prototype.isChanged=function(){return this.state.isChanged},T.prototype.registerChange=function(){this.state.isInitialized&&this.setState({isChanged:!0})},T.prototype.getIncidentTypes=function(t){return e.where(this.props.directory.incident.type.list.dataSource.data,{level:t.level||1})},T.prototype.render=function(){var e=this,t=(this.props.isReadonly,this.state.data);return{"<>":"form",class:"incident-report-form",html:[{"<>":"div",class:"form-section client-info-section",html:[{"<>":"h3",text:"Client info",class:"section__header client-info-section__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-8",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Class Member's Name"},{"<>":"input",name:"clientName",type:"text",disabled:!0,class:"form-control",placeholder:"",value:t.clientName||""}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group class-member-types-section",html:[]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"RIN"},{"<>":"input",name:"clientRIN",type:"text",class:"form-control",placeholder:"",value:t.clientRIN||""}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Date of Birth"},{"<>":"input",name:"clientBirthDate",type:"text","data-type":"date",class:"form-control",placeholder:"mm/dd/yyyy"},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Gender*"},{"<>":"select",name:"clientGenderId","data-name":"clientGenderId",class:"form-control",placeholder:"Select",html:[]}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Race*"},{"<>":"select",name:"clientRaceId","data-name":"clientRaceId",class:"form-control",placeholder:"Select",html:[]}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Date of Transition to Community"},{"<>":"input",name:"clientTransitionToCommunityDate",type:"text","data-type":"date",class:"form-control",placeholder:"mm/dd/yyyy"},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-8",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Class Member's Current Address"},{"<>":"input",name:"clientClassMemberCurrentAddress",type:"text",class:"form-control",placeholder:"",value:t.clientClassMemberCurrentAddress||""}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",class:"incident-report-form__label",text:"Current Diagnoses"},{"<>":"div",class:"incident-report-form__diagnoses",html:[]}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",class:"incident-report-form__label",text:"Current/Active Medications"},{"<>":"div",class:"incident-report-form__medications",html:[]}]}]}]}]},{"<>":"div",class:"form-section agency-staff-info-section",html:[{"<>":"h3",text:"Agency & Staff Info",class:"section__header agency-staff-info-section__header"},{"<>":"div",class:"form-section agency-section",html:[{"<>":"h5",text:"Agency",class:"section__header agency-section__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-8",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Agency Name"},{"<>":"input",name:"agencyName",type:"text",class:"form-control",placeholder:"",value:t.agencyName||""}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-8",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Agency Address"},{"<>":"input",name:"agencyAddress",type:"text",class:"form-control",placeholder:"",value:t.agencyAddress||""}]}]}]}]},{"<>":"div",class:"form-section staff-section",html:[{"<>":"h5",text:"Staff",class:"section__header staff-section__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-8",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Quality Administrator"},{"<>":"input",name:"qualityAdministrator",type:"text",class:"form-control",placeholder:"",value:t.qualityAdministrator||""}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-8",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Care Manager/Staff with Primary Service Responsibility and Title"},{"<>":"input",name:"careManagerOrStaffWithPrimServRespAndTitle",type:"text",class:"form-control",placeholder:"",value:t.careManagerOrStaffWithPrimServRespAndTitle||""}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Phone"},{"<>":"input",name:"careManagerOrStaffPhone",type:"text",class:"form-control",placeholder:"",value:t.careManagerOrStaffPhone||""}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Email"},{"<>":"input",name:"careManagerOrStaffEmail",type:"text",class:"form-control",placeholder:"",value:t.careManagerOrStaffEmail||""}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"MCO Care Coordinator & Agency (Colbert only, if applicable)"},{"<>":"input",name:"mcoCareCoordinatorAndAgency",type:"text",class:"form-control",placeholder:"",value:t.mcoCareCoordinatorAndAgency||""}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Phone"},{"<>":"input",name:"mcoCareCoordinatorPhone",type:"text",class:"form-control",placeholder:"",value:t.mcoCareCoordinatorPhone||""}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Email"},{"<>":"input",name:"mcoCareCoordinatorEmail",type:"text",class:"form-control",placeholder:"",value:t.mcoCareCoordinatorEmail||""}]}]}]}]}]},{"<>":"div",class:"form-section incident-info-section",html:[{"<>":"h3",text:"Incident Information",class:"section__header incident-info-section__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Date of Incident*"},{"<>":"input",name:"incidentDateTime",type:"text","data-type":"datetime",class:"form-control",placeholder:"mm/dd/yyyy"},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Date incident discovered by agency staff*"},{"<>":"input",name:"incidentDiscoveredDate",type:"text","data-type":"date",class:"form-control",placeholder:"mm/dd/yyyy"},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Did the incident occur when a provider was present or was scheduled to be present?"},{"<>":"div",class:"radio",html:[{"<>":"label",html:[A({value:!0,name:"wasProviderPresentOrScheduled",tooltipPosition:"right",checked:!0===t.wasProviderPresentOrScheduled,onChange:function(t,i){e.changeField(t,i),e.shouldValidate()&&e.isValid()}}),{"<>":"span",text:"Yes"}]}]},{"<>":"div",class:"radio",html:[{"<>":"label",html:[A({value:!1,name:"wasProviderPresentOrScheduled",checked:!1===t.wasProviderPresentOrScheduled,onChange:function(t,i){e.changeField(t,i),e.shouldValidate()&&e.isValid()}}),{"<>":"span",text:"No"}]}]}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Where did the incident take place?"},{"<>":"div",class:"incident-place-list",html:[]}]}]}]}]},{"<>":"div",class:"form-section incident-involved-individuals-section",html:[{"<>":"h3",text:"Individuals involved in the incident",class:"section__header incident-involved-individuals__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-6",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Were other individuals involved in the incident?"},{"<>":"div",class:"radio",html:[{"<>":"label",html:[A({value:!0,name:"wereIndividualsInvolvedInIncident",checked:!0===t.wereIndividualsInvolvedInIncident,onChange:function(t,i){e.changeField(t,i),e.shouldValidate()&&e.isValid()}}),{"<>":"span",text:"Yes"}]}]},{"<>":"div",class:"radio",html:[{"<>":"label",html:[A({value:!1,name:"wereIndividualsInvolvedInIncident",checked:!1===t.wereIndividualsInvolvedInIncident,onChange:function(t,i){e.changeField(t,i),e.shouldValidate()&&e.isValid()}}),{"<>":"span",text:"No"}]}]}]}]},{"<>":"div",class:"col-md-6",html:[{"<>":"a",class:"add-button add-incident-involved-individual-btn pull-right",style:t.wereIndividualsInvolvedInIncident?void 0:"display: none;",onclick:function(){e.onAddIncidentInvolvedIndividual()},html:[{"<>":"img",src:R},{"<>":"span",text:"Add New"}]}]}]}]},{"<>":"div",class:"form-section incident-levels-events-section",html:[{"<>":"h3",text:"Incident levels and events",class:"section__header incident-levels-events-section__header"},{"<>":"div",class:"form-section level-1-incident-types-section","data-incident-level":"1",html:[P(1,this.onIncidentLevelReportingSettings)]},{"<>":"div",class:"form-section level-2-incident-types-section",html:[P(2,this.onIncidentLevelReportingSettings)]},{"<>":"div",class:"form-section level-3-incident-types-section",html:[P(3,this.onIncidentLevelReportingSettings)]},{"<>":"div",class:"form-section other-information-section",html:[{"<>":"h3",text:"Other Information",class:"section__header other-information-section__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Was this incident caused by, or related to, the member's substance use or substance abuse disorder diagnosis?"},{"<>":"div",class:"radio",html:[{"<>":"label",html:[A({value:!0,name:"wasIncidentCausedBySubstance",checked:!0===t.wasIncidentCausedBySubstance,onChange:function(t,i){e.changeField(t,i),e.shouldValidate()&&e.isValid()}}),{"<>":"span",text:"Yes"}]}]},{"<>":"div",class:"radio",html:[{"<>":"label",html:[A({value:!1,name:"wasIncidentCausedBySubstance",checked:!1===t.wasIncidentCausedBySubstance,onChange:function(t,i){e.changeField(t,i),e.shouldValidate()&&e.isValid()}}),{"<>":"span",text:"No"}]}]}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Narrative"},{"<>":"textarea",rows:1,name:"incidentNarrative","data-name":"incidentNarrative","data-autoresizable":!0,style:"min-height: 82px",class:"form-control autoresizable",text:t.incidentNarrative||""}]}]}]},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-12",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Agency’s Response to Incident"},{"<>":"textarea",rows:1,name:"agencyResponseToIncident","data-name":"agencyResponseToIncident","data-autoresizable":!0,style:"min-height: 82px",class:"form-control autoresizable",text:t.agencyResponseToIncident||""}]}]}]}]},{"<>":"div",class:"form-section reporting-section",html:[{"<>":"h3",text:"Reporting",class:"section__header reporting-section__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",text:"Completed by*"},{"<>":"input",name:"reportAuthor",type:"text",class:"form-control",placeholder:"",value:t.reportAuthor||""}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Report Completed Date*"},{"<>":"input",name:"reportCompletedDate",type:"text","data-type":"date",class:"form-control",placeholder:"mm/dd/yyyy"},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]}]},{"<>":"div",class:"col-md-4",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Date Completed*"},{"<>":"input",name:"reportDate",type:"text","data-type":"date",class:"form-control",placeholder:"mm/dd/yyyy"},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]}]}]}]}]}]}},i.connect(function(e){return{event:e.event,profile:{details:e.profile.details},patient:e.patient,directory:e.directory}},function(e){return{actions:{event:{details:t.bindActionCreators(o,e),incident:{report:{form:t.bindActionCreators(s,e),details:t.bindActionCreators(r,e),initialized:t.bindActionCreators(l,e)}}},profile:{details:t.bindActionCreators(c,e)},patient:{diagnosis:{list:t.bindActionCreators(p,e)},medication:{active:{list:t.bindActionCreators(h,e)},inactive:{list:t.bindActionCreators(u,e)}}},directory:{race:{list:t.bindActionCreators(m,e)},state:{list:t.bindActionCreators(v,e)},gender:{list:t.bindActionCreators(f,e)},classMember:{type:{list:t.bindActionCreators(I,e)}},incident:{type:{list:t.bindActionCreators(g,e)},place:{list:t.bindActionCreators(y,e)},level:{reporting:{settings:t.bindActionCreators(x,e)}}}}}}})(T)});