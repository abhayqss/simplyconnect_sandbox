var ServicePlanForm=function(e){function t(){Form.apply(this,arguments),this.needs=[],this.validator=null,this.scoringSection=null;var t=this.props.data,n=this.props.currentUser||{};this.state={data:e.extend({},t,{createdBy:n.fullName}),anchors:[{name:"summary",title:"Summary"}]}}var n=ExchangeApp.info.context+"/resources/images/add-button-rounded.svg",i=["dateCreated","completed","createdBy"],o={employment:"Employment",healthStatus:"Health Status",transportation:"Transportation",support:"Caregiver Resource / Support",housingOnly:"Housing",housing:"Housing / Home Security & Safety",nutritionSecurity:"Nutrition Security",behavioral:"Behavioral / Spiritual Health",socialWellness:"Social wellness",mentalWellness:"Mental wellness",physicalWellness:"Physical wellness",task:"Relevant Activation or Education Task",other:"Other / Non-Specific",legal:"Legal",finances:"Finances",medicalOtherSupply:"Medical / Other Supply",medicationMgmtAssistance:"Medication Management and Assistance",homeHealth:"Home Health"};return t.prototype=Object.create(Form.prototype),t.prototype.constructor=t,t.prototype.getDefaultProps=function(){return{data:{},isReadonly:!1,currentUser:null,onShowDatePicker:function(){},onHideDatePicker:function(){},onNeedSectionAdded:function(){},onNeedSectionRemoved:function(){},onGoalSectionAdded:function(){}}},t.prototype.componentDidMount=function(){Form.prototype.componentDidMount.apply(this),this.$element.find('input[type="checkbox"]').styler();var n=this.props.isNew,i=this.props.isReadonly;if(this.$element.find("input").each(function(){var t=e(this),o=t.attr("name");t.attr("type");n||"dateCreated"!==o||t.attr("readonly","true"),i&&"completed"===o&&t.attr("disabled","true").trigger("refresh"),i&&"dateCompleted"===o&&t.attr("readonly","true")}),i)this.hasScoringSection()&&this.removeScoringSection(),this.createScoringSection(!0);else{var o=this;this.$element.find('input[data-type="date"]').datetimepicker({format:"MM/DD/YYYY HH:mm A ["+(new Date).getTimezoneAbbr()+"]",keepOpen:!0}).on("dp.change",function(e){o.onChange(e)}).on("dp.show",function(){o.props.onShowDatePicker()}).on("dp.hide",function(){o.props.onHideDatePicker()}),this.$element.find(".info-tip").popover(),this.anchorLinkPanel=new AnchorLinkPanel({container:this.$element.find(".anchor-link-section"),items:this.state.anchors}),this.anchorLinkPanel.mount(),this.addOnChangeHandler(function(e){o.onChange(e)});var a=(this.props.data||{}).needs;a&&e.each(a,function(e,n){var i=new t.NeedSection({container:o.$element.find(".need-section-list"),index:e,data:n,onRemove:function(e){o.onRemoveNeedSection(e)},onChangeType:function(e,t){o.onChangeNeedType(e,t)},onGoalSectionAdded:function(){o.props.onGoalSectionAdded(i.getIndex(),i.goals.length-1)}});i.mount(),o.needs.push(i),o.addAnchorLink("need-"+e,n.type||"Health Status")})}n&&this.$element.find('input[name="dateCreated"]').data("DateTimePicker").date(new Date)},t.prototype.componentDidUpdate=function(t,n){var i=this.state.anchors;if(i!==n.anchors&&this.anchorLinkPanel.update({items:i}),this.state.data!==n.data){var o=this.state.data;this.$element.find('input[name="createdBy"]').val(o.createdBy)}var a=this.props.isNew,r=this.props.currentUser;a&&r&&r!==t.currentUser&&this.setState({data:e.extend({},this.state.data,{createdBy:r.fullName})})},t.prototype.onChange=function(t){var n=e(t.target),o=n.attr("name");if(~i.indexOf(o)){var a="";switch(n.attr("data-type")||n.attr("type")){case"date":a=t.date?t.date.toDate().getTime():"";break;case"checkbox":a=n.prop("checked");break;default:a=n.val()}var r=e.extend({},this.state.data);r[o]=a,this.setState({data:r})}},t.prototype.onChangeNeedType=function(e,t){this.updateAnchorLink("need-"+t,e)},t.prototype.onAddNeedSection=function(){this.addNeedSection(),this.props.onNeedSectionAdded(this.needs.length-1)},t.prototype.onRemoveNeedSection=function(t){this.needs=e.map(this.needs,function(e,n){if(n!==t)return e}),e.each(this.needs,function(e,t){t.update({index:e})}),this.removeAnchorLink("need-"+t),this.props.onNeedSectionRemoved()},t.prototype.addOnChangeHandler=function(e){this.$element.on("change",e)},t.prototype.addValidation=function(){function t(e){return"The field must have a maximum length of "+e+" symbols."}var n={dateCreated:{required:!0}},i={dateCreated:{required:getErrorMessage("field.empty")}};e.each(this.needs,function(o,a){n["need."+o+".type"]={required:!0},n["need."+o+".priority"]={required:!0},n["need."+o+".needOpportunity"]={required:!0,maxlength:256},n["need."+o+".activationOrEducationTask"]={required:!0,maxlength:256},n["need."+o+".proficiencyGraduationCriteria"]={maxlength:5e3},n["need."+o+".targetCompletionDate"]={required:!0},i["need."+o+".type"]={required:getErrorMessage("field.empty")},i["need."+o+".priority"]={required:getErrorMessage("field.empty")},i["need."+o+".needOpportunity"]={required:getErrorMessage("field.empty"),maxlength:t(256)},i["need."+o+".activationOrEducationTask"]={required:getErrorMessage("field.empty"),maxlength:t(256)},i["need."+o+".proficiencyGraduationCriteria"]={maxlength:t(5e3)},i["need."+o+".targetCompletionDate"]={required:getErrorMessage("field.empty")},e.each(a.goals,function(e){n["need."+o+".goal."+e+".goal"]={required:!0,maxlength:256},n["need."+o+".goal."+e+".barriers"]={maxlength:5e3},n["need."+o+".goal."+e+".interventionAction"]={maxlength:5e3},n["need."+o+".goal."+e+".resourceName"]={maxlength:256},n["need."+o+".goal."+e+".targetCompletionDate"]={required:!0},i["need."+o+".goal."+e+".goal"]={required:getErrorMessage("field.empty"),maxlength:t(256)},i["need."+o+".goal."+e+".barriers"]={maxlength:t(5e3)},i["need."+o+".goal."+e+".interventionAction"]={maxlength:t(5e3)},i["need."+o+".goal."+e+".resourceName"]={maxlength:t(256)},i["need."+o+".goal."+e+".targetCompletionDate"]={required:getErrorMessage("field.empty")}})}),this.validator=this.$element.validate(new ExchangeApp.utils.wgt.Validation({position:"top",rules:n,messages:i}))},t.prototype.updateValidation=function(){this.validator&&this.validator.destroy(),this.addValidation()},t.prototype.isValid=function(){return this.$element.valid()},t.prototype.scrollToStart=function(){e(this.props.container).scrollTo(this.$element.find(".start-anchor"),500)},t.prototype.getNeedSectionCount=function(){return this.needs.length},t.prototype.getNeedSection=function(e){return this.needs[e]},t.prototype.getInvalidFields=function(){return this.$element.find("input, select, textarea").filter(".error").parent(".form-group")},t.prototype.addAnchorLink=function(t,n){var i=[].concat(this.state.anchors);i.push({name:t,title:n});var o=e.map(i,function(e){if(e.title.includes(n))return e});o.length>1&&e.each(o,function(e,t){t.title=n+" #"+(e+1)}),this.setState({anchors:i})},t.prototype.updateAnchorLink=function(t,n){var i=[].concat(this.state.anchors),o="";e.each(i,function(e,i){i.name===t&&(o=i.title,i.title=n)}),o=o.replace(/\s#\d*/,"");var a=e.map(i,function(e){if(e.title.includes(o))return e}),r=a.length;1===r&&(a[0].title=o),r>1&&e.each(a,function(e,t){t.title=o+" #"+(e+1)}),(a=e.map(i,function(e){if(e.title.includes(n))return e})).length>1&&e.each(a,function(e,t){t.title=n+" #"+(e+1)}),this.setState({anchors:i})},t.prototype.removeAnchorLink=function(t){var n=null,i=e.map(this.state.anchors,function(e){if(e.name!==t)return e;n=e}),o=e.map(i,function(e){if(e.name.includes("need"))return e});e.each(o,function(e,t){t.name="need-"+e});var a=n.title.replace(/\s#\d*/,""),r=e.map(o,function(e){if(e.title.includes(a))return e}),s=r.length;1===s&&(r[0].title=a),s>1&&e.each(r,function(e,t){t.title=a+" #"+(e+1)}),this.setState({anchors:i})},t.prototype.addNeedSection=function(){var e=this,n=this.needs.length,i=this.props.isReadonly,o=new t.NeedSection({container:e.$element.find(".need-section-list"),index:n,isReadonly:i,onRemove:function(t){e.onRemoveNeedSection(t)},onChangeType:function(t,n){e.onChangeNeedType(t,n)},onGoalSectionAdded:function(){e.props.onGoalSectionAdded(o.getIndex(),o.goals.length-1)}});o.mount(),e.needs.push(o),this.addAnchorLink("need-"+n,"Health Status")},t.prototype.getData=function(){if(this.props.isReadonly)return this.state.data;var t=e.map(this.needs,function(e){var t=e.getData();if(!isEmpty(t))return t});return e.extend({},this.state.data,{needs:t||[]})},t.prototype.getScoringSectionData=function(){var e={HIGH:1,MEDIUM:2,LOW:3},t=_.groupBy(this.getData().needs,"type"),n=this,i=_.map(t,function(t,i){var a=_.findKey(o,function(e){return e===i});return t&&(t=_.sortBy(t,function(t){return e[t.priority.toUpperCase()]}),_.each(t,function(e){var t=e.goals;t&&(e.goals=_.sortBy(t,function(e){return e.targetCompletionDate}))})),{title:i,name:a,needs:t,score:n.state.data[a+"Score"]||0}});return _.sortBy(i,"title")},t.prototype.hasScoringSection=function(){return null!==this.scoringSection},t.prototype.createScoringSection=function(n){var i=this;this.scoringSection=new t.ScoringSection({container:this.$element,isShowed:n,isDisabled:this.props.isReadonly,data:this.getScoringSectionData(),onChangeDomainScore:function(t,n){var o=i.state.data,a=t.name+"Score";if(o[a]!==n){var r={};r[a]=n,i.setState({data:e.extend({},o,r)})}}}),this.scoringSection.mount()},t.prototype.showScoringSection=function(e){(e=e||!0)&&(this.$element.find(".anchor-link-section").hide(),this.$element.find(".summary-section").hide(),this.$element.find(".form-section-list").hide()),this.scoringSection&&this.scoringSection.show()},t.prototype.hideScoringSection=function(e){(e=e||!0)&&(this.$element.find(".anchor-link-section").show(),this.$element.find(".summary-section").show(),this.$element.find(".form-section-list").show()),this.scoringSection.hide()},t.prototype.removeScoringSection=function(){this.scoringSection.unmount()},t.prototype.isChanged=function(){var e=this;return _.any(this.state.data,function(t,n){return"needs"===n?t?t.length!==e.needs.length||_.any(e.needs,function(e){return e.isChanged()}):e.needs.length>0:t!==e.props.data[n]})},t.prototype.render=function(){var e=this,t=this.props.isNew,i=this.props.isReadonly,o=this.state.data;return{"<>":"form",class:"service-plan-form",html:[i?void 0:{"<>":"a",class:"anchor start-anchor",name:"start"},i?void 0:{"<>":"div",class:"form-section anchor-link-section"},i?void 0:{"<>":"a",class:"anchor summary-anchor",name:"summary"},{"<>":"div",class:"form-section summary-section",html:[{"<>":"h3",text:"Summary",class:"section__header summary-section__header"},{"<>":"div",class:"row",html:[{"<>":"div",class:"col-md-6",html:[{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Date Created*"},{"<>":"input",name:"dateCreated",type:"text","data-type":"date",class:"form-control",placeholder:"mm/dd/yyyy hh:mm",value:new Date(t?new Date:o.dateCreated||new Date).format("mm/dd/yyyy HH:MM TT")+" "+(new Date).getTimezoneAbbr()},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]},{"<>":"div",class:"checkbox",html:[{"<>":"label",html:[function(){var e={"<>":"input",type:"checkbox",name:"completed"};return o.completed&&(e.checked=!0),e}(),{"<>":"span",text:"Mark service plan as completed"}]}]}]},{"<>":"div",class:"col-md-6",html:[{"<>":"div",class:"form-group",html:[{"<>":"label",for:"createdDate",text:"Created By*"},{"<>":"input",id:"createdBy",name:"createdBy",type:"text",disabled:!0,class:"form-control",placeholder:"Created By",value:o.createdBy}]},i&&o.completed?{"<>":"div",class:"form-group date",html:[{"<>":"label",text:"Date Completed"},{"<>":"input",name:"dateCompleted",type:"text","data-type":"date",class:"form-control",placeholder:"mm/dd/yyyy hh:mm",value:o.dateCompleted&&new Date(o.dateCompleted).format("mm/dd/yyyy")},{"<>":"span",class:"glyphicon glyphicon-calendar","aria-hidden":"true"}]}:void 0]}]}]},i?void 0:{"<>":"div",class:"form-section-list need-section-list",html:[{"<>":"div",class:"row form-section-list__header",html:[{"<>":"div",class:"col-md-6",html:[{"<>":"h3",text:"Needs / Opportunities"}]},{"<>":"div",class:"col-md-6",html:[{"<>":"a",class:"add-button pull-right",html:[{"<>":"img",src:n},{"<>":"span",text:"Add a Need / Opportunity"}],onclick:function(){e.onAddNeedSection()}}]}]}]}]}},t}($);